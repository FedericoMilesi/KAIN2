#include "CORE.H"
#include "VRAM.H"
#include "DRAW.H"
#include "GAMELOOP.H"
#include "PSX/DRAWS.H"
#include "PSX/MAIN.H"
#include "LOCAL/LOCALSTR.H"
#include "FONT.H"
#include "MENU/MENU.H"

short pause_redraw_flag; // offset 0x800d2fd4
void* pause_redraw_prim; // offset 0x800d2fd8
short RENDER_currentStreamUnitID;
SVECTOR shadow_vertices[11];

// autogenerated function stub: 
// void /*$ra*/ fDRAW_SPLIT_INTPL_XYZ(struct _SVector *newVertex /*$a0*/, struct _SVector *pvb /*$a1*/, struct _SVector *pvc /*$a2*/)
void fDRAW_SPLIT_INTPL_XYZ(struct _SVector *newVertex, struct _SVector *pvb, struct _SVector *pvc)
{ // line 61, offset 0x8002a5b0
	/* begin block 1 */
		// Start line: 122
	/* end block 1 */
	// End Line: 123

	/* begin block 2 */
		// Start line: 123
	/* end block 2 */
	// End Line: 124
	UNIMPLEMENTED();
}


// autogenerated function stub: 
// void /*$ra*/ DRAW_InitShadow()
void DRAW_InitShadow()
{
	int n; // $s3
	int inc; // $s4
	int deg; // $s2
	
	deg = 0;
	inc = 1677721;
	n = 0;

	//s1 = shadow_vertices
	
	//if(;
	//int v0 = ;
	int x = rcos(deg < 0 ? (deg + 0xFFF) >> 12 : deg >> 12); x < 0 ? (x + 0x1F) >> 5 : (x >> 5);
	shadow_vertices[n].vx = x;
	UNIMPLEMENTED();
#if 0


		loc_8002A9C8 :
		sra     $s0, $a0, 12
		jal     sub_80079370
		move    $a0, $s0
		bgez    $v0, loc_8002A9E0
		nop
		addiu   $v0, 0x1F

		loc_8002A9E0:
	sra     $v0, 5
		sh      $v0, 0($s1)
		jal     sub_80079340
		move    $a0, $s0
		bgez    $v0, loc_8002A9FC
		nop
		addiu   $v0, 0x1F

		loc_8002A9FC:
	addu    $s2, $s4
		sra     $v0, 5
		sh      $v0, 2($s1)
		sh      $zero, 4($s1)
		addiu   $s3, 1
		slti    $v0, $s3, 0xA
		bnez    $v0, loc_8002A9BC
		addiu   $s1, 8
		lhu     $v0, -0x4E74($gp)
		lhu     $v1, -0x4E72($gp)
		lhu     $a0, -0x4E70($gp)
		lw      $ra, 0x10 + var_s14($sp)
		lw      $s4, 0x10 + var_s10($sp)
		lw      $s3, 0x10 + var_sC($sp)
		lw      $s2, 0x10 + var_s8($sp)
		lw      $s1, 0x10 + var_s4($sp)
		lw      $s0, 0x10 + var_s0($sp)
		sh      $v0, -0x4E24($gp)
		sh      $v1, -0x4E22($gp)
		sh      $a0, -0x4E20($gp)
		jr      $ra
		addiu   $sp, 0x28
#endif

}


// autogenerated function stub: 
// unsigned long * /*$ra*/ DRAW_DrawShadow(struct _PrimPool *primPool /*$t3*/, struct _Model *model /*$a1*/, unsigned long **ot /*$a2*/, long fadeValue /*$a3*/)
unsigned long * DRAW_DrawShadow(struct _PrimPool *primPool, struct _Model *model, unsigned long **ot, long fadeValue)
{ // line 478, offset 0x8002a6f4
	/* begin block 1 */
		// Start line: 479
		// Start offset: 0x8002A6F4
		// Variables:
			struct POLY_G3_SEMITRANS *sg3; // $a1
			SVECTOR zero_vertex; // stack offset -24
			long clip; // stack offset -8
			long n; // $t0
			long p; // stack offset -16
			long otz; // stack offset -4
			unsigned long color; // stack offset -12
	/* end block 1 */
	// End offset: 0x8002A8AC
	// End Line: 538

	/* begin block 2 */
		// Start line: 983
	/* end block 2 */
	// End Line: 984
			UNIMPLEMENTED();
	return null;
}

void DRAW_FlatQuad(CVECTOR *color, short x0, short y0, short x1, int y1, int x2, int y2, int x3, int y3, struct _PrimPool *primPool, unsigned long **ot)
{
	unsigned long *prim;

	prim = primPool->nextPrim;

	if ((char*)prim < (char*)primPool->lastPrim - sizeof(POLY_F4) * 2)
	{
		setXY4((POLY_F4*)prim, x0, y0, x1, y1, x2, y2, x3, y3);
		setRGB0((POLY_F4*)prim, color->r, color->g, color->b);
		setPolyF4((POLY_F4*)prim);
		addPrim(ot[0], prim);

		primPool->nextPrim = (unsigned long*)(char*)primPool->nextPrim + sizeof(POLY_F4);
		primPool->numPrims++;

	}
}

void DRAW_TranslucentQuad(short x0, short y0, short x1, short y1, int x2, int y2, int x3, int y3, int r, int g, int b, int abr, struct _PrimPool *primPool, unsigned long **ot)
{
	unsigned long *prim;

	prim = primPool->nextPrim;
	
	if (prim < primPool->lastPrim - 12)
	{
		setDrawTPage((POLY_F4_SEMITRANS*)prim, 0, 1, 8);
		setAbr((POLY_F4_SEMITRANS*)prim, abr);
		setPolyFT4_ST(prim);
		setRGB0((POLY_F4_SEMITRANS*)prim, r, g, b);
		setXY4((POLY_F4_SEMITRANS*)prim, x0, y0, x1, y1, x2, y2, x3, y3);
		addPrim(ot, prim);
		primPool->nextPrim += sizeof(POLY_F4_SEMITRANS) / sizeof(unsigned long);
		primPool->numPrims++;
	}
}

void DRAW_DrawButton(struct _ButtonTexture *button, short x, short y, unsigned long **ot)
{
	struct _PrimPool *primPool;
	unsigned long *prim;
	short w;
	short h;
	short offsetx;
	short offsety;

	primPool = gameTrackerX.primPool;

	prim = primPool->nextPrim;
	if (primPool->lastPrim - 12 >= primPool->nextPrim)
	{
		w = button->textureW << button->xshift;
		h = button->textureH;

		offsetx = (button->vramBlock->x & 0x3F) << button->xshift;
		offsety = button->vramBlock->y;

		SetPolyFT4((POLY_FT4*)prim);

		setShadeTex(((POLY_FT4*)prim), 1);

		((POLY_FT4*)prim)->tpage = button->tpage;

		((POLY_FT4*)prim)->v0 = offsety;
		((POLY_FT4*)prim)->v1 = offsety;

		((POLY_FT4*)prim)->x0 = x;
		((POLY_FT4*)prim)->y0 = y;

		((POLY_FT4*)prim)->u0 = offsetx;

		((POLY_FT4*)prim)->x1 = (x + w) - 1;
		((POLY_FT4*)prim)->y1 = y;

		((POLY_FT4*)prim)->x1 = (x + w) - 1;
		((POLY_FT4*)prim)->y1 = y;

		((POLY_FT4*)prim)->u1 = (offsetx + w) - 1;

		((POLY_FT4*)prim)->x2 = x;
		((POLY_FT4*)prim)->y2 = (y + h) - 1;

		((POLY_FT4*)prim)->u2 = offsetx;
		((POLY_FT4*)prim)->v2 = (offsety + h) - 1;

		((POLY_FT4*)prim)->x3 = (x + w) - 1;
		((POLY_FT4*)prim)->y3 = (y + h) - 1;

		((POLY_FT4*)prim)->u3 = (offsetx + w) - 1;
		((POLY_FT4*)prim)->v3 = (offsety + h) - 1;

		((POLY_FT4*)prim)->clut = button->clut;
		
		addPrim(ot, prim);

		primPool->nextPrim += sizeof(POLY_FT4) / sizeof(unsigned long);
		primPool->numPrims++;
	}
}

void DRAW_LoadButton(long *addr, _ButtonTexture *button)
{ 
	PSX_RECT vramRect;
	long *paletteAddr;
	short paletteW;
	short paletteH;

	paletteAddr = NULL;
	paletteW = 0;
	button->xshift = 0;
	paletteH = 0;

	if (((int*)addr)[1] == 8)
	{
		button->xshift = 2;
		paletteW = 16;
		paletteH = 1;
		paletteAddr = &addr[5];
		addr = &addr[13];
	}
	
	button->textureW = ((unsigned short*)addr)[4];
	button->textureH = ((unsigned short*)addr)[5];

	if (paletteW < button->textureW)
	{
		vramRect.w = button->textureW;
	}
	else
	{
		vramRect.w = paletteW;	
	}

	vramRect.h = button->textureH + paletteH;
	button->vramBlock = VRAM_CheckVramSlot(&vramRect.x, &vramRect.y, vramRect.w, vramRect.h, 4, 0);
	button->tpage = getTPage(2 - button->xshift, 0, vramRect.x, vramRect.y);
	button->vramBlock->udata.button = button;
	
	vramRect.w = button->textureW;
	vramRect.h = button->textureH;
	
	LoadImage(&vramRect, (unsigned long*)(addr + 3));
	
	if (paletteAddr != NULL)
	{
		vramRect.w = paletteW;
		vramRect.h = paletteH;
		vramRect.y += button->textureH;
		
		LoadImage(&vramRect, (unsigned long*)paletteAddr);

		button->clut = getClut(vramRect.x, vramRect.y);
	}

	DrawSync(0);
}


// autogenerated function stub: 
// void /*$ra*/ DRAW_FreeButton(struct _ButtonTexture *button /*$a0*/)
void DRAW_FreeButton(struct _ButtonTexture *button)
{ // line 3636, offset 0x8002ad48
	/* begin block 1 */
		// Start line: 7272
	/* end block 1 */
	// End Line: 7273
	UNIMPLEMENTED();
}


// autogenerated function stub: 
// void /*$ra*/ DRAW_RingLine(struct _PrimPool *primPool /*$t0*/, unsigned long **ot /*$t1*/, long color /*$a2*/)
void DRAW_RingLine(struct _PrimPool *primPool, unsigned long **ot, long color)
{ // line 3649, offset 0x8002ad6c
	/* begin block 1 */
		// Start line: 3650
		// Start offset: 0x8002AD6C
		// Variables:
			unsigned long *prim; // $a3
			long flag; // stack offset -24
			long clip; // stack offset -20
			long z0; // stack offset -16
			long z1; // stack offset -12
			long z2; // stack offset -8
			long otz; // $a0
			long p; // stack offset -4
	/* end block 1 */
	// End offset: 0x8002AE94
	// End Line: 3712

	/* begin block 2 */
		// Start line: 4652
	/* end block 2 */
	// End Line: 4653
			UNIMPLEMENTED();
}


// autogenerated function stub: 
// void /*$ra*/ DRAW_RingPoint(struct _PrimPool *primPool /*$a0*/, unsigned long **ot /*$a1*/, long color /*$s2*/, struct _SVector *vel /*$s1*/, struct _SVector *acc /*stack 16*/)
void DRAW_RingPoint(struct _PrimPool *primPool, unsigned long **ot, long color, struct _SVector *vel, struct _SVector *acc)
{ // line 3714, offset 0x8002ae9c
	/* begin block 1 */
		// Start line: 3715
		// Start offset: 0x8002AE9C
		// Variables:
			struct _SVector outpoint; // stack offset -24
	/* end block 1 */
	// End offset: 0x8002AF94
	// End Line: 3726

	/* begin block 2 */
		// Start line: 4789
	/* end block 2 */
	// End Line: 4790
			UNIMPLEMENTED();
}


// autogenerated function stub: 
// unsigned long * /*$ra*/ DRAW_DrawRingPoints(struct _Model *model /*$a0*/, struct _VertexPool *vertexPool /*$a1*/, MATRIX *pcTransform /*$s0*/, struct _PrimPool *primPool /*$s5*/, unsigned long **ot /*stack 16*/, long color /*stack 20*/, int ring_type /*stack 24*/)
unsigned long * DRAW_DrawRingPoints(struct _Model *model, struct _VertexPool *vertexPool, MATRIX *pcTransform, struct _PrimPool *primPool, unsigned long **ot, long color, int ring_type)
{ // line 3736, offset 0x8002afac
	/* begin block 1 */
		// Start line: 3737
		// Start offset: 0x8002AFAC
		// Variables:
			struct _MFace *mface; // $s1
			struct _MFace *endMFace; // $s4
			struct _PVertex *pvertexList; // $s3
			struct _SVector (*pvertex[3]); // stack offset -96
			struct _SVector newVertex[3]; // stack offset -80
			long outcode; // $a0
			int first; // $v1
			int second; // $a0
			struct _SVector vel; // stack offset -56
			struct _SVector acc; // stack offset -48
	/* end block 1 */
	// End offset: 0x8002B294
	// End Line: 3837

	/* begin block 2 */
		// Start line: 4841
	/* end block 2 */
	// End Line: 4842
			UNIMPLEMENTED();
	return null;
}


// autogenerated function stub: 
// void /*$ra*/ DRAW_GlowQuad(struct _PrimPool *primPool /*$t7*/, unsigned long **ot /*$t9*/, long otz /*$a2*/, long color /*stack 12*/, struct _Vector *v0 /*stack 16*/, struct _Vector *v1 /*stack 20*/, struct _Vector *v2 /*stack 24*/, struct _Vector *v3 /*stack 28*/)
void DRAW_GlowQuad(struct _PrimPool *primPool, unsigned long **ot, long otz, long color, struct _Vector *v0, struct _Vector *v1, struct _Vector *v2, struct _Vector *v3)
{ // line 3879, offset 0x8002b2c8
	/* begin block 1 */
		// Start line: 3880
		// Start offset: 0x8002B2C8
		// Variables:
			unsigned long *prim; // $t1
			struct _POLY_NG4 *sg4; // $t0
	/* end block 1 */
	// End offset: 0x8002B524
	// End Line: 3922

	/* begin block 2 */
		// Start line: 7758
	/* end block 2 */
	// End Line: 7759
			UNIMPLEMENTED();
}


// autogenerated function stub: 
// void /*$ra*/ DRAW_CreateAGlowingCircle(struct _Vector *f1 /*$fp*/, long z /*$a1*/, struct _PrimPool *primPool /*stack 8*/, unsigned long **ot /*stack 12*/, long otz /*stack 16*/, long color /*stack 20*/, long w /*stack 24*/, long h /*stack 28*/, long angle /*stack 32*/)
void DRAW_CreateAGlowingCircle(struct _Vector *f1, long z, struct _PrimPool *primPool, unsigned long **ot, long otz, long color, long w, long h, long angle)
{ // line 3935, offset 0x8002b52c
	UNIMPLEMENTED();
}


// autogenerated function stub: 
// unsigned long * /*$ra*/ DRAW_DrawGlowPoints2(struct _Instance *instance /*$s0*/, long seg1 /*$a1*/, long seg2 /*$s1*/, struct _PrimPool *primPool /*$s3*/, unsigned long **ot /*stack 16*/, long color /*stack 20*/, long height /*stack 24*/)
unsigned long * DRAW_DrawGlowPoints2(struct _Instance *instance, long seg1, long seg2, struct _PrimPool *primPool, unsigned long **ot, long color, long height)
{ // line 4038, offset 0x8002bad8
	/* begin block 1 */
		// Start line: 4039
		// Start offset: 0x8002BAD8
		// Variables:
			_Position glowPoints1; // stack offset -88
			_Position glowPoints2; // stack offset -80
			struct _Vector f1; // stack offset -72
			struct _Vector f2; // stack offset -56
			struct _Vector f3; // stack offset -40
			long otz; // $s2
			long otz2; // $s0
			long z; // $a1
			long length; // $s1
			long angle; // $v1
	/* end block 1 */
	// End offset: 0x8002BC24
	// End Line: 4079

	/* begin block 2 */
		// Start line: 5534
	/* end block 2 */
	// End Line: 5535
			UNIMPLEMENTED();
	return null;
}


// autogenerated function stub: 
// unsigned long * /*$ra*/ DRAW_DrawGlowPoint(struct _Instance *instance /*$a0*/, long seg1 /*$a1*/, struct _PrimPool *primPool /*$s3*/, unsigned long **ot /*$s4*/, long color /*stack 16*/, int width /*stack 20*/, int height /*stack 24*/)
unsigned long * DRAW_DrawGlowPoint(struct _Instance *instance, long seg1, struct _PrimPool *primPool, unsigned long **ot, long color, int width, int height)
{ // line 4089, offset 0x8002bc44
	/* begin block 1 */
		// Start line: 4090
		// Start offset: 0x8002BC44
		// Variables:
			_Position glowPoints1; // stack offset -48
			struct _Vector f1; // stack offset -40
			long otz; // $t0
			long z; // $a1
			long angle; // $s2
	/* end block 1 */
	// End offset: 0x8002BCF0
	// End Line: 4115

	/* begin block 2 */
		// Start line: 5682
	/* end block 2 */
	// End Line: 5683
			UNIMPLEMENTED();
	return null;
}


// autogenerated function stub: 
// int /*$ra*/ DRAW_DisplayTFace_zclipped_C(SVECTOR*vertex0 /*stack 0*/, SVECTOR*vertex1 /*stack 4*/, SVECTOR*vertex2 /*stack 8*/, struct UVTYPE *uv0 /*stack 12*/, struct UVTYPE *uv1 /*stack 16*/, struct UVTYPE *uv2 /*stack 20*/, long color0 /*stack 24*/, long color1 /*stack 28*/, long color2 /*stack 32*/, struct _PrimPool *primPool /*stack 36*/, unsigned long **ot /*stack 40*/, int ndiv /*stack 44*/)
int DRAW_DisplayTFace_zclipped_C(SVECTOR*vertex0, SVECTOR*vertex1, SVECTOR*vertex2, struct UVTYPE *uv0, struct UVTYPE *uv1, struct UVTYPE *uv2, long color0, long color1, long color2, struct _PrimPool *primPool, unsigned long **ot, int ndiv)
{ // line 4192, offset 0x8002bd14
	/* begin block 1 */
		// Start line: 4193
		// Start offset: 0x8002BD14
		// Variables:
			struct SP_SUBDIV_STRUCT *sp; // $t2
			int maxz; // $s3
			int point; // $a1
			int n; // $t7
			//struct POLY_GT4 *prim; // $t9
			long *ptr; // $t8
			long clip; // $s0

		/* begin block 1.1 */
			// Start line: 4233
			// Start offset: 0x8002BE84
			// Variables:
				int next_point_in_vv; // $v1
				int current_point_in_vv; // $t1
				int next; // $t6

			/* begin block 1.1.1 */
				// Start line: 4246
				// Start offset: 0x8002BEC4
				// Variables:
					long clip_tmp; // $a0
					long zval; // stack offset -48
					SVECTOR*tmpptr; // $v0
			/* end block 1.1.1 */
			// End offset: 0x8002BFA8
			// End Line: 4272

			/* begin block 1.1.2 */
				// Start line: 4276
				// Start offset: 0x8002BFB0
				// Variables:
					long zn; // $v1
					long znext; // $a0
					long interp1; // $t1
					long interp2; // $a2
					//long clip_tmp; // $v1

				/* begin block 1.1.2.1 */
					// Start line: 4280
					// Start offset: 0x8002BFB0
					// Variables:
						long x; // $v1
						long y; // $v1
				/* end block 1.1.2.1 */
				// End offset: 0x8002C094
				// End Line: 4291
			/* end block 1.1.2 */
			// End offset: 0x8002C1CC
			// End Line: 4305
		/* end block 1.1 */
		// End offset: 0x8002C1CC
		// End Line: 4306

		/* begin block 1.2 */
			// Start line: 4327
			// Start offset: 0x8002C20C
			// Variables:
				//int next; // $t0
				int flag; // $t3
		/* end block 1.2 */
		// End offset: 0x8002C3E4
		// End Line: 4358

		/* begin block 1.3 */
			// Start line: 4361
			// Start offset: 0x8002C3E4
			// Variables:
				long opz; // stack offset -44
		/* end block 1.3 */
		// End offset: 0x8002C438
		// End Line: 4376

		/* begin block 1.4 */
			// Start line: 4387
			// Start offset: 0x8002C498
			// Variables:
				long temp1; // $a3
				long temp2; // $t0
				long temp3; // $t1
		/* end block 1.4 */
		// End offset: 0x8002C4A0
		// End Line: 4408
	/* end block 1 */
	// End offset: 0x8002C524
	// End Line: 4409

	/* begin block 2 */
		// Start line: 8384
	/* end block 2 */
	// End Line: 8385
				UNIMPLEMENTED();
	return 0;
}


// autogenerated function stub: 
// long * /*$ra*/ DRAW_Zclip_subdiv(struct POLY_GT3 *texture /*$t0*/, unsigned long **ot /*stack 4*/, int ndiv /*stack 8*/)
long * DRAW_Zclip_subdiv(POLY_GT3 *texture, unsigned long **ot, int ndiv)
{ // line 4420, offset 0x8002c554
	/* begin block 1 */
		// Start line: 4421
		// Start offset: 0x8002C554
		// Variables:
			struct SP_SUBDIV_STRUCT *sp; // $s7
			struct _PrimPool *primPool; // $fp
			int clip; // $s0
	/* end block 1 */
	// End offset: 0x8002CA28
	// End Line: 4556

	/* begin block 2 */
		// Start line: 6517
	/* end block 2 */
	// End Line: 6518
			UNIMPLEMENTED();
	return null;
}

void DRAW_LoadingMessage()
{
	unsigned long **drawot;

#if !defined(PSXPC_VERSION)
	while (CheckVolatile(gameTrackerX.drawTimerReturn) != 0)
	{

	}

	while (CheckVolatile(gameTrackerX.reqDisp) != 0)
	{

	}
#endif

	DrawSyncCallback(NULL);
	VSyncCallback(NULL);

	PutDrawEnv(&draw[gameTrackerX.drawPage ^ 1]);
	
	FONT_FontPrintCentered(localstr_get(LOCALSTR_Hint52), 150);
	
	DisplayHintBox(FONT_GetStringWidth(localstr_get(LOCALSTR_Hint52)), 150);
	
	FONT_Flush();

	drawot = gameTrackerX.drawOT;

#if defined(PSX_VERSION)
#if defined(USE_32_BIT_ADDR)
	DrawOTag((unsigned long*)drawot + 3071 * 2);
#else
	DrawOTag((unsigned long*)drawot + 3071);
#endif
#endif

	DrawSync(0);
	ClearOTagR((unsigned long*)drawot, 3072);
	PutDrawEnv(&draw[gameTrackerX.drawPage]);
	VSyncCallback(VblTick);
	DrawSyncCallback(DrawCallback);
}




