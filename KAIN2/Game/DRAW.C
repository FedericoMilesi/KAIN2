#include "CORE.H"
#include "VRAM.H"
#include "DRAW.H"
#include "GAMELOOP.H"
#include "PSX/DRAWS.H"
#include "PSX/MAIN.H"
#include "LOCAL/LOCALSTR.H"
#include "FONT.H"
#include "MENU/MENU.H"
#include "PIPE3D.H"

short pause_redraw_flag; // offset 0x800d2fd4
void* pause_redraw_prim; // offset 0x800d2fd8
short RENDER_currentStreamUnitID;
SVECTOR shadow_vertices[11];

// autogenerated function stub: 
// void /*$ra*/ fDRAW_SPLIT_INTPL_XYZ(struct _SVector *newVertex /*$a0*/, struct _SVector *pvb /*$a1*/, struct _SVector *pvc /*$a2*/)
void fDRAW_SPLIT_INTPL_XYZ(struct _SVector *newVertex, struct _SVector *pvb, struct _SVector *pvc)
{ // line 61, offset 0x8002a5b0
	/* begin block 1 */
		// Start line: 122
	/* end block 1 */
	// End Line: 123

	/* begin block 2 */
		// Start line: 123
	/* end block 2 */
	// End Line: 124
	UNIMPLEMENTED();
}


// autogenerated function stub: 
// void /*$ra*/ DRAW_InitShadow()
void DRAW_InitShadow()
{
	int n; // $s3
	int inc; // $s4
	int deg; // $s2
	
	deg = 0;
	inc = 1677721;
	n = 0;

	//s1 = shadow_vertices
	
	//if(;
	//int v0 = ;
	int x = rcos(deg < 0 ? (deg + 0xFFF) >> 12 : deg >> 12); x < 0 ? (x + 0x1F) >> 5 : (x >> 5);
	shadow_vertices[n].vx = x;
	UNIMPLEMENTED();
#if 0


		loc_8002A9C8 :
		sra     $s0, $a0, 12
		jal     sub_80079370
		move    $a0, $s0
		bgez    $v0, loc_8002A9E0
		nop
		addiu   $v0, 0x1F

		loc_8002A9E0:
	sra     $v0, 5
		sh      $v0, 0($s1)
		jal     sub_80079340
		move    $a0, $s0
		bgez    $v0, loc_8002A9FC
		nop
		addiu   $v0, 0x1F

		loc_8002A9FC:
	addu    $s2, $s4
		sra     $v0, 5
		sh      $v0, 2($s1)
		sh      $zero, 4($s1)
		addiu   $s3, 1
		slti    $v0, $s3, 0xA
		bnez    $v0, loc_8002A9BC
		addiu   $s1, 8
		lhu     $v0, -0x4E74($gp)
		lhu     $v1, -0x4E72($gp)
		lhu     $a0, -0x4E70($gp)
		lw      $ra, 0x10 + var_s14($sp)
		lw      $s4, 0x10 + var_s10($sp)
		lw      $s3, 0x10 + var_sC($sp)
		lw      $s2, 0x10 + var_s8($sp)
		lw      $s1, 0x10 + var_s4($sp)
		lw      $s0, 0x10 + var_s0($sp)
		sh      $v0, -0x4E24($gp)
		sh      $v1, -0x4E22($gp)
		sh      $a0, -0x4E20($gp)
		jr      $ra
		addiu   $sp, 0x28
#endif

}


// autogenerated function stub: 
// unsigned long * /*$ra*/ DRAW_DrawShadow(struct _PrimPool *primPool /*$t3*/, struct _Model *model /*$a1*/, unsigned long **ot /*$a2*/, long fadeValue /*$a3*/)
unsigned long * DRAW_DrawShadow(struct _PrimPool *primPool, struct _Model *model, unsigned long **ot, long fadeValue)
{ // line 478, offset 0x8002a6f4
	/* begin block 1 */
		// Start line: 479
		// Start offset: 0x8002A6F4
		// Variables:
			struct POLY_G3_SEMITRANS *sg3; // $a1
			SVECTOR zero_vertex; // stack offset -24
			long clip; // stack offset -8
			long n; // $t0
			long p; // stack offset -16
			long otz; // stack offset -4
			unsigned long color; // stack offset -12
	/* end block 1 */
	// End offset: 0x8002A8AC
	// End Line: 538

	/* begin block 2 */
		// Start line: 983
	/* end block 2 */
	// End Line: 984
			UNIMPLEMENTED();
	return null;
}

void DRAW_FlatQuad(CVECTOR *color, short x0, short y0, short x1, int y1, int x2, int y2, int x3, int y3, struct _PrimPool *primPool, unsigned long **ot)
{
	unsigned long *prim;

	prim = primPool->nextPrim;

	if ((char*)prim < (char*)primPool->lastPrim - sizeof(POLY_F4) * 2)
	{
		setXY4((POLY_F4*)prim, x0, y0, x1, y1, x2, y2, x3, y3);
		setRGB0((POLY_F4*)prim, color->r, color->g, color->b);
		setPolyF4((POLY_F4*)prim);
		addPrim(ot, prim);

		primPool->nextPrim = (unsigned long*)(char*)primPool->nextPrim + sizeof(POLY_F4);
		primPool->numPrims++;

	}
}

void DRAW_TranslucentQuad(short x0, short y0, short x1, short y1, int x2, int y2, int x3, int y3, int r, int g, int b, int abr, struct _PrimPool *primPool, unsigned long **ot)
{
	unsigned long *prim;

	prim = primPool->nextPrim;
	
	if (prim < primPool->lastPrim - 12)
	{
		setDrawTPage((POLY_F4_SEMITRANS*)prim, 0, 1, 8);
		setAbr((POLY_F4_SEMITRANS*)prim, abr);
		setPolyFT4_ST(prim);
		setRGB0((POLY_F4_SEMITRANS*)prim, r, g, b);
		setXY4((POLY_F4_SEMITRANS*)prim, x0, y0, x1, y1, x2, y2, x3, y3);
		addPrim(ot, prim);
		primPool->nextPrim += sizeof(POLY_F4_SEMITRANS) / sizeof(unsigned long);
		primPool->numPrims++;
	}
}

void DRAW_DrawButton(struct _ButtonTexture *button, short x, short y, unsigned long **ot)
{
	struct _PrimPool *primPool;
	unsigned long *prim;
	short w;
	short h;
	short offsetx;
	short offsety;

	primPool = gameTrackerX.primPool;

	prim = primPool->nextPrim;
	if (primPool->lastPrim - 12 >= primPool->nextPrim)
	{
		w = button->textureW << button->xshift;
		h = button->textureH;

		offsetx = (button->vramBlock->x & 0x3F) << button->xshift;
		offsety = button->vramBlock->y;

		SetPolyFT4((POLY_FT4*)prim);

		setShadeTex(((POLY_FT4*)prim), 1);

		((POLY_FT4*)prim)->tpage = button->tpage;

		((POLY_FT4*)prim)->v0 = offsety;
		((POLY_FT4*)prim)->v1 = offsety;

		((POLY_FT4*)prim)->x0 = x;
		((POLY_FT4*)prim)->y0 = y;

		((POLY_FT4*)prim)->u0 = offsetx;

		((POLY_FT4*)prim)->x1 = (x + w) - 1;
		((POLY_FT4*)prim)->y1 = y;

		((POLY_FT4*)prim)->x1 = (x + w) - 1;
		((POLY_FT4*)prim)->y1 = y;

		((POLY_FT4*)prim)->u1 = (offsetx + w) - 1;

		((POLY_FT4*)prim)->x2 = x;
		((POLY_FT4*)prim)->y2 = (y + h) - 1;

		((POLY_FT4*)prim)->u2 = offsetx;
		((POLY_FT4*)prim)->v2 = (offsety + h) - 1;

		((POLY_FT4*)prim)->x3 = (x + w) - 1;
		((POLY_FT4*)prim)->y3 = (y + h) - 1;

		((POLY_FT4*)prim)->u3 = (offsetx + w) - 1;
		((POLY_FT4*)prim)->v3 = (offsety + h) - 1;

		((POLY_FT4*)prim)->clut = button->clut;
		
		addPrim(ot, prim);

		primPool->nextPrim += sizeof(POLY_FT4) / sizeof(unsigned long);
		primPool->numPrims++;
	}
}

void DRAW_LoadButton(long *addr, struct _ButtonTexture *button)
{ 
	PSX_RECT vramRect;
	long *paletteAddr;
	short paletteW;
	short paletteH;

	paletteAddr = NULL;
	paletteW = 0;
	button->xshift = 0;
	paletteH = 0;

	if (((int*)addr)[1] == 8)
	{
		button->xshift = 2;
		paletteW = 16;
		paletteH = 1;
		paletteAddr = &addr[5];
		addr = &addr[13];
	}
	
	button->textureW = ((unsigned short*)addr)[4];
	button->textureH = ((unsigned short*)addr)[5];

	if (paletteW < button->textureW)
	{
		vramRect.w = button->textureW;
	}
	else
	{
		vramRect.w = paletteW;	
	}

	vramRect.h = button->textureH + paletteH;
	button->vramBlock = VRAM_CheckVramSlot(&vramRect.x, &vramRect.y, vramRect.w, vramRect.h, 4, 0);
	button->tpage = getTPage(2 - button->xshift, 0, vramRect.x, vramRect.y);
	button->vramBlock->udata.button = button;
	
	vramRect.w = button->textureW;
	vramRect.h = button->textureH;
	
	LoadImage(&vramRect, (unsigned long*)(addr + 3));
	
	if (paletteAddr != NULL)
	{
		vramRect.w = paletteW;
		vramRect.h = paletteH;
		vramRect.y += button->textureH;
		
		LoadImage(&vramRect, (unsigned long*)paletteAddr);

		button->clut = getClut(vramRect.x, vramRect.y);
	}

	DrawSync(0);
}

void DRAW_FreeButton(struct _ButtonTexture *button)
{
	VRAM_ClearVramBlock(button->vramBlock);
}


// autogenerated function stub: 
// void /*$ra*/ DRAW_RingLine(struct _PrimPool *primPool /*$t0*/, unsigned long **ot /*$t1*/, long color /*$a2*/)
void DRAW_RingLine(struct _PrimPool *primPool, unsigned long **ot, long color)
{ // line 3649, offset 0x8002ad6c
	/* begin block 1 */
		// Start line: 3650
		// Start offset: 0x8002AD6C
		// Variables:
			unsigned long *prim; // $a3
			long flag; // stack offset -24
			long clip; // stack offset -20
			long z0; // stack offset -16
			long z1; // stack offset -12
			long z2; // stack offset -8
			long otz; // $a0
			long p; // stack offset -4
	/* end block 1 */
	// End offset: 0x8002AE94
	// End Line: 3712

	/* begin block 2 */
		// Start line: 4652
	/* end block 2 */
	// End Line: 4653
			UNIMPLEMENTED();
}


// autogenerated function stub: 
// void /*$ra*/ DRAW_RingPoint(struct _PrimPool *primPool /*$a0*/, unsigned long **ot /*$a1*/, long color /*$s2*/, struct _SVector *vel /*$s1*/, struct _SVector *acc /*stack 16*/)
void DRAW_RingPoint(struct _PrimPool *primPool, unsigned long **ot, long color, struct _SVector *vel, struct _SVector *acc)
{ // line 3714, offset 0x8002ae9c
	/* begin block 1 */
		// Start line: 3715
		// Start offset: 0x8002AE9C
		// Variables:
			struct _SVector outpoint; // stack offset -24
	/* end block 1 */
	// End offset: 0x8002AF94
	// End Line: 3726

	/* begin block 2 */
		// Start line: 4789
	/* end block 2 */
	// End Line: 4790
			UNIMPLEMENTED();
}


// autogenerated function stub: 
// unsigned long * /*$ra*/ DRAW_DrawRingPoints(struct _Model *model /*$a0*/, struct _VertexPool *vertexPool /*$a1*/, MATRIX *pcTransform /*$s0*/, struct _PrimPool *primPool /*$s5*/, unsigned long **ot /*stack 16*/, long color /*stack 20*/, int ring_type /*stack 24*/)
unsigned long * DRAW_DrawRingPoints(struct _Model *model, struct _VertexPool *vertexPool, MATRIX *pcTransform, struct _PrimPool *primPool, unsigned long **ot, long color, int ring_type)
{ // line 3736, offset 0x8002afac
	/* begin block 1 */
		// Start line: 3737
		// Start offset: 0x8002AFAC
		// Variables:
			struct _MFace *mface; // $s1
			struct _MFace *endMFace; // $s4
			struct _PVertex *pvertexList; // $s3
			struct _SVector (*pvertex[3]); // stack offset -96
			struct _SVector newVertex[3]; // stack offset -80
			long outcode; // $a0
			int first; // $v1
			int second; // $a0
			struct _SVector vel; // stack offset -56
			struct _SVector acc; // stack offset -48
	/* end block 1 */
	// End offset: 0x8002B294
	// End Line: 3837

	/* begin block 2 */
		// Start line: 4841
	/* end block 2 */
	// End Line: 4842
			UNIMPLEMENTED();
	return null;
}


// autogenerated function stub: 
// void /*$ra*/ DRAW_GlowQuad(struct _PrimPool *primPool /*$t7*/, unsigned long **ot /*$t9*/, long otz /*$a2*/, long color /*stack 12*/, struct _Vector *v0 /*stack 16*/, struct _Vector *v1 /*stack 20*/, struct _Vector *v2 /*stack 24*/, struct _Vector *v3 /*stack 28*/)
void DRAW_GlowQuad(struct _PrimPool *primPool, unsigned long **ot, long otz, long color, struct _Vector *v0, struct _Vector *v1, struct _Vector *v2, struct _Vector *v3)
{ // line 3879, offset 0x8002b2c8
	/* begin block 1 */
		// Start line: 3880
		// Start offset: 0x8002B2C8
		// Variables:
			unsigned long *prim; // $t1
			struct _POLY_NG4 *sg4; // $t0
	/* end block 1 */
	// End offset: 0x8002B524
	// End Line: 3922

	/* begin block 2 */
		// Start line: 7758
	/* end block 2 */
	// End Line: 7759
			UNIMPLEMENTED();
}


// autogenerated function stub: 
// void /*$ra*/ DRAW_CreateAGlowingCircle(struct _Vector *f1 /*$fp*/, long z /*$a1*/, struct _PrimPool *primPool /*stack 8*/, unsigned long **ot /*stack 12*/, long otz /*stack 16*/, long color /*stack 20*/, long w /*stack 24*/, long h /*stack 28*/, long angle /*stack 32*/)
void DRAW_CreateAGlowingCircle(struct _Vector *f1, long z, struct _PrimPool *primPool, unsigned long **ot, long otz, long color, long w, long h, long angle)
{ // line 3935, offset 0x8002b52c
	UNIMPLEMENTED();
}


// autogenerated function stub: 
// unsigned long * /*$ra*/ DRAW_DrawGlowPoints2(struct _Instance *instance /*$s0*/, long seg1 /*$a1*/, long seg2 /*$s1*/, struct _PrimPool *primPool /*$s3*/, unsigned long **ot /*stack 16*/, long color /*stack 20*/, long height /*stack 24*/)
unsigned long * DRAW_DrawGlowPoints2(struct _Instance *instance, long seg1, long seg2, struct _PrimPool *primPool, unsigned long **ot, long color, long height)
{ // line 4038, offset 0x8002bad8
	/* begin block 1 */
		// Start line: 4039
		// Start offset: 0x8002BAD8
		// Variables:
			_Position glowPoints1; // stack offset -88
			_Position glowPoints2; // stack offset -80
			struct _Vector f1; // stack offset -72
			struct _Vector f2; // stack offset -56
			struct _Vector f3; // stack offset -40
			long otz; // $s2
			long otz2; // $s0
			long z; // $a1
			long length; // $s1
			long angle; // $v1
	/* end block 1 */
	// End offset: 0x8002BC24
	// End Line: 4079

	/* begin block 2 */
		// Start line: 5534
	/* end block 2 */
	// End Line: 5535
			UNIMPLEMENTED();
	return null;
}


// autogenerated function stub: 
// unsigned long * /*$ra*/ DRAW_DrawGlowPoint(struct _Instance *instance /*$a0*/, long seg1 /*$a1*/, struct _PrimPool *primPool /*$s3*/, unsigned long **ot /*$s4*/, long color /*stack 16*/, int width /*stack 20*/, int height /*stack 24*/)
unsigned long * DRAW_DrawGlowPoint(struct _Instance *instance, long seg1, struct _PrimPool *primPool, unsigned long **ot, long color, int width, int height)
{ // line 4089, offset 0x8002bc44
	/* begin block 1 */
		// Start line: 4090
		// Start offset: 0x8002BC44
		// Variables:
			_Position glowPoints1; // stack offset -48
			struct _Vector f1; // stack offset -40
			long otz; // $t0
			long z; // $a1
			long angle; // $s2
	/* end block 1 */
	// End offset: 0x8002BCF0
	// End Line: 4115

	/* begin block 2 */
		// Start line: 5682
	/* end block 2 */
	// End Line: 5683
			UNIMPLEMENTED();
	return null;
}

int DRAW_DisplayTFace_zclipped_C(SVECTOR* vertex0, SVECTOR* vertex1, SVECTOR* vertex2, struct UVTYPE* uv0, struct UVTYPE* uv1, struct UVTYPE* uv2, long color0, long color1, long color2, struct _PrimPool* primPool, unsigned long** ot, int ndiv)
{
	struct SP_SUBDIV_STRUCT* sp; // $t2
	int maxz; // $s3
	int point; // $a1
	int n; // $t7
	POLY_GT4* prim; // $t9
	long* ptr; // $t8
	long clip; // $s0
	int next_point_in_vv; // $v1
	int current_point_in_vv; // $t1
	int next; // $t6, t0
	long clip_tmp; // $a0, v1
	long zval; // stack offset -48
	SVECTOR* tmpptr; // $v0
	long zn; // $v1
	long znext; // $a0
	long interp1; // $t1
	long interp2; // $a2
	long x; // $v1
	long y; // $v1
	int flag; // $t3
	long opz; // stack offset -44
	long temp1; // $a3
	long temp2; // $t0
	long temp3; // $t1

	//s4 = primPool
	//fp = color0

	sp = (struct SP_SUBDIV_STRUCT*)getScratchAddr(128);

	gte_ldv0(vertex0);
	gte_rt();
	gte_stlvnl(getScratchAddr(158));

	gte_ldv0(vertex1);
	gte_rt();
	gte_stlvnl(getScratchAddr(161));

	gte_ldv0(vertex2);
	gte_rt();
	gte_stlvnl(getScratchAddr(164));

	point = 0;
	//v0 = 2
	if (sp->out[0].z >= 160 || sp->out[3].z >= 160 || sp->out[2].z >= 160)
	{
		//loc_8002C188
		maxz = 160;

		//s7 = uv0
		prim = (POLY_GT4*)primPool->nextPrim;

		//v0 = ((long*)uv0)[0];
		clip = 0xFFFF;

		sp->texinfo[0] = ((long*)uv0)[0];

		//s5 = uv1

		n = 0;

		sp->texinfo[1] = ((long*)uv1)[0];

		//s2 = 0


		sp->texinfo[2] = ((long*)uv2)[0];

		//a3 = sp
		//s1 = sp

		sp->color[0] = color0;

		//v0 = color1

		ptr = (long*)prim + 1;

		sp->color[1] = color1;

		//v0 = color2

		//t3 = prim+0xA

		sp->color[2] = color2;

		//loc_8002C1E4
		next = n + 1;

		if (next >= 3)
		{
			next = 0;
		}

		//v1 = next << 1
		//v1 += next
		//v1 <<= 2;
		//v1 = sp + v1
		//v0 = (sp->out[0].z < 160) ^ 1
		//v1 = !(sp->out[next].z < 160)

		if (!(sp->out[0].z < 160))
		{
			if (n != 1)
			{
				if (n < 2 || n != 2)
				{
					//loc_8002C240
					tmpptr = vertex0;
				}
				else
				{
					//loc_8002C258
					tmpptr = vertex2;
				}
			}
			else
			{
				//loc_8002C24C
				tmpptr = vertex1;
			}

			//loc_8002C25C
			gte_ldv0(tmpptr);

			gte_rtps();

			((unsigned long*)(&prim->u0))[0] = sp->texinfo[0];
			ptr[0] = sp->color[0];
			gte_stsxy(ptr + 1);
			gte_stsxy(&sp->sxy[point]);
			//v0 = &sp->sxy[point]

			//v0 = &zval
			gte_stsz(&zval);

			if (maxz < zval)
			{
				maxz = zval;
			}
			//loc_8002C2C4

			//v0 = ((short*)prim->x0)[0]
			//t0 = prim+0xA

			clip_tmp = ((short*)prim->x0)[0] >> 31;

			if (((short*)prim)[5] < 0)
			{
				clip_tmp |= 0x2;
			}

			if (((short*)prim->x0)[0] >= 513)
			{
				clip_tmp |= 0x4;
			}

			if (((short*)prim)[5] >= 241)
			{
				clip_tmp |= 0x8;
			}

			clip &= clip_tmp;
			point++;

			//t3 += 0xC; 
			//t8 += 0xC;
			ptr += 3;

		}
		//loc_8002C308
		if (!(sp->out[0].z < 160) != !(sp->out[next].z < 160))
		{
			//v0 = t6 << 1
			//v0 += t6
			//v0 <<= 2
			//v0 =  sp->out[next].z / (((sp->out[0].z - 0xA0) << 12) - sp->out[next].z);
			next_point_in_vv = sp->out[0].x - sp->out[next].x;
			current_point_in_vv = sp->out[next].z / (((sp->out[0].z - 0xA0) << 12) - sp->out[next].z);

			if (current_point_in_vv < 0)
			{
				current_point_in_vv = -current_point_in_vv;
			}
			//loc_8002C354

			next_point_in_vv = next_point_in_vv * current_point_in_vv;

			interp2 = 4096 - current_point_in_vv;

			if (next_point_in_vv < 4096)
			{
				next_point_in_vv = 4095;
			}

			//loc_8002C36C

		}
		//loc_8002C52C
	}
	//loc_8002C884

#if 0
		loc_8002C36C:
	sra     $v0, $v1, 12
		addu    $v0, $a0, $v0
		sll     $v0, 1
		addiu   $v1, $v0, 0x100
		slti    $v0, $v1, 0x400
		bnez    $v0, loc_8002C390
		slti    $v0, $v1, -0x3FF
		li      $v1, 0x3FF
		slti    $v0, $v1, -0x3FF

		loc_8002C390:
	beqz    $v0, loc_8002C39C
		nop
		li      $v1, 0xFFFFFC01

		loc_8002C39C :
		sh      $v1, -2($t3)
		lw      $v0, 0x7C($t0)
		lw      $v1, 0x7C($a3)
		nop
		subu    $v0, $v1
		mult    $v0, $t1
		mflo    $v0
		bgez    $v0, loc_8002C3C4
		nop
		addiu   $v0, 0xFFF

		loc_8002C3C4:
	sra     $v0, 12
		addu    $v0, $v1, $v0
		sll     $v0, 1
		addiu   $v1, $v0, 0x78  # 'x'
		slti    $v0, $v1, 0x400
		bnez    $v0, loc_8002C3E8
		slti    $v0, $v1, -0x3FF
		li      $v1, 0x3FF
		slti    $v0, $v1, -0x3FF

		loc_8002C3E8:
	beqz    $v0, loc_8002C3F4
		nop
		li      $v1, 0xFFFFFC01

		loc_8002C3F4 :
		sh      $v1, 0($t3)
		mtc2    $a2, $8
		addiu   $v0, $s2, 0xB8
		addu    $v0, $t2, $v0
		lbu     $t4, 0($v0)
		lbu     $t5, 1($v0)
		mtc2    $t4, $9
		mtc2    $t5, $10
		nop
		nop
		cop2    0x198003D
		mtc2    $t1, $8
		sll     $v1, $t6, 2
		addiu   $v0, $v1, 0xB8
		addu    $v0, $t2, $v0
		lbu     $t4, 0($v0)
		lbu     $t5, 1($v0)
		mtc2    $t4, $9
		mtc2    $t5, $10
		nop
		nop
		cop2    0x1A8003E
		addiu   $v0, $t8, 8
		mfc2    $t4, $9
		mfc2    $t5, $10
		sb      $t4, 0($v0)
		sb      $t5, 1($v0)
		mtc2    $a2, $8
		addiu   $v0, $s2, 0xA8
		addu    $v0, $t2, $v0
		lbu     $t4, 0($v0)
		lbu     $t5, 1($v0)
		lbu     $t6, 2($v0)
		mtc2    $t4, $9
		mtc2    $t5, $10
		mtc2    $t6, $11
		nop
		nop
		cop2    0x198003D
		mtc2    $t1, $8
		addiu   $v1, 0xA8
		addu    $v1, $t2, $v1
		lbu     $t4, 0($v1)
		lbu     $t5, 1($v1)
		lbu     $t6, 2($v1)
		mtc2    $t4, $9
		mtc2    $t5, $10
		mtc2    $t6, $11
		nop
		nop
		cop2    0x1A8003E
		mfc2    $t4, $9
		mfc2    $t5, $10
		mfc2    $t6, $11
		sb      $t4, 0($t8)
		sb      $t5, 1($t8)
		sb      $t6, 2($t8)
		sll     $v0, $a1, 2
		lw      $v1, -2($t3)
		addu    $v0, $t2
		sw      $v1, 0xC4($v0)
		lh      $v0, -2($t3)
		lh      $a0, 0($t3)
		nop
		bgez    $a0, loc_8002C500
		srl     $v1, $v0, 31
		ori     $v1, 2

		loc_8002C500:
	slti    $v0, 0x201
		bnez    $v0, loc_8002C510
		slti    $v0, $a0, 0xF1
		ori     $v1, 4

		loc_8002C510 :
		bnez    $v0, loc_8002C51C
		nop
		ori     $v1, 8

		loc_8002C51C :
		and $s0, $v1
		addiu   $a1, 1
		addiu   $t3, 0xC
		addiu   $t8, 0xC

		loc_8002C52C :
		addiu   $s2, 4
		addiu   $a3, 0xC
		addiu   $t7, 1
		slti    $v0, $t7, 3
		bnez    $v0, loc_8002C1E4
		addiu   $s1, 4
		bnez    $s0, loc_8002C884
		li      $v0, 2
		sra     $s3, 2
		slti    $v0, $s3, 0xC00
		beqz    $v0, loc_8002C7F8
		nop
		lw      $s5, 0x18 + arg_2C($sp)
		nop
		bnez    $s5, loc_8002C744
		move    $t7, $zero
		blez    $a1, loc_8002C614
		move    $t3, $t7
		move    $t1, $t2
		addiu   $t0, $t7, 1

		loc_8002C57C:
	slt     $v0, $t0, $a1
		bnez    $v0, loc_8002C590
		sll     $v0, $t0, 2
		move    $t0, $zero
		sll     $v0, $t0, 2

		loc_8002C590 :
		addu    $v0, $t2, $v0
		lh      $a0, 0xC4($t1)
		lh      $v1, 0xC4($v0)
		nop
		subu    $v0, $a0, $v1
		bgez    $v0, loc_8002C5B4
		slti    $v0, 0x400
		subu    $v0, $v1, $a0
		slti    $v0, 0x400

		loc_8002C5B4:
	beqz    $v0, loc_8002C5F8
		sll     $v0, $t0, 2
		addu    $v0, $t2, $v0
		lh      $a0, 0xC6($t1)
		lh      $v1, 0xC6($v0)
		nop
		subu    $v0, $a0, $v1
		bltz    $v0, loc_8002C5E8
		slti    $v0, 0x200
		beqz    $v0, loc_8002C5F8
		nop
		j       loc_8002C604
		addiu   $t1, 4

		loc_8002C5E8:
	subu    $v0, $v1, $a0
		slti    $v0, 0x200
		bnez    $v0, loc_8002C600
		nop

		loc_8002C5F8 :
	j       loc_8002C614
		li      $t3, 1

		loc_8002C600 :
		addiu   $t1, 4

		loc_8002C604 :
		addiu   $t7, 1
		slt     $v0, $t7, $a1
		bnez    $v0, loc_8002C57C
		addiu   $t0, $t7, 1

		loc_8002C614 :
		bnez    $t3, loc_8002C6AC
		nop
		li      $v0, 4
		bne     $a1, $v0, loc_8002C6A4
		nop
		lhu     $v0, 0xD0($t2)
		lhu     $v1, 0xC8($t2)
		sll     $v0, 16
		sra     $a0, $v0, 16
		sll     $v1, 16
		sra     $v1, 16
		subu    $v0, $a0, $v1
		bgez    $v0, loc_8002C654
		slti    $v0, 0x400
		subu    $v0, $v1, $a0
		slti    $v0, 0x400

		loc_8002C654:
	beqz    $v0, loc_8002C6A0
		nop
		lhu     $v0, 0xD2($t2)
		lhu     $v1, 0xCA($t2)
		sll     $v0, 16
		sra     $a0, $v0, 16
		sll     $v1, 16
		sra     $v1, 16
		subu    $v0, $a0, $v1
		bltz    $v0, loc_8002C690
		slti    $v0, 0x200
		beqz    $v0, loc_8002C6A0
		nop
		j       loc_8002C6A4
		nop

		loc_8002C690 :
	subu    $v0, $v1, $a0
		slti    $v0, 0x200
		bnez    $v0, loc_8002C6A4
		nop

		loc_8002C6A0 :
	li      $t3, 1

		loc_8002C6A4 :
		beqz    $t3, loc_8002C744
		nop

		loc_8002C6AC :
	lw      $s6, 0x18 + arg_0($sp)
		lw      $s7, 0x18 + arg_4($sp)
		lw      $s5, 0x18 + arg_8($sp)
		lwc2    $0, 0($s6)
		lwc2    $1, 4($s6)
		lwc2    $2, 0($s7)
		lwc2    $3, 4($s7)
		lwc2    $4, 0($s5)
		lwc2    $5, 4($s5)
		addiu   $a0, $t2, 0xA8
		lbu     $v0, 0xAB($t2)
		addiu   $v1, $t2, 0xAC
		sb      $v0, 0xB3($t2)
		addiu   $v0, $t2, 0xB0
		lwc2    $20, 0($a0)
		lwc2    $21, 0($v1)
		lwc2    $22, 0($v0)
		lwc2    $6, 0($v0)
		lw      $s6, 0x18 + arg_C($sp)
		nop
		lw      $v0, 0($s6)
		nop
		sw      $v0, 0xC($t9)
		lw      $s7, 0x18 + arg_10($sp)
		nop
		lw      $v0, 0($s7)
		nop
		sw      $v0, 0x18($t9)
		lw      $s5, 0x18 + arg_14($sp)
		nop
		lw      $v0, 0($s5)
		move    $a0, $t9
		sw      $v0, 0x24($t9)
		lw      $a1, 0x18 + arg_28($sp)
		jal     sub_8002C8B4
		li      $a2, 1
		j       loc_8002C884
		li      $v0, 1

		loc_8002C744:
	lw      $s6, 8($t9)
		lw      $s7, 0x14($t9)
		lw      $s5, 0x20($t9)
		mtc2    $s6, $12
		mtc2    $s5, $14
		mtc2    $s7, $13
		nop
		nop
		cop2    0x1400006
		lhu     $v0, 0xBA($t2)
		nop
		sh      $v0, 0xE($t9)
		lhu     $v0, 0xBE($t2)
		nop
		sh      $v0, 0x1A($t9)
		addiu   $v0, $sp, 0x18 + var_4
		swc2    $24, 0($v0)
		lw      $v0, 0x18 + var_4($sp)
		nop
		bgtz    $v0, loc_8002C884
		li      $v0, 4
		li      $v0, 3
		bne     $a1, $v0, loc_8002C7F0
		li      $v0, 4
		li      $a2, 0xFFFFFF
		sra     $v0, $fp, 24
		sll     $a1, $s3, 2
		sb      $v0, 7($t9)
		lw      $s6, 0x18 + arg_28($sp)
		li      $v0, 1
		addu    $a1, $s6
		lw      $v1, 0($a1)
		lui     $a0, 0x900
		and $v1, $a2
		or $v1, $a0
		and $a2, $t9, $a2
		sw      $v1, 0($t9)
		sw      $a2, 0($a1)
		lw      $v1, 4($s4)
		lw      $a0, 0($s4)
		j       loc_8002C878
		addiu   $v1, 0x28  # '('

		loc_8002C7F0:
	beq     $a1, $v0, loc_8002C800
		lui     $a2, 0xFF

		loc_8002C7F8 :
		j       loc_8002C884
		li      $v0, 2

		loc_8002C800 :
		li      $a2, 0xFFFFFF
		sra     $v0, $fp, 24
		lw      $a3, 0x1C($t9)
		lw      $t0, 0x20($t9)
		lw      $t1, 0x24($t9)
		lw      $v1, 0x28($t9)
		lw      $a0, 0x2C($t9)
		lw      $a1, 0x30($t9)
		ori     $v0, 8
		sb      $v0, 7($t9)
		li      $v0, 1
		sw      $v1, 0x1C($t9)
		sw      $a0, 0x20($t9)
		sw      $a1, 0x24($t9)
		sw      $a3, 0x28($t9)
		sw      $t0, 0x2C($t9)
		sw      $t1, 0x30($t9)
		lw      $s7, 0x18 + arg_28($sp)
		sll     $a1, $s3, 2
		addu    $a1, $s7
		lw      $v1, 0($a1)
		lui     $a0, 0xC00
		and $v1, $a2
		or $v1, $a0
		and $a2, $t9, $a2
		sw      $v1, 0($t9)
		sw      $a2, 0($a1)
		lw      $v1, 4($s4)
		lw      $a0, 0($s4)
		addiu   $v1, 0x34  # '4'

		loc_8002C878:
	addu    $a0, $v0
		sw      $v1, 4($s4)
		sw      $a0, 0($s4)

		loc_8002C884 :
		lw      $ra, 0x18 + var_s24($sp)
		lw      $fp, 0x18 + var_s20($sp)
		lw      $s7, 0x18 + var_s1C($sp)
		lw      $s6, 0x18 + var_s18($sp)
		lw      $s5, 0x18 + var_s14($sp)
		lw      $s4, 0x18 + var_s10($sp)
		lw      $s3, 0x18 + var_sC($sp)
		lw      $s2, 0x18 + var_s8($sp)
		lw      $s1, 0x18 + var_s4($sp)
		lw      $s0, 0x18 + var_s0($sp)
		jr      $ra
		addiu   $sp, 0x40
#endif

	return 0;
}

long* DRAW_Zclip_subdiv(POLY_GT3* texture, unsigned long** ot, int ndiv)
{
	struct SP_SUBDIV_STRUCT* sp;
	struct _PrimPool* primPool;
	int clip;

	sp = (struct SP_SUBDIV_STRUCT*)getScratchAddr(128);

	if (ndiv != 0)
	{
		sp = (struct SP_SUBDIV_STRUCT*)getScratchAddr(181);
	}
	
	gte_strgb3(&sp->color0, &sp->color1, &sp->color2);
	
	gte_ldv0(&sp->vertex0);
	gte_ldv1(&sp->vertex1);
	gte_ldv2(&sp->vertex2);

	primPool = gameTrackerX.primPool;

	primPool->nextPrim = (unsigned long*)texture;
	
	((int*)&sp->face_v1.vx)[0] = ((int*)&sp->vertex1.x)[0];
	((int*)&sp->face_v0.vz)[0] = ((int*)&sp->vertex0.z)[0];
	((int*)&sp->face_v1.vz)[0] = ((int*)&sp->vertex2.z)[0];
	((int*)&sp->face_v2.vx)[0] = ((int*)&sp->vertex2.x)[0];
	((int*)&sp->face_v2.vz)[0] = ((int*)&sp->vertex2.z)[0];
	((int*)&sp->face_v0.vx)[0] = ((int*)&sp->vertex0.x)[0];

	sp->face_v01.vx = ((sp->face_v0.vx + sp->face_v1.vx) + ((sp->face_v0.vx + sp->face_v1.vx) >> 31) >> 1);
	sp->face_v01.vy = ((sp->face_v0.vy + sp->face_v1.vy) + ((sp->face_v0.vy + sp->face_v1.vy) >> 31) >> 1);
	sp->face_v01.vz = ((sp->face_v0.vz + sp->face_v1.vz) + ((sp->face_v0.vz + sp->face_v1.vz) >> 31) >> 1);

	sp->face_v12.vx = ((sp->face_v1.vx + sp->face_v2.vx) + ((sp->face_v1.vx + sp->face_v2.vx) >> 31) >> 1);
	sp->face_v12.vy = ((sp->face_v1.vy +  sp->face_v2.vy) + ((sp->face_v1.vy +  sp->face_v2.vy) >> 31) >> 1);
	sp->face_v12.vz = ((sp->face_v1.vz + sp->face_v2.vz) + ((sp->face_v1.vz + sp->face_v2.vz) >> 31) >> 1);

	sp->face_v20.vx = ((sp->face_v2.vx + sp->face_v0.vx) + ((sp->face_v2.vx + sp->face_v0.vx) >> 31) >> 1);
	sp->face_v20.vy = ((sp->face_v2.vy + sp->face_v0.vy) + ((sp->face_v2.vy + sp->face_v0.vy) >> 31) >> 1);
	sp->face_v20.vz = ((sp->face_v2.vz + sp->face_v0.vz) + ((sp->face_v2.vz + sp->face_v0.vz) >> 31) >> 1);

	((int*)&sp->face_uv0)[0] = ((int*)texture)[3];
	((int*)&sp->face_uv1)[0] = ((int*)texture)[6];
	
	sp->face_uv01.u = (sp->face_uv0.u + sp->face_uv1.u) >> 1;
	sp->face_uv12.pad = sp->face_uv1.pad;
	sp->face_uv01.pad = sp->face_uv1.pad;
	sp->face_uv01.v = (sp->face_uv0.v + sp->face_uv1.v) >> 1;
	sp->face_uv2.v = (sp->face_uv1.u + sp->face_uv2.v) >> 1;
	sp->face_uv12.v = (sp->face_uv1.v + sp->face_uv2.v) >> 1;
	sp->face_uv20.u = (sp->face_uv2.v + sp->face_uv0.v) >> 1;
	sp->face_uv20.v = (sp->face_uv2.v + sp->face_uv0.v) >> 1;
	
	sp->face_uv20.pad = sp->face_uv0.pad;
	
	sp->color01.r = (sp->color0.r + sp->color1.r) >> 1;
	sp->color01.g = (sp->color0.g + sp->color1.g) >> 1;
	sp->color01.b = (sp->color0.b + sp->color1.b) >> 1;
	
	sp->color12.r = (sp->color0.b + sp->color1.b) >> 1;
	sp->color12.g = (sp->color1.g + sp->color2.g) >> 1;
	sp->color12.b = (sp->color1.b + sp->color2.b) >> 1;
	
	sp->color20.r = (sp->color2.r + sp->color0.r) >> 1;
	sp->color20.g = (sp->color2.g + sp->color0.g) >> 1;
	sp->color20.b = (sp->color2.b + sp->color0.b) >> 1;

	sp->color12.code = sp->color0.code;
	sp->color01.code = sp->color0.code;

	clip = DRAW_DisplayTFace_zclipped_C(&sp->face_v0, &sp->face_v01, &sp->face_v20, &sp->face_uv0, &sp->face_uv01, &sp->face_uv20, ((long*)&sp->color0)[0], ((long*)&sp->color01)[0], ((long*)&sp->color20)[0], primPool, ot, ndiv);
	clip |= DRAW_DisplayTFace_zclipped_C(&sp->face_v20, &sp->face_v12, &sp->face_v2, &sp->face_uv20, &sp->face_uv12, &sp->face_uv2, ((long*)&sp->color0)[0], ((long*)&sp->color12)[0], ((long*)&sp->color2)[0], primPool, ot, ndiv);
	
	sp->face_uv01.pad = sp->face_uv0.pad;
	sp->face_uv20.pad = sp->face_uv1.pad;
	
	clip |= DRAW_DisplayTFace_zclipped_C(&sp->face_v01, &sp->face_v12, &sp->face_v20, &sp->face_uv01, &sp->face_uv12, &sp->face_uv20, ((long*)&sp->color01)[0], ((long*)&sp->color12)[0], ((long*)&sp->color20)[0], primPool, ot, ndiv);
	clip |= DRAW_DisplayTFace_zclipped_C(&sp->face_v01, &sp->face_v1, &sp->face_v12, &sp->face_uv01, &sp->face_uv1, &sp->face_uv12, ((long*)&sp->color01)[0], ((long*)&sp->color1)[0], ((long*)&sp->color12)[0], primPool, ot, ndiv);

	if ((clip & 0x5) != 0x4)
	{
		return (long*)primPool->nextPrim;
	}

	return NULL;
}

void DRAW_LoadingMessage()
{
	unsigned long **drawot;

#if !defined(PSXPC_VERSION)
	while (CheckVolatile(gameTrackerX.drawTimerReturn) != 0)
	{

	}

	while (CheckVolatile(gameTrackerX.reqDisp) != 0)
	{

	}
#endif

	DrawSyncCallback(NULL);
	VSyncCallback(NULL);

	PutDrawEnv(&draw[gameTrackerX.drawPage ^ 1]);
	
	FONT_FontPrintCentered(localstr_get(LOCALSTR_Hint52), 150);
	
	DisplayHintBox(FONT_GetStringWidth(localstr_get(LOCALSTR_Hint52)), 150);
	
	FONT_Flush();

	drawot = gameTrackerX.drawOT;

#if defined(PSX_VERSION)
#if defined(USE_32_BIT_ADDR)
	DrawOTag((unsigned long*)drawot + 3071 * 2);
#else
	DrawOTag((unsigned long*)drawot + 3071);
#endif
#endif

	DrawSync(0);
	ClearOTagR((unsigned long*)drawot, 3072);
	PutDrawEnv(&draw[gameTrackerX.drawPage]);
	VSyncCallback(VblTick);
	DrawSyncCallback(DrawCallback);
}




