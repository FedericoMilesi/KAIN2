#include "CORE.H"
#include "CAMERA.H"
#include "PIPE3D.H"
#include "GAMELOOP.H"
#include "MATH3D.H"


// autogenerated function stub: 
// void /*$ra*/ PIPE3D_AspectAdjustMatrix(MATRIX *matrix /*$a0*/)
void PIPE3D_AspectAdjustMatrix(MATRIX *matrix)
{ // line 68, offset 0x8003a1f0
	/* begin block 1 */
		// Start line: 136
	/* end block 1 */
	// End Line: 137

	/* begin block 2 */
		// Start line: 139
	/* end block 2 */
	// End Line: 140

}

void PIPE3D_CalculateWCTransform(struct _CameraCore_Type *cameraCore)
{
	MATRIX user_rotation;
	MATRIX first;
	MATRIX* cam_wcTrans;
	SVECTOR v0;
	VECTOR v1;

	cam_wcTrans = cameraCore->wcTransform;
	
	v0.vx = -cameraCore->position.x;
	v0.vy = -cameraCore->position.y;
	v0.vz = -cameraCore->position.z;

	if (!(gameTrackerX.debugFlags & 0x8))
	{
		MATH3D_SetUnityMatrix(&user_rotation);

		v0.vx = -cameraCore->position.x;
		v0.vy = -cameraCore->position.y;
		v0.vz = -cameraCore->position.z;
	}
	else
	{
		MATH3D_SetUnityMatrix(&user_rotation);

		v0.vx = -cameraCore->debugPos.x;
		v0.vy = -cameraCore->debugPos.y;
		v0.vz = -cameraCore->debugPos.z;

		cameraCore->nondebugPos.x = cameraCore->position.x;
		cameraCore->nondebugPos.y = cameraCore->position.y;
		cameraCore->nondebugPos.z = cameraCore->position.z;

		cameraCore->position.x = cameraCore->debugPos.x;
		cameraCore->position.y = cameraCore->debugPos.y;
		cameraCore->position.z = cameraCore->debugPos.z;
	}

	first.m[0][0] = ONE;
	first.m[0][1] = 0;
	first.m[0][2] = 0;

	first.m[1][0] = 0;
	first.m[1][1] = 0;
	first.m[1][2] = -ONE;

	first.m[2][0] = 0;
	first.m[2][1] = ONE;
	first.m[2][2] = 0;

	MulMatrix0(&first, &user_rotation, cam_wcTrans);
	MulMatrix0(&first, &user_rotation, cameraCore->wcTransform2);

	PIPE3D_AspectAdjustMatrix(cam_wcTrans);

	cam_wcTrans->m[0][0] = (cam_wcTrans->m[0][0] * cameraCore->screenScale.x) >> 12;
	cam_wcTrans->m[0][1] = (cam_wcTrans->m[0][1] * cameraCore->screenScale.x) >> 12;
	cam_wcTrans->m[0][2] = (cam_wcTrans->m[0][2] * cameraCore->screenScale.x) >> 12;

	cam_wcTrans->m[1][0] = (cam_wcTrans->m[1][0] * cameraCore->screenScale.y) >> 12;
	cam_wcTrans->m[1][1] = (cam_wcTrans->m[1][1] * cameraCore->screenScale.y) >> 12;
	cam_wcTrans->m[1][2] = (cam_wcTrans->m[1][2] * cameraCore->screenScale.y) >> 12;

	cam_wcTrans->m[2][0] = (cam_wcTrans->m[2][0] * cameraCore->screenScale.z) >> 12;
	cam_wcTrans->m[2][1] = (cam_wcTrans->m[2][1] * cameraCore->screenScale.z) >> 12;
	cam_wcTrans->m[2][2] = (cam_wcTrans->m[2][2] * cameraCore->screenScale.z) >> 12;

	gte_SetRotMatrix(cam_wcTrans);
	gte_ldv0(v0);
	gte_mvmva(1, 0, 0, 3, 0);
	gte_stlvnl(v1);

	TransMatrix(cam_wcTrans, &v1);

	gte_SetRotMatrix(cameraCore->wcTransform2);
	gte_ldv0(v0);
	gte_mvmva(1, 0, 0, 3, 0);
	gte_stlvnl(v1);

	TransMatrix(cameraCore->wcTransform2, &v1);
}

void PIPE3D_InvertTransform(MATRIX *target, MATRIX *source)
{
	VECTOR sourceTrans;
	MATRIX normMat;

	if (((short*)source)[2*3] == 1)
	{
		PIPE3D_NormalizeMatrix(target, &normMat);
		TransposeMatrix(&normMat, target);
	}
	else
	{
		TransposeMatrix(source, target);
	}

	sourceTrans.vx = -source->t[0];
	sourceTrans.vy = -source->t[1];
	sourceTrans.vz = -source->t[2];

	ApplyMatrixLV(target, &sourceTrans, (VECTOR*)target->t);
}


// autogenerated function stub: 
// long /*$ra*/ PIPE3D_MatrixColumnLength(MATRIX *transform /*$a0*/, long column /*$a1*/)
long PIPE3D_MatrixColumnLength(MATRIX *transform, long column)
{ // line 174, offset 0x8003a688
	/* begin block 1 */
		// Start line: 175
		// Start offset: 0x8003A688
	/* end block 1 */
	// End offset: 0x8003A688
	// End Line: 175

	/* begin block 2 */
		// Start line: 405
	/* end block 2 */
	// End Line: 406

	return 0;
}


// autogenerated function stub: 
// void /*$ra*/ PIPE3D_NormalizeMatrix(MATRIX *target /*$s1*/, MATRIX *source /*$s0*/)
void PIPE3D_NormalizeMatrix(MATRIX* target, MATRIX* source)
{
	VECTOR scalevec; // stack offset -32
	long scale; // $v1
	typedef struct {
		long m[3]; // size=12, offset=0
	} tmm;
	typedef struct {
		long m[5]; // size=20, offset=0
	} cmm;

}


// autogenerated function stub: 
// void /*$ra*/ PIPE3D_TransformVerticesToWorld(struct _Instance *instance /*stack 0*/, struct _SVector *poolVertex /*$s2*/, long *vtxSegment /*$s5*/, struct _Vector *Average /*$fp*/)
void PIPE3D_TransformVerticesToWorld(struct _Instance *instance, struct _SVector *poolVertex, long *vtxSegment, struct _Vector *Average)
{ // line 753, offset 0x8003a7b0
	/* begin block 1 */
		// Start line: 754
		// Start offset: 0x8003A7B0
		// Variables:
			MATRIX *segMatrix; // $s1
			struct _Model *model; // $s7
			struct _MVertex *vertexList; // stack offset -48
			long i; // $s3
			struct _Segment *segment; // $v1
			struct _SVector *orgPoolVertex; // stack offset -44
			struct _SVector minV; // stack offset -64
			struct _SVector maxV; // stack offset -56

		/* begin block 1.1 */
			// Start line: 773
			// Start offset: 0x8003A890
			// Variables:
				struct _MVertex *firstVertex; // $s0
				struct _MVertex *lastVertex; // $s6
				struct _MVertex *modelVertex; // $s0
		/* end block 1.1 */
		// End offset: 0x8003A9DC
		// End Line: 815
	/* end block 1 */
	// End offset: 0x8003AAAC
	// End Line: 840

	/* begin block 2 */
		// Start line: 1506
	/* end block 2 */
	// End Line: 1507

}


// autogenerated function stub: 
// void /*$ra*/ PIPE3D_InstanceTransformAndDraw(struct _Instance *instance /*$s2*/, struct _CameraCore_Type *cameraCore /*$s1*/, struct _VertexPool *vertexPool /*$s0*/, struct _PrimPool *primPool /*$s7*/, unsigned long **ot /*stack 16*/, struct _Mirror *mirror /*stack 20*/)
void PIPE3D_InstanceTransformAndDraw(struct _Instance *instance, struct _CameraCore_Type *cameraCore, struct _VertexPool *vertexPool, struct _PrimPool *primPool, unsigned long **ot, struct _Mirror *mirror)
{ // line 856, offset 0x8003aadc
	/* begin block 1 */
		// Start line: 857
		// Start offset: 0x8003AADC
		// Variables:
			struct Object *object; // $v0
			struct _Model *model; // $s4
			//MATRIX *matrixPool; // $s3
			//MATRIX lm; // stack offset -80
			long flags; // $s1

		/* begin block 1.1 */
			// Start line: 893
			// Start offset: 0x8003AB34
			// Variables:
				struct _MVertex *vertexList; // $s0
				struct _PVertex *poolVertex; // $s5
				//struct CVECTOR *vertexColor; // $s6
				long spadOffset; // $v1
				long spadFree; // $a1
				long allocSize; // $a0

			/* begin block 1.1.1 */
				// Start line: 1036
				// Start offset: 0x8003AC5C
				// Variables:
					long BackColorSave; // stack offset -44
					long BlendStartSave; // $s0
					int pval; // stack offset -48
			/* end block 1.1.1 */
			// End offset: 0x8003ADA4
			// End Line: 1076
		/* end block 1.1 */
		// End offset: 0x8003ADA4
		// End Line: 1081
	/* end block 1 */
	// End offset: 0x8003ADA4
	// End Line: 1082

	/* begin block 2 */
		// Start line: 1344
	/* end block 2 */
	// End Line: 1345

}


// autogenerated function stub: 
// void /*$ra*/ PIPE3D_InstanceListTransformAndDrawFunc(struct _StreamUnit *unit /*$a0*/, unsigned long **ot /*$s3*/, struct _CameraCore_Type *cameraCore /*$s1*/, struct _Instance *instance /*$s0*/)
void PIPE3D_InstanceListTransformAndDrawFunc(struct _StreamUnit *unit, unsigned long **ot, struct _CameraCore_Type *cameraCore, struct _Instance *instance)
{ // line 1452, offset 0x8003add0
	/* begin block 1 */
		// Start line: 1453
		// Start offset: 0x8003ADD0
		// Variables:
			struct _VertexPool *vertexPool; // $s4
			struct _PrimPool *primPool; // $s2
			//struct VECTOR dpv[2]; // stack offset -72
			long maxRad; // $a1
			struct Level *level; // $s5
			SVECTOR bsPos; // stack offset -40
	/* end block 1 */
	// End offset: 0x8003B0FC
	// End Line: 1586

	/* begin block 2 */
		// Start line: 2904
	/* end block 2 */
	// End Line: 2905

}


// autogenerated function stub: 
// void /*$ra*/ PIPE3D_InstanceListTransformAndDraw(struct _StreamUnit *unit /*$s3*/, struct GameTracker *gameTracker /*$a1*/, unsigned long **ot /*$s4*/, struct _CameraCore_Type *cameraCore /*$s5*/)
void PIPE3D_InstanceListTransformAndDraw(struct _StreamUnit *unit, struct GameTracker *gameTracker, unsigned long **ot, struct _CameraCore_Type *cameraCore)
{ // line 1588, offset 0x8003b120
	/* begin block 1 */
		// Start line: 1589
		// Start offset: 0x8003B120
		// Variables:
			struct _Instance *instance; // $s0
			int id; // $s2
			struct _Instance *player; // $s1
	/* end block 1 */
	// End offset: 0x8003B1F0
	// End Line: 1603

	/* begin block 2 */
		// Start line: 2547
	/* end block 2 */
	// End Line: 2548

}


// autogenerated function stub: 
// void /*$ra*/ PIPE3D_TransformFromZAxis(MATRIX *transform /*$s0*/, struct _SVector *normal /*$s1*/)
void PIPE3D_TransformFromZAxis(MATRIX *transform, struct _SVector *normal)
{ // line 1606, offset 0x8003b218
	/* begin block 1 */
		// Start line: 1607
		// Start offset: 0x8003B218
		// Variables:
			struct _G2EulerAngles_Type ea1; // stack offset -40
			struct _SVector xprod; // stack offset -32
			struct _SVector yprod; // stack offset -24
	/* end block 1 */
	// End offset: 0x8003B3F4
	// End Line: 1645

	/* begin block 2 */
		// Start line: 2588
	/* end block 2 */
	// End Line: 2589

}


// autogenerated function stub: 
// void /*$ra*/ PIPE3D_CalcWorldToSplitPlaneTransform(MATRIX *wpTransform /*$s1*/, struct _SVector *normal /*$a1*/, struct _SVector *translation /*$s0*/)
void PIPE3D_CalcWorldToSplitPlaneTransform(MATRIX *wpTransform, struct _SVector *normal, struct _SVector *translation)
{ // line 1649, offset 0x8003b408
	/* begin block 1 */
		// Start line: 1650
		// Start offset: 0x8003B408
		// Variables:
			struct _SVector svector; // stack offset -40
			struct _Vector vector; // stack offset -32
	/* end block 1 */
	// End offset: 0x8003B408
	// End Line: 1650

	/* begin block 2 */
		// Start line: 2683
	/* end block 2 */
	// End Line: 2684

}


// autogenerated function stub: 
// long /*$ra*/ PIPE3D_TransformAnimatedSplitInstanceVertices(struct _MVertex *vertexList /*stack 0*/, struct _PVertex *poolVertex /*$s4*/, struct _Model *model /*stack 8*/, MATRIX *wcTransform /*stack 12*/, MATRIX *matrixPool /*stack 16*/, struct _Mirror *mirror /*stack 20*/, MATRIX *lm /*stack 24*/, struct CVECTOR *vertexColor /*stack 28*/, struct CVECTOR *vertexSrcCol /*stack 32*/)
long PIPE3D_TransformAnimatedSplitInstanceVertices(struct _MVertex *vertexList, struct _PVertex *poolVertex, struct _Model *model, MATRIX *wcTransform, MATRIX *matrixPool, struct _Mirror *mirror, MATRIX *lm, CVECTOR *vertexColor, CVECTOR *vertexSrcCol)
{ // line 1688, offset 0x8003b4dc
	/* begin block 1 */
		// Start line: 1689
		// Start offset: 0x8003B4DC
		// Variables:
			struct TransformAnimatedInstanceVerticesWork_t *w; // $s7
			MATRIX *segMatrix; // $s2
			long i; // stack offset -64
			struct _Segment *segment; // stack offset -60
			//struct CVECTOR defaultRGBCD; // stack offset -80

		/* begin block 1.1 */
			// Start line: 1710
			// Start offset: 0x8003B56C
		/* end block 1.1 */
		// End offset: 0x8003B570
		// End Line: 1712

		/* begin block 1.2 */
			// Start line: 1719
			// Start offset: 0x8003B5A8
			// Variables:
				struct _MVertex *firstVertex; // stack offset -56
				struct _MVertex *lastVertex; // $fp
				struct _MVertex *modelVertex; // $a2
				struct _Normal *n0; // $t1
				struct _Normal *n1; // $t2
				struct _Normal *n2; // $t3
				//struct CVECTOR white; // stack offset -72
				//struct CVECTOR *c0; // $s1
				//struct CVECTOR *c1; // $s6
				//struct CVECTOR *c2; // $s5
				//long vtxcolflgs; // stack offset -52
		/* end block 1.2 */
		// End offset: 0x8003BA44
		// End Line: 1879
	/* end block 1 */
	// End offset: 0x8003BA6C
	// End Line: 1883

	/* begin block 2 */
		// Start line: 3376
	/* end block 2 */
	// End Line: 3377

	return 0;
}


// autogenerated function stub: 
// void /*$ra*/ PIPE3D_TransformSplitInstanceVertices(struct _MVertex *vertexList /*stack 0*/, struct _PVertex *pvertex /*$s2*/, struct _Model *model /*stack 8*/, MATRIX *wpTransform /*stack 12*/, MATRIX *matrixPool /*stack 16*/, struct _Mirror *mirror /*stack 20*/)
void PIPE3D_TransformSplitInstanceVertices(struct _MVertex *vertexList, struct _PVertex *pvertex, struct _Model *model, MATRIX *wpTransform, MATRIX *matrixPool, struct _Mirror *mirror)
{ // line 1891, offset 0x8003baa8
	/* begin block 1 */
		// Start line: 1892
		// Start offset: 0x8003BAA8
		// Variables:
			MATRIX *spTransform; // $fp
			struct _Vector *vector; // $s1
			long i; // $s5
			struct _Segment *segment; // $v1

		/* begin block 1.1 */
			// Start line: 1904
			// Start offset: 0x8003BB30
			// Variables:
				struct _MVertex *firstVertex; // $s0
				struct _MVertex *lastVertex; // $s4
				struct _MVertex *modelVertex; // $s0
		/* end block 1.1 */
		// End offset: 0x8003BBC8
		// End Line: 1922
	/* end block 1 */
	// End offset: 0x8003BBEC
	// End Line: 1925

	/* begin block 2 */
		// Start line: 3663
	/* end block 2 */
	// End Line: 3664

}


// autogenerated function stub: 
// void /*$ra*/ PIPE3D_AnimateTextures(struct AniTex *aniTextures /*$t1*/, long req_frame /*$a1*/)
void PIPE3D_AnimateTextures(struct AniTex *aniTextures, long req_frame)
{ // line 1927, offset 0x8003bc1c
	/* begin block 1 */
		// Start line: 1928
		// Start offset: 0x8003BC1C
		// Variables:
			struct AniTexInfo *ani_tex_info; // $t0
			struct TextureMT3 *dest; // $a0
			struct TextureMT3 *src; // $v1
			long i; // $a3
	/* end block 1 */
	// End offset: 0x8003BCB4
	// End Line: 1947

	/* begin block 2 */
		// Start line: 3795
	/* end block 2 */
	// End Line: 3796

}


// autogenerated function stub: 
// void /*$ra*/ PIPE3D_AnimateTerrainTextures(struct DrMoveAniTex *aniTextures /*$a0*/, long req_frame /*$a1*/, struct _PrimPool *primPool /*$a2*/, unsigned long **drawot /*$a3*/)
void PIPE3D_AnimateTerrainTextures(struct DrMoveAniTex *aniTextures, long req_frame, struct _PrimPool *primPool, unsigned long **drawot)
{ // line 2020, offset 0x8003bcbc
	/* begin block 1 */
		// Start line: 2022
		// Start offset: 0x8003BCBC
		// Variables:
			unsigned long *prim; // $t3
			struct DrMoveAniTexDestInfo *dest; // $t1
			struct DrMoveAniTexSrcInfo *src; // $t2
			long i; // $t5
			unsigned long **otl; // $a3
	/* end block 1 */
	// End offset: 0x8003BE4C
	// End Line: 2076

	/* begin block 2 */
		// Start line: 3999
	/* end block 2 */
	// End Line: 4000

	/* begin block 3 */
		// Start line: 4000
	/* end block 3 */
	// End Line: 4001

}


// autogenerated function stub: 
// void /*$ra*/ PIPE3D_HalvePlaneInstanceTransformAndDraw(struct _Instance *instance /*$s2*/, MATRIX *wcTransform /*$s1*/, struct _VertexPool *vertexPool /*$s6*/, struct _PrimPool *primPool /*$s5*/, unsigned long **ot /*stack 16*/, struct _Mirror *mirror /*stack 20*/)
void PIPE3D_HalvePlaneInstanceTransformAndDraw(struct _Instance *instance, MATRIX *wcTransform, struct _VertexPool *vertexPool, struct _PrimPool *primPool, unsigned long **ot, struct _Mirror *mirror)
{ // line 2103, offset 0x8003be54
	/* begin block 1 */
		// Start line: 2104
		// Start offset: 0x8003BE54
		// Variables:
			struct Object *object; // $v1
			struct _Model *model; // $s3
			MATRIX *matrixPool; // $s4
			//MATRIX wpTransform; // stack offset -184
			//MATRIX pwTransform; // stack offset -152
			//MATRIX pcTransform; // stack offset -120
			//MATRIX lm; // stack offset -88
			struct _MVertex *vertexList; // $s7
			struct _SVector normalX; // stack offset -56
			struct _SVector *normal; // $a1
			struct _SVector translation; // stack offset -48
	/* end block 1 */
	// End offset: 0x8003C01C
	// End Line: 2172

	/* begin block 2 */
		// Start line: 4210
	/* end block 2 */
	// End Line: 4211

}


// autogenerated function stub: 
// void /*$ra*/ PIPE3D_HalvePlaneGetRingPoints(struct _Instance *instance /*$a0*/, MATRIX *wcTransform /*$fp*/, struct _VertexPool *vertexPool /*$s6*/, struct _PrimPool *primPool /*$s7*/, unsigned long **ot /*stack 16*/, struct _FXHalvePlane *ring /*stack 20*/)
void PIPE3D_HalvePlaneGetRingPoints(struct _Instance *instance, MATRIX *wcTransform, struct _VertexPool *vertexPool, struct _PrimPool *primPool, unsigned long **ot, struct _FXHalvePlane *ring)
{ // line 2220, offset 0x8003c048
	/* begin block 1 */
		// Start line: 2221
		// Start offset: 0x8003C048
		// Variables:
			struct Object *object; // $v1
			struct _Model *model; // $s1
			MATRIX *matrixPool; // $s3
			//MATRIX wpTransform; // stack offset -152
			//MATRIX pwTransform; // stack offset -120
			//MATRIX pcTransform; // stack offset -88
			struct _MVertex *vertexList; // $s4
			struct _PVertex *poolVertex; // $s5
			struct _SVector normalX; // stack offset -56
			struct _SVector *normal; // $a1
			struct _SVector translation; // stack offset -48
			struct _PlaneConstants *halvePlane; // $a0
	/* end block 1 */
	// End offset: 0x8003C1E8
	// End Line: 2278

	/* begin block 2 */
		// Start line: 4440
	/* end block 2 */
	// End Line: 4441

}


// autogenerated function stub: 
// void /*$ra*/ PIPE3D_DoGlow(struct _Instance *instance /*$s2*/, MATRIX *wcTransform /*$a1*/, struct _VertexPool *vertexPool /*$a2*/, struct _PrimPool *primPool /*$s3*/, unsigned long **ot /*stack 16*/, struct _FXGlowEffect *glow /*stack 20*/)
void PIPE3D_DoGlow(struct _Instance *instance, MATRIX *wcTransform, struct _VertexPool *vertexPool, struct _PrimPool *primPool, unsigned long **ot, struct _FXGlowEffect *glow)
{ // line 2294, offset 0x8003c218
	/* begin block 1 */
		// Start line: 2295
		// Start offset: 0x8003C218
		// Variables:
			long currentColorID; // $a2
			long previousColorID; // $a1
			long value; // $a0
			long fade; // $a3
			long fadeflag; // $s0

		/* begin block 1.1 */
			// Start line: 2325
			// Start offset: 0x8003C400
			// Variables:
				long color; // stack offset -32

			/* begin block 1.1.1 */
				// Start line: 2370
				// Start offset: 0x8003C578
				// Variables:
					long i; // $s0
			/* end block 1.1.1 */
			// End offset: 0x8003C5D4
			// End Line: 2380
		/* end block 1.1 */
		// End offset: 0x8003C5D4
		// End Line: 2381
	/* end block 1 */
	// End offset: 0x8003C5D4
	// End Line: 2382

	/* begin block 2 */
		// Start line: 4588
	/* end block 2 */
	// End Line: 4589

}


// autogenerated function stub: 
// long /*$ra*/ PIPE3D_Segment2ScreenPt(struct _Instance *instance /*$a0*/, MATRIX *wcTransform /*$a1*/, int segIndex /*$a2*/, _Position *pos /*$s0*/)
long PIPE3D_Segment2ScreenPt(struct _Instance *instance, MATRIX *wcTransform, int segIndex, _Position *pos)
{ // line 2388, offset 0x8003c5f4
	/* begin block 1 */
		// Start line: 2389
		// Start offset: 0x8003C5F4
		// Variables:
			//MATRIX scTransform; // stack offset -56
			_Position vOrigin; // stack offset -24
			long face_z; // stack offset -16
	/* end block 1 */
	// End offset: 0x8003C5F4
	// End Line: 2389

	/* begin block 2 */
		// Start line: 4816
	/* end block 2 */
	// End Line: 4817

	return 0;
}




