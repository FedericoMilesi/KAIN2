#include "CORE.H"
#include "SAVEINFO.H"
#include "MEMPACK.H"
#include "PSX/MAIN.H"
#include "GAMELOOP.H"
#include "MCARD/MEMCARD.H"
#include "DEBUG.H"
#include "SAVEINFO.H"
#include "STREAM.H"
#include "STRMLOAD.H"
#include "EVENT.H"

struct _GlobalSaveTracker* GlobalSave;
struct SavedBasic* bufferSavedIntroArray[64];
long numbufferedIntros; // offset 0x800CF8AC
long SaveArraySize[10] = { 0, 40, 16, 8, 834, 4, 120, 32, 12, 10 };

// autogenerated function stub: 
// void /*$ra*/ SAVE_GetInstanceRotation(struct _Instance *instance /*$s0*/, struct _SmallRotation *vector /*$s1*/)
void SAVE_GetInstanceRotation(struct _Instance *instance, struct _SmallRotation *vector)
{ // line 103, offset 0x800b5560
	/* begin block 1 */
		// Start line: 104
		// Start offset: 0x800B5560
		// Variables:
			struct evPositionData *rotation; // $v1
	/* end block 1 */
	// End offset: 0x800B55D4
	// End Line: 121

	/* begin block 2 */
		// Start line: 191
	/* end block 2 */
	// End Line: 192

	/* begin block 3 */
		// Start line: 206
	/* end block 3 */
	// End Line: 207
			UNIMPLEMENTED();
}

void SAVE_ClearMemory(struct GameTracker *gameTracker)
{
	char *buffer;

	buffer = savedInfoTracker.MemoryCardBuffer;

	savedInfoTracker.InfoStart = &buffer[the_header_size];
	savedInfoTracker.InfoEnd = &buffer[the_header_size];
	savedInfoTracker.EndOfMemory = &buffer[24576];

	memset(&savedInfoTracker.MemoryCardBuffer[the_header_size], 0, the_header_size);

	numbufferedIntros = 0;

	memset(bufferSavedIntroArray, 0, sizeof(bufferSavedIntroArray));

	GlobalSave = (struct _GlobalSaveTracker*)SAVE_GetSavedBlock(6, 0);
	GlobalSave->CurrentBirthID = 8192;
	GlobalSave->humanOpinionOfRaziel = 0;


	SAVE_GetSavedBlock(4, 0);
}

void SAVE_Init(struct GameTracker *gt)
{
	void *buffer;

	buffer = MEMPACK_Malloc(24576, 18);

	if (DoMainMenu != 0)
	{
		gt->memcard = &gMemcard;
		the_header_size = memcard_initialize(&gMemcard, gt, 3, buffer, 24576);
	}
	else
	{
		gt->memcard = NULL;
	}

	savedInfoTracker.MemoryCardBuffer = (char*)buffer;
	SAVE_ClearMemory(gt);
}

void* SAVE_GetSavedBlock(long saveType, long extraSize)
{	
	struct SavedBasic *savedInfo;
	long sizeOfSave;
	long done;

	savedInfo = NULL;

	if(saveType >= 10)
	{
		DEBUG_FatalError("illegal save type %d\n", saveType);
	}

	sizeOfSave = ((((SaveArraySize[saveType] + extraSize) + 3) >> 2) << 2);
	done = 0;
	
	if (sizeOfSave >= 1021)
	{
		DEBUG_FatalError("save %d is too big! (type %d)\n", sizeOfSave, saveType);
	}

	do
	{
		if (savedInfoTracker.InfoEnd + sizeOfSave < savedInfoTracker.EndOfMemory)
		{
			savedInfo = (struct SavedBasic*)savedInfoTracker.InfoEnd;

			savedInfoTracker.InfoEnd[0] = saveType;
			savedInfo->shiftedSaveSize = sizeOfSave >> 2;
			savedInfoTracker.InfoEnd += sizeOfSave;
			done = 1;
			break;
		}
		else
		{
			if (SAVE_PurgeAMemoryBlock() == 0)
			{
				done = 1;
				DEBUG_FatalError("ran out of saved memory. needed %d, used %d. increase from % d\n", sizeOfSave, savedInfoTracker.EndOfMemory - savedInfoTracker.InfoEnd, 24576);
			}
		}
	} while (done == 0);

	return savedInfo;
}


// autogenerated function stub: 
// long /*$ra*/ SAVE_PurgeAMemoryBlock()
long SAVE_PurgeAMemoryBlock()
{ // line 237, offset 0x800b5808
	/* begin block 1 */
		// Start line: 238
		// Start offset: 0x800B5808
		// Variables:
			struct SavedBasic *curSave; // $a0
			long result; // $a1
	/* end block 1 */
	// End offset: 0x800B5898
	// End Line: 259

	/* begin block 2 */
		// Start line: 488
	/* end block 2 */
	// End Line: 489
			UNIMPLEMENTED();
	return 0;
}


// autogenerated function stub: 
// long /*$ra*/ SAVE_SaveableInstance(struct _Instance *instance /*$a0*/)
long SAVE_SaveableInstance(struct _Instance *instance)
{ // line 265, offset 0x800b58a8
	/* begin block 1 */
		// Start line: 267
		// Start offset: 0x800B58A8
		// Variables:
			long result; // $a1
	/* end block 1 */
	// End offset: 0x800B599C
	// End Line: 320

	/* begin block 2 */
		// Start line: 551
	/* end block 2 */
	// End Line: 552

	/* begin block 3 */
		// Start line: 552
	/* end block 3 */
	// End Line: 553

	/* begin block 4 */
		// Start line: 554
	/* end block 4 */
	// End Line: 555
			UNIMPLEMENTED();
	return 0;
}


// autogenerated function stub: 
// struct _SavedIntro * /*$ra*/ SAVE_UpdateSavedIntro(struct _Instance *instance /*$s1*/, struct Level *level /*$a1*/, struct _SavedIntro *savedIntro /*$s0*/, struct evControlSaveDataData *extraData /*$s2*/)
struct _SavedIntro* SAVE_UpdateSavedIntro(struct _Instance *instance, struct Level *level, struct _SavedIntro *savedIntro, struct evControlSaveDataData *extraData)
{ // line 471, offset 0x800b59a4
	/* begin block 1 */
		// Start line: 472
		// Start offset: 0x800B59A4
		// Variables:
			_Position *levelOffset; // $t1

		/* begin block 1.1 */
			// Start line: 483
			// Start offset: 0x800B59D4
			// Variables:
				short _x0; // $v0
				short _y0; // $a2
				short _z0; // $v1
				short _x1; // $a3
				short _y1; // $t0
				short _z1; // $t1
				_Position *_v; // $v0
				_Position *_v0; // $v1
		/* end block 1.1 */
		// End offset: 0x800B59D4
		// End Line: 483
	/* end block 1 */
	// End offset: 0x800B5A94
	// End Line: 510

	/* begin block 2 */
		// Start line: 942
	/* end block 2 */
	// End Line: 943
				UNIMPLEMENTED();
	return null;
}


// autogenerated function stub: 
// struct _SavedIntroWithIntro * /*$ra*/ SAVE_UpdateSavedIntroWithIntro(struct _Instance *instance /*$s1*/, struct Level *level /*$a1*/, struct _SavedIntroWithIntro *savedIntro /*$s0*/, struct evControlSaveDataData *extraData /*$s2*/)
struct _SavedIntroWithIntro * SAVE_UpdateSavedIntroWithIntro(struct _Instance *instance, struct Level *level, struct _SavedIntroWithIntro *savedIntro, struct evControlSaveDataData *extraData)
{ // line 513, offset 0x800b5ab0
	/* begin block 1 */
		// Start line: 514
		// Start offset: 0x800B5AB0
		// Variables:
			_Position *levelOffset; // $t1

		/* begin block 1.1 */
			// Start line: 525
			// Start offset: 0x800B5AF0
			// Variables:
				short _x0; // $v0
				short _y0; // $a2
				short _z0; // $v1
				short _x1; // $a3
				short _y1; // $t0
				short _z1; // $t1
				_Position *_v; // $v0
				_Position *_v0; // $v1
		/* end block 1.1 */
		// End offset: 0x800B5AF0
		// End Line: 525
	/* end block 1 */
	// End offset: 0x800B5BCC
	// End Line: 553

	/* begin block 2 */
		// Start line: 916
	/* end block 2 */
	// End Line: 917
				UNIMPLEMENTED();
	return null;
}


// autogenerated function stub: 
// struct SavedBasic * /*$ra*/ SAVE_GetSavedEvent(long areaID /*$a0*/, long eventNumber /*$a1*/)
struct SavedBasic * SAVE_GetSavedEvent(long areaID, long eventNumber)
{ // line 556, offset 0x800b5be8
	/* begin block 1 */
		// Start line: 558
		// Start offset: 0x800B5BE8
		// Variables:
			struct SavedBasic *curSave; // $v1
	/* end block 1 */
	// End offset: 0x800B5C88
	// End Line: 577

	/* begin block 2 */
		// Start line: 1022
	/* end block 2 */
	// End Line: 1023

	/* begin block 3 */
		// Start line: 1023
	/* end block 3 */
	// End Line: 1024

	/* begin block 4 */
		// Start line: 1025
	/* end block 4 */
	// End Line: 1026
			UNIMPLEMENTED();
	return null;
}


// autogenerated function stub: 
// void /*$ra*/ SAVE_DeleteSavedEvent(long areaID /*$a0*/, long eventNumber /*$a1*/)
void SAVE_DeleteSavedEvent(long areaID, long eventNumber)
{ // line 579, offset 0x800b5c90
	/* begin block 1 */
		// Start line: 580
		// Start offset: 0x800B5C90
		// Variables:
			struct SavedBasic *savedEvent; // $v0
	/* end block 1 */
	// End offset: 0x800B5CB0
	// End Line: 589

	/* begin block 2 */
		// Start line: 1068
	/* end block 2 */
	// End Line: 1069
			UNIMPLEMENTED();
}


// autogenerated function stub: 
// struct SavedBasic * /*$ra*/ SAVE_GetSavedNextEvent(long areaID /*$a0*/, struct SavedBasic *curSave /*$a1*/)
struct SavedBasic * SAVE_GetSavedNextEvent(long areaID, struct SavedBasic *curSave)
{ // line 591, offset 0x800b5cc0
	/* begin block 1 */
		// Start line: 1092
	/* end block 1 */
	// End Line: 1093

	/* begin block 2 */
		// Start line: 1093
	/* end block 2 */
	// End Line: 1094
	UNIMPLEMENTED();
	return null;
}


// autogenerated function stub: 
// void /*$ra*/ SAVE_BufferIntro(struct SavedBasic *savedIntro /*$a0*/)
void SAVE_BufferIntro(struct SavedBasic *savedIntro)
{ // line 619, offset 0x800b5d64
	/* begin block 1 */
		// Start line: 621
		// Start offset: 0x800B5D64
		// Variables:
			long i; // $a1
	/* end block 1 */
	// End offset: 0x800B5DDC
	// End Line: 655

	/* begin block 2 */
		// Start line: 1148
	/* end block 2 */
	// End Line: 1149

	/* begin block 3 */
		// Start line: 1149
	/* end block 3 */
	// End Line: 1150

	/* begin block 4 */
		// Start line: 1151
	/* end block 4 */
	// End Line: 1152
			UNIMPLEMENTED();
}

void SAVE_IntroduceBufferIntros()
{
	long i;
	struct _StreamUnit* streamUnit;
	int deleted;

	for (i = 0; numbufferedIntros != 0; i++)
	{
		if (i < 64)
		{
			if (bufferSavedIntroArray[i] != NULL)
			{
				if (bufferSavedIntroArray[i]->savedID == 1)
				{
					streamUnit = STREAM_GetStreamUnitWithID(((struct _SavedIntro*)bufferSavedIntroArray[i])->streamUnitID);

					if (streamUnit != NULL)
					{
						if (INSTANCE_IntroduceSavedInstance((struct _SavedIntro*)bufferSavedIntroArray[i], streamUnit, &deleted) != NULL)
						{
							bufferSavedIntroArray[i] = NULL;
							numbufferedIntros--;
						}
					}
					else
					{
						bufferSavedIntroArray[i] = NULL;
						numbufferedIntros--;
					}
				}
				else
				{
					streamUnit = STREAM_GetStreamUnitWithID(((struct _SavedIntroWithIntro*)bufferSavedIntroArray[i])->birthUnitID);

					if (streamUnit != NULL)
					{
						if (INSTANCE_IntroduceSavedInstanceWithIntro(((struct _SavedIntroWithIntro*)bufferSavedIntroArray[i]), streamUnit, &deleted) != NULL)
						{
							bufferSavedIntroArray[i] = NULL;
							numbufferedIntros--;
						}
					}
					else
					{
						bufferSavedIntroArray[i] = NULL;
						numbufferedIntros--;
					}
				}
			}
		}
	}
}


// autogenerated function stub: 
// void /*$ra*/ SAVE_IntroForStreamID(struct _StreamUnit *streamUnit /*$s2*/)
void SAVE_IntroForStreamID(struct _StreamUnit *streamUnit)
{ // line 716, offset 0x800b5ec0
	/* begin block 1 */
		// Start line: 717
		// Start offset: 0x800B5EC0
		// Variables:
			struct SavedBasic *saveIntro; // $s0
			long streamID; // $s1
			int deleted; // stack offset -24
	/* end block 1 */
	// End offset: 0x800B5F84
	// End Line: 741

	/* begin block 2 */
		// Start line: 1410
	/* end block 2 */
	// End Line: 1411
			UNIMPLEMENTED();
}

long SAVE_HasSavedIntro(struct Intro *intro, long currentStreamID)
{
#if 0
	long result; // $a3
	struct _SavedIntro *saveIntro; // $a1

	saveIntro = (struct _SavedIntro*)saveIntroTracker->InfoStart;
	//v1 = saveIntroTracker->InfoEnd
	result = 0;
	if (saveIntroTracker->InfoStart < saveIntroTracker->InfoEnd)
	{
		//t2 = 1
		//t1 = 7
		//t0 = saveIntroTracker->InfoEnd

		//loc_800B5C48

		if(saveIntro->savedID == 1)
		{
			if(saveIntro->introUniqueID)
		}
		//loc_800B5C6C
	}
	//locret_800B5CAC

		lh      $v1, 0xC($a1)
		lw      $v0, 0x14($a0)
		nop
		beq     $v1, $v0, loc_800B5C88
		nop

		loc_800B5C6C :
	bne     $a2, $t1, loc_800B5C90
		nop
		lh      $v1, 8($a1)
		lw      $v0, 0x14($a0)
		nop
		bne     $v1, $v0, loc_800B5C90
		nop

		loc_800B5C88 :
	j       locret_800B5CAC
		li      $a3, 1

		loc_800B5C90 :
		lbu     $v0, 1($a1)
		nop
		sll     $v0, 2
		addu    $a1, $v0
		sltu    $v0, $a1, $t0
		bnez    $v0, loc_800B5C48
		nop

		locret_800B5CAC :
	jr      $ra
		move    $v0, $a3
#endif
		UNIMPLEMENTED();
	return 0;
}


// autogenerated function stub: 
// struct SavedLevel * /*$ra*/ SAVE_HasSavedLevel(long areaID /*$a0*/)
struct SavedLevel * SAVE_HasSavedLevel(long areaID)
{ // line 795, offset 0x800b602c
	/* begin block 1 */
		// Start line: 797
		// Start offset: 0x800B602C
		// Variables:
			struct SavedLevel *savedLevel; // $v1
	/* end block 1 */
	// End offset: 0x800B6080
	// End Line: 812

	/* begin block 2 */
		// Start line: 1581
	/* end block 2 */
	// End Line: 1582

	/* begin block 3 */
		// Start line: 1582
	/* end block 3 */
	// End Line: 1583

	/* begin block 4 */
		// Start line: 1584
	/* end block 4 */
	// End Line: 1585
			UNIMPLEMENTED();
	return null;
}


// autogenerated function stub: 
// void /*$ra*/ SAVE_UpdateLevelWithSave(struct _StreamUnit *streamUnit /*$s0*/)
void SAVE_UpdateLevelWithSave(struct _StreamUnit *streamUnit)
{ // line 814, offset 0x800b6090
	/* begin block 1 */
		// Start line: 815
		// Start offset: 0x800B6090
		// Variables:
			long i; // $t2
			struct ActualSavedLevel *savedLevel; // $t3
			struct _Terrain *terrain; // $t4
			struct BSPTree *bspTree; // $v1
			long Zoffset; // $s1
	/* end block 1 */
	// End offset: 0x800B61C8
	// End Line: 858

	/* begin block 2 */
		// Start line: 1619
	/* end block 2 */
	// End Line: 1620
			UNIMPLEMENTED();
}


// autogenerated function stub: 
// struct SavedLevel * /*$ra*/ SAVE_CreatedSavedLevel(long areaID /*$s3*/, struct Level *level /*$s2*/)
struct SavedLevel * SAVE_CreatedSavedLevel(long areaID, struct Level *level)
{ // line 860, offset 0x800b61dc
	/* begin block 1 */
		// Start line: 861
		// Start offset: 0x800B61DC
		// Variables:
			struct SavedLevel *savedLevel; // $s0
			struct ActualSavedLevel *slevel; // $a0
			long doSave; // $a1
			long i; // $a1
			struct BSPTree *bspTree; // $v1
			long Zoffset; // $s4

		/* begin block 1.1 */
			// Start line: 881
			// Start offset: 0x800B623C
			// Variables:
				long numBSPTrees; // $s1

			/* begin block 1.1.1 */
				// Start line: 886
				// Start offset: 0x800B6258
			/* end block 1.1.1 */
			// End offset: 0x800B6350
			// End Line: 931
		/* end block 1.1 */
		// End offset: 0x800B6350
		// End Line: 932
	/* end block 1 */
	// End offset: 0x800B6374
	// End Line: 943

	/* begin block 2 */
		// Start line: 1738
	/* end block 2 */
	// End Line: 1739
				UNIMPLEMENTED();
	return null;
}


// autogenerated function stub: 
// void /*$ra*/ SAVE_DeleteBlock(struct SavedBasic *savedBlock /*$a0*/)
void SAVE_DeleteBlock(struct SavedBasic *savedBlock)
{ // line 947, offset 0x800b6398
	/* begin block 1 */
		// Start line: 948
		// Start offset: 0x800B6398
		// Variables:
			long size; // $s0
			char *nextBlock; // $a1

		/* begin block 1.1 */
			// Start line: 960
			// Start offset: 0x800B63C0
			// Variables:
				int i; // $a3
		/* end block 1.1 */
		// End offset: 0x800B63FC
		// End Line: 978
	/* end block 1 */
	// End offset: 0x800B63FC
	// End Line: 980

	/* begin block 2 */
		// Start line: 1932
	/* end block 2 */
	// End Line: 1933
				UNIMPLEMENTED();
}


// autogenerated function stub: 
// void /*$ra*/ SAVE_Instance(struct _Instance *instance /*$s1*/, struct Level *level /*$s3*/)
void SAVE_Instance(struct _Instance *instance, struct Level *level)
{ // line 991, offset 0x800b6424
	/* begin block 1 */
		// Start line: 992
		// Start offset: 0x800B6424
		// Variables:
			struct _SavedIntro *savedIntro; // $v0
			struct evControlSaveDataData *extraData; // $s0
			long extraSize; // $s2
			long saveType; // $v1

		/* begin block 1.1 */
			// Start line: 1003
			// Start offset: 0x800B646C
			// Variables:
				struct SavedIntroSmall *savedSmallIntro; // $a0

			/* begin block 1.1.1 */
				// Start line: 1010
				// Start offset: 0x800B648C
			/* end block 1.1.1 */
			// End offset: 0x800B64A4
			// End Line: 1016
		/* end block 1.1 */
		// End offset: 0x800B64A4
		// End Line: 1016

		/* begin block 1.2 */
			// Start line: 1048
			// Start offset: 0x800B6524
			// Variables:
				struct _SavedIntroWithIntro *savedIntroWithIntro; // $v0
		/* end block 1.2 */
		// End offset: 0x800B6558
		// End Line: 1062

		/* begin block 1.3 */
			// Start line: 1069
			// Start offset: 0x800B6578
			// Variables:
				struct SavedIntroSpline *savedIntroSpline; // $s0

			/* begin block 1.3.1 */
				// Start line: 1076
				// Start offset: 0x800B6598
				// Variables:
					struct MultiSpline *multi; // $a1
			/* end block 1.3.1 */
			// End offset: 0x800B663C
			// End Line: 1096
		/* end block 1.3 */
		// End offset: 0x800B663C
		// End Line: 1097
	/* end block 1 */
	// End offset: 0x800B663C
	// End Line: 1102

	/* begin block 2 */
		// Start line: 2041
	/* end block 2 */
	// End Line: 2042
					UNIMPLEMENTED();
}


// autogenerated function stub: 
// void /*$ra*/ SAVE_DeleteInstance(struct _Instance *instance /*$a2*/)
void SAVE_DeleteInstance(struct _Instance *instance)
{ // line 1104, offset 0x800b6658
	/* begin block 1 */
		// Start line: 1105
		// Start offset: 0x800B6658
		// Variables:
			struct SavedBasic *saveIntro; // $a0
	/* end block 1 */
	// End offset: 0x800B6718
	// End Line: 1132

	/* begin block 2 */
		// Start line: 2270
	/* end block 2 */
	// End Line: 2271
			UNIMPLEMENTED();
}


// autogenerated function stub: 
// void /*$ra*/ SAVE_SetDeadDeadBit(int uniqueID /*$a0*/, long set /*$a1*/)
void SAVE_SetDeadDeadBit(int uniqueID, long set)
{ // line 1134, offset 0x800b6728
	/* begin block 1 */
		// Start line: 1136
		// Start offset: 0x800B6728
		// Variables:
			struct _SavedIntro *saveIntro; // $a2
			struct SavedDeadDeadBits *deadDeadBits; // $v1

		/* begin block 1.1 */
			// Start line: 1155
			// Start offset: 0x800B6784
			// Variables:
				int deadByte; // $a2
				int deadBit; // $a0
		/* end block 1.1 */
		// End offset: 0x800B67E4
		// End Line: 1177
	/* end block 1 */
	// End offset: 0x800B67E4
	// End Line: 1180

	/* begin block 2 */
		// Start line: 2336
	/* end block 2 */
	// End Line: 2337

	/* begin block 3 */
		// Start line: 2337
	/* end block 3 */
	// End Line: 2338

	/* begin block 4 */
		// Start line: 2340
	/* end block 4 */
	// End Line: 2341
				UNIMPLEMENTED();
}


// autogenerated function stub: 
// void /*$ra*/ SAVE_RestoreGlobalSavePointer()
void SAVE_RestoreGlobalSavePointer()
{ // line 1182, offset 0x800b67ec
	/* begin block 1 */
		// Start line: 1184
		// Start offset: 0x800B67EC
		// Variables:
			struct _SavedIntro *saveIntro; // $v1
	/* end block 1 */
	// End offset: 0x800B683C
	// End Line: 1199

	/* begin block 2 */
		// Start line: 2449
	/* end block 2 */
	// End Line: 2450

	/* begin block 3 */
		// Start line: 2450
	/* end block 3 */
	// End Line: 2451

	/* begin block 4 */
		// Start line: 2453
	/* end block 4 */
	// End Line: 2454
			UNIMPLEMENTED();
}

long SAVE_IsUniqueIDDeadDead(long uniqueID)
{
	struct _SavedIntro* saveIntro;
	struct SavedDeadDeadBits* deadDeadBits;
	long result;
	int deadByte;
	int deadBit;

	deadDeadBits = NULL;

	result = 0;

	if (uniqueID >= 0x2000)
	{
		saveIntro = (struct _SavedIntro*)savedInfoTracker.InfoStart;

		while ((char*)saveIntro < savedInfoTracker.InfoEnd)
		{
			if (saveIntro->savedID == 4)
			{
				deadDeadBits = (struct SavedDeadDeadBits*)saveIntro;
				break;
			}

			saveIntro = (struct _SavedIntro*)((char*)saveIntro + (saveIntro->shiftedSaveSize << 2));
		}

		if (deadDeadBits != NULL)
		{
			deadByte = ((uniqueID < 0 ? uniqueID + 7 : uniqueID) >> 3);

			deadBit = (1 << (uniqueID & 0x7));

			if (deadByte < 832)
			{
				result = (unsigned)((deadDeadBits->deadDeadBits[deadByte] & deadBit) ^ deadBit) < 1;
			}
		}
	}

	return result;
}

long SAVE_IsIntroDeadDead(struct Intro* intro)
{
	return SAVE_IsUniqueIDDeadDead(intro->UniqueID);
}


// autogenerated function stub: 
// void /*$ra*/ SAVE_DoInstanceDeadDead(struct _Instance *instance /*$s0*/)
void SAVE_DoInstanceDeadDead(struct _Instance *instance)
{ // line 1249, offset 0x800b6914
	/* begin block 1 */
		// Start line: 2585
	/* end block 1 */
	// End Line: 2586
	UNIMPLEMENTED();
}


// autogenerated function stub: 
// void /*$ra*/ SAVE_MarkDeadDead(struct _Instance *instance /*$a0*/)
void SAVE_MarkDeadDead(struct _Instance *instance)
{ // line 1259, offset 0x800b6944
#if defined(PC_VERSION)
	instance->flags |= 0x800000;
#else
	UNIMPLEMENTED();
#endif
}


// autogenerated function stub: 
// void /*$ra*/ SAVE_UndestroyInstance(struct _Instance *instance /*$a0*/)
void SAVE_UndestroyInstance(struct _Instance *instance)
{ // line 1264, offset 0x800b6958
#if defined(PC_VERSION)
	BYTE* v1; // edi
	int introUniqueID; // esi
	BYTE* v3; // eax

	v1 = 0;
	introUniqueID = instance->introUniqueID;
	if (introUniqueID < 0x2000)
	{
		v3 = dword_C55294;
		if ((unsigned int)dword_C55294 < dword_C55298)
		{
			while (*v3 != 4)
			{
				v3 += 4 * (unsigned __int8)v3[1];
				if ((unsigned int)v3 >= dword_C55298)
					goto LABEL_7;
			}
			v1 = v3;
		}
	LABEL_7:
		if (v1)
		{
			if (introUniqueID / 8 >= 832)
				GXFilePrint("Ran out of dead bits, size = %d, uniqueID = %d\n", 832, instance->introUniqueID);
			else
				v1[introUniqueID / 8 + 2] &= ~(unsigned __int8)(1 << (instance->introUniqueID & 7));
		}
	}
#else
	UNIMPLEMENTED();
#endif
}

struct SavedIntroSmall * SAVE_GetSavedSmallIntro(struct _Instance *instance)
{
#if defined(PSX_VERSION)
	struct SavedBasic* curSave;

	curSave = (struct SavedBasic*)savedInfoTracker.InfoStart;
	
	while ((char*)curSave < savedInfoTracker.InfoEnd)
	{
		if (curSave->savedID == 2)
		{
			if (((struct SavedIntroSmall*)curSave)->introUniqueID == instance->introUniqueID)
			{
				return (struct SavedIntroSmall*)curSave;
			}
		}
		curSave = (struct SavedBasic*)((char*)curSave + (curSave->shiftedSaveSize << 2));
	}

	return NULL;

#elif defined(PC_VERSION)
	struct SavedIntroSmall* result; // eax

	result = dword_C55294;
	if (dword_C55294 >= dword_C55298)
		return 0;
	while (result->savedID != 5 || result->introUniqueID != instance->introUniqueID)
	{
		result += result->shiftedSaveSize;
		if (result >= dword_C55298)
			return 0;
	}
	return result;
#endif
}


// autogenerated function stub: 
// struct SavedIntroSpline * /*$ra*/ SAVE_GetIntroSpline(struct _Instance *instance /*$a0*/)
struct SavedIntroSpline * SAVE_GetIntroSpline(struct _Instance *instance)
{ // line 1291, offset 0x800b69e8
#if defined(PC_VERSION)
	struct SavedIntroSpline* result; // eax

	result = (struct SavedIntroSpline*)dword_C55294;
	if (dword_C55294 >= dword_C55298)
		return 0;
	while (result->savedID != 8 || result->introUniqueID != instance->introUniqueID)
	{
		result = (struct SavedIntroSpline*)((char*)result + 4 * result->shiftedSaveSize);
		if (result >= (struct SavedIntroSpline*)dword_C55298)
			return 0;
	}
	return result;
#else
	UNIMPLEMENTED();
	return NULL;
#endif
}


// autogenerated function stub: 
// void /*$ra*/ SAVE_UpdateGlobalSaveTracker()
void SAVE_UpdateGlobalSaveTracker()
{ 
#if 0
	ub_800B66DC:

	var_s0 = 0

		lw      $v1, -0x57C0($gp)
		lw      $v0, -0x400C($gp)
		addiu   $sp, -0x18
		sw      $ra, 0x10 + var_s0($sp)
		sw      $v0, 8($v1)
		addiu   $a3, $gp, -0x4088
		lw      $a0, 0($a3)
		lw      $a1, 4($a3)
		lw      $a2, 8($a3)
		sw      $a0, 0x60($v1)
		sw      $a1, 0x64($v1)
		sw      $a2, 0x68($v1)
		lw      $a0, 0xC($a3)
		lw      $a1, 0x10($a3)
		sw      $a0, 0x6C($v1)
		sw      $a1, 0x70($v1)
		lw      $v1, -0x57C0($gp)
		li      $v0, 0x5521
		jal     sub_8003160C
		sh      $v0, 6($v1)
		beqz    $v0, loc_800B6748
		nop
		lw      $v1, -0x57C0($gp)
		nop
		lhu     $v0, 4($v1)
		j       loc_800B675C
		ori     $v0, 2

		loc_800B6748:
	lw      $v1, -0x57C0($gp)
		nop
		lhu     $v0, 4($v1)
		nop
		andi    $v0, 0xFFFD

		loc_800B675C :
		sh      $v0, 4($v1)
		lw      $ra, 0x10 + var_s0($sp)
		nop
		jr      $ra
		addiu   $sp, 0x18
#endif
}


// autogenerated function stub: 
// void /*$ra*/ SAVE_RestoreGlobalSaveTracker()
void SAVE_RestoreGlobalSaveTracker()
{ // line 1326, offset 0x800b6ae8
	/* begin block 1 */
		// Start line: 2740
	/* end block 1 */
	// End Line: 2741

	/* begin block 2 */
		// Start line: 2742
	/* end block 2 */
	// End Line: 2743
	UNIMPLEMENTED();
}

void SAVE_SaveEverythingInMemory()
{ 
	struct _Instance* instance;
	long i;
	struct _Instance* next;
	struct Level* level;
	
	instance = gameTrackerX.instanceList->first;
	next = NULL;

	while (instance != NULL)
	{
		next = instance->next;
		level = STREAM_GetLevelWithID(instance->currentStreamUnitID);

		if (level != NULL)
		{
			SAVE_Instance(instance, level);
		}

		instance = next;
		next = NULL;
	}

	for (i = 0; i < 16; i++)
	{
		if (StreamTracker.StreamList[i].used == 2)
		{
			EVENT_SaveEventsFromLevel(StreamTracker.StreamList[i].StreamUnitID, StreamTracker.StreamList[i].level);
			
			SAVE_CreatedSavedLevel(StreamTracker.StreamList[i].StreamUnitID, StreamTracker.StreamList[i].level);
		}
	}
}

void SAVE_SaveGame()
{
#if defined(PSX_VERSION)
	while (STREAM_PollLoadQueue() == 0)
	{
	}

	SAVE_SaveEverythingInMemory();

	SAVE_UpdateGlobalSaveTracker();

	GlobalSave->sizeUsedInBlock = ((unsigned short*)&savedInfoTracker.InfoEnd)[0] - ((unsigned short*)&savedInfoTracker.InfoStart)[0];

#elif defined(PC_VERSION)
	int v0; // esi
	int v1; // edi
	int LevelWithID; // eax
	DWORD* v3; // esi
	SavedIntroSmall* result; // eax

	while (STREAM_PollLoadQueue())
		ASLD_FinishLoading();
	v0 = (_Instance*)*((DWORD*)gameTrackerX.instanceList + 1);
	if (v0)
	{
		do
		{
			v1 = v0->next;
			LevelWithID = STREAM_GetLevelWithID(v0->currentStreamUnitID);
			if (LevelWithID)
				SAVE_Instance(v0, LevelWithID);
			v0 = v1;
		} while (v1);
	}
	v3 = &StreamTracker;
	do
	{
		if (*((WORD*)v3 + 2) == 2)
		{
			EVENT_SaveEventsFromLevel(*v3, v3[2]);
			SAVE_CreatedSavedLevel(*v3, v3[2]);
		}
		v3 += 16;
	} while ((int)v3 < (int)&MORPH_SavedLevel);
	GlobalSave->currentTime = dword_C66F4C;
	memcpy(&GlobalSave->sound, &dword_C66ED0, sizeof(GlobalSave->sound));
	GlobalSave->saveVersion = 21797;
	if (GAMEPAD_DualShockEnabled())
		GlobalSave->flags |= 2u;
	else
		GlobalSave->flags &= ~2;
	result = dword_C55294;
	GlobalSave->sizeUsedInBlock = (WORD)dword_C55298 - (WORD)dword_C55294;
	return result;
#else
	UNIMPLEMENTED();
	return;
#endif
}


// autogenerated function stub: 
// void /*$ra*/ SAVE_RestoreGame()
void SAVE_RestoreGame()
{ // line 1406, offset 0x800b6cb8
#if defined(PC_VERSION)
	SavedIntroSmall* v0; // eax
	SavedIntroSmall* v1; // esi

	v0 = dword_C55294;
	dword_C66E64 |= 0x200000u;
	v1 = 0;
	GlobalSave = 0;
	if (dword_C55294 < dword_C55298)
	{
		while (v0->savedID != 6)
		{
			v0 += v0->shiftedSaveSize;
			if (v0 >= dword_C55298)
				goto LABEL_6;
		}
		v1 = v0;
		GlobalSave = (_GlobalSaveTracker*)v0;
	}
LABEL_6:
	if (v1[1].introUniqueID == 21797)
	{
		dword_C66F4C = (int)v1[2];
		memcpy(&dword_C66ED0, &v1[24], 0x14u);
		SOUND_SetSfxVolume(dword_C66ED8);
		SOUND_SetMusicVolume(dword_C66ED4);
		SOUND_SetVoiceVolume(dword_C66EDC);
		if ((GlobalSave->flags & 2) != 0)
			GAMEPAD_EnableDualShock();
		else
			GAMEPAD_DisableDualShock();
	}
	else
	{
		GXFilePrint(`string');
		dword_C5529C = dword_C55290 + 24576;
		dword_C55294 = (SavedIntroSmall*)(dword_C552A8 + dword_C55290);
		dword_C55298 = (SavedIntroSmall*)(dword_C552A8 + dword_C55290);
		memset(
			(void*)(dword_C552A8 + dword_C55290),
			0,
			4 * ((unsigned int)(24576 - dword_C552A8) >> 2) + (-(char)dword_C552A8 & 3));
		memset(&dword_C55190, 0, 0x100u);
		dword_C552A4 = 0;
		GlobalSave = (_GlobalSaveTracker*)SAVE_GetSavedBlock(6, 0);
		GlobalSave->CurrentBirthID = 0x2000;
		GlobalSave->humanOpinionOfRaziel = 0;
		SAVE_GetSavedBlock(4, 0);
	}
	dword_C55298 = (SavedIntroSmall*)((char*)dword_C55294 + GlobalSave->sizeUsedInBlock);
	GAMELOOP_RequestLevelChange(aUnder, 1, &gameTrackerX);
#else
	UNIMPLEMENTED();
#endif
}


// autogenerated function stub: 
// long /*$ra*/ SAVE_SizeOfFreeSpace()
long SAVE_SizeOfFreeSpace()
{ // line 1500, offset 0x800b6d1c
	/* begin block 1 */
		// Start line: 3000
	/* end block 1 */
	// End Line: 3001

	/* begin block 2 */
		// Start line: 3035
	/* end block 2 */
	// End Line: 3036
	UNIMPLEMENTED();
	return 0;
}




