#include "Game/CORE.H"
#include "ANMDECMP.H"

// autogenerated function stub: 
// void /*$ra*/ _G2Anim_DecompressChannel_AdaptiveDelta(struct _G2AnimDecompressChannelInfo_Type *dcInfo /*$a0*/, struct _G2AnimChanStatus_Type *status /*$a1*/)
void _G2Anim_DecompressChannel_AdaptiveDelta(struct _G2AnimDecompressChannelInfo_Type *dcInfo, struct _G2AnimChanStatus_Type *status)
{ // line 135, offset 0x800900f4
#if defined(PSX_VERSION)
	UNIMPLEMENTED();
#elif defined(PC_VERSION)
	struct _G2AnimChanStatus_Type* v2; // ebx
	struct _G2AnimDecompressChannelInfo_Type* v3; // edi
	int storedKey; // edx
	u_short* v5; // eax
	int v6; // ecx
	int index; // esi
	unsigned __int16 v8; // bp
	unsigned __int16 v9; // ax
	unsigned __int16 v10; // cx
	int v11; // eax
	int keyData; // [esp+14h] [ebp-10h]

	v2 = status;
	v3 = dcInfo;
	storedKey = dcInfo->storedKey;
	v5 = dcInfo->chanData + 2;
	v6 = dcInfo->keylist->keyCount + 3;
	keyData = status->keyData;
	index = status->index;
	if (storedKey < dcInfo->targetKey)
	{
		while (1)
		{
			++storedKey;
			v8 = word_4F4AE0[2 * index];
			v9 = (v5[storedKey >> 2] >> (4 * (storedKey & 3))) & 0xF;
			index += dword_4F4AA0[v9];
			if (index < 0)
				index = 0;
			if (index > 63)
				index = 63;
			v10 = v8 >> 3;
			if ((v9 & 4) != 0)
				v10 += v8;
			if ((v9 & 2) != 0)
				v10 += v8 >> 1;
			if ((v9 & 1) != 0)
				v10 += (v8 >> 2) + (v8 & 1);
			v11 = (v9 & 8) != 0 ? keyData - v10 : v10 + keyData;
			keyData = v11;
			if (storedKey >= dcInfo->targetKey)
				break;
			v5 = dcInfo->chanData + 2;
		}
		v2 = status;
		v6 = dcInfo->keylist->keyCount + 3;
		v5 = dcInfo->chanData + 2;
		v3 = dcInfo;
	}
	v2->index = index;
	v2->keyData = keyData;
	v3->chanData = &v5[v6 >> 2];
#endif
}


// autogenerated function stub: 
// void /*$ra*/ _G2Anim_DecompressChannel_Linear(struct _G2AnimDecompressChannelInfo_Type *dcInfo /*$a0*/, struct _G2AnimChanStatus_Type *status /*$a1*/)
void _G2Anim_DecompressChannel_Linear(struct _G2AnimDecompressChannelInfo_Type *dcInfo, struct _G2AnimChanStatus_Type *status)
{ // line 198, offset 0x80090220
	/* begin block 1 */
		// Start line: 201
		// Start offset: 0x80090220
		// Variables:
			unsigned short *chanData; // $a2
			short rangeBase; // $t0
			short rangeInfo; // $v0
			int rangeLength; // $v1
			int rangeOffset; // $a0
			int targetKey; // $a3
	/* end block 1 */
	// End offset: 0x80090288
	// End Line: 232

	/* begin block 2 */
		// Start line: 412
	/* end block 2 */
	// End Line: 413

	/* begin block 3 */
		// Start line: 414
	/* end block 3 */
	// End Line: 415

	/* begin block 4 */
		// Start line: 423
	/* end block 4 */
	// End Line: 424
	UNIMPLEMENTED();
}

void _G2Anim_InitializeChannel_AdaptiveDelta(struct _G2AnimDecompressChannelInfo_Type* dcInfo, struct _G2AnimChanStatus_Type* status)
{
#if defined(PSX_VERSION)
	unsigned short* chanData;
	int keyCount;

	chanData = dcInfo->chanData;
	keyCount = dcInfo->keylist->keyCount;

	status->index = ((unsigned char*)chanData)[0];
	
	status->keyData = chanData[1];
	
	dcInfo->chanData = &chanData[((status->index + 3) >> 2) + 2];

#elif defined(PC_VERSION)
	u_short* chanData; // eax
	int v3; // ecx

	chanData = dcInfo->chanData;
	v3 = (dcInfo->keylist->keyCount + 3) >> 2;
	status->index = *(unsigned __int8*)chanData;
	status->keyData = chanData[1];
	dcInfo->chanData = &chanData[v3 + 2];
#endif
}

void _G2Anim_InitializeChannel_Linear(struct _G2AnimDecompressChannelInfo_Type* dcInfo, struct _G2AnimChanStatus_Type* status)
{
#if defined(PSX_VERSION)
	unsigned short* chanData;
	int chanLength;

	chanData = dcInfo->chanData;

	chanLength = chanData[0] & 0xFFF;

	status->keyData = chanData[1];

	dcInfo->chanData = &chanData[chanLength + 1];

#elif defined(PC_VERSION)
	u_short* chanData; // ecx
	int v3; // eax

	chanData = dcInfo->chanData;
	v3 = *chanData & 0xFFF;
	status->keyData = chanData[1];
	dcInfo->chanData = &chanData[v3 + 1];
#endif
}
