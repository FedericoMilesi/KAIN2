#include "CORE.H"
#include "UNDRWRLD.H"
#include "GAMELOOP.H"
#include "STREAM.H"
#include "MEMPACK.H"
#include "PSX/MAIN.H"

struct UW_ScreenXY* ScreenMorphArray;
long UW_angle;
long UW_scalex;
long UW_scalexInc;
long UW_angleInc;

void UNDERWORLD_StartProcess()
{ 
	INSTANCE_Post(gameTrackerX.playerInstance, 0x40001, 0);

	STREAM_DumpAllLevels(gameTrackerX.playerInstance->currentStreamUnitID, 1);

	UNDERWORLD_InitDisplayProcess();

	UNDERWORLD_LoadLevel("under1", &gameTrackerX);

	if (ScreenMorphArray != NULL)
	{
		MEMPACK_Free((char*)ScreenMorphArray);

		ScreenMorphArray = NULL;
	}
}


// autogenerated function stub: 
// long /*$ra*/ UNDERWORLD_RotateScreenStep(long time /*$s1*/)
long UNDERWORLD_RotateScreenStep(long time)
{ // line 93, offset 0x800b4c14
	/* begin block 1 */
		// Start line: 94
		// Start offset: 0x800B4C14
		// Variables:
			int row; // $t2
			int col; // $a3
			int sinAngle; // $s0
			int cosAngle; // $t3
			int hx; // $v1
			int hy; // $v0

		/* begin block 1.1 */
			// Start line: 109
			// Start offset: 0x800B4C74
			// Variables:
				struct UW_ScreenXY *p; // $a0
				int scaleY; // $t0
		/* end block 1.1 */
		// End offset: 0x800B4C74
		// End Line: 109
	/* end block 1 */
	// End offset: 0x800B4D68
	// End Line: 132

	/* begin block 2 */
		// Start line: 186
	/* end block 2 */
	// End Line: 187

	/* begin block 3 */
		// Start line: 192
	/* end block 3 */
	// End Line: 193

	return 0;
}


// autogenerated function stub: 
// void /*$ra*/ UNDERWORLD_DoUV(unsigned char *uv /*$a0*/, struct UW_ScreenXY *p0 /*$a1*/, int tx /*$a2*/)
void UNDERWORLD_DoUV(unsigned char *uv, struct UW_ScreenXY *p0, int tx)
{ // line 168, offset 0x800b4d80
	/* begin block 1 */
		// Start line: 170
		// Start offset: 0x800B4D80
		// Variables:
			int u; // $v1
	/* end block 1 */
	// End offset: 0x800B4DC4
	// End Line: 180

	/* begin block 2 */
		// Start line: 371
	/* end block 2 */
	// End Line: 372

	/* begin block 3 */
		// Start line: 372
	/* end block 3 */
	// End Line: 373

}


// autogenerated function stub: 
// struct POLY_GT3 * /*$ra*/ UNDERWORLD_Poly(struct POLY_GT3 *last /*$s4*/, struct UW_ScreenXY *p0 /*$a1*/, struct UW_ScreenXY *p1 /*$s3*/, struct UW_ScreenXY *p2 /*$s2*/, int drawY /*stack 16*/)
POLY_GT3 * UNDERWORLD_Poly(POLY_GT3 *last, struct UW_ScreenXY *p0, struct UW_ScreenXY *p1, struct UW_ScreenXY *p2, int drawY)
{ // line 182, offset 0x800b4dcc
	/* begin block 1 */
		// Start line: 183
		// Start offset: 0x800B4DCC
		// Variables:
			int tx; // $s0
			POLY_GT3 *poly; // $s1
			int col; // $v1
	/* end block 1 */
	// End offset: 0x800B4E54
	// End Line: 188

	/* begin block 2 */
		// Start line: 399
	/* end block 2 */
	// End Line: 400

	return null;
}


// autogenerated function stub: 
// void /*$ra*/ UNDERWORLD_DisplayFrame(long *primStart /*$a0*/, long drawY /*$s7*/)
void UNDERWORLD_DisplayFrame(long *primStart, long drawY)
{ // line 229, offset 0x800b4f44
	/* begin block 1 */
		// Start line: 230
		// Start offset: 0x800B4F44
		// Variables:
			long row; // $s5
			long col; // $s0
			long d; // $v0
			struct UW_ScreenXY *p0; // $s2
			struct UW_ScreenXY *p1; // $s1
			struct UW_ScreenXY *p2; // $s3
			struct UW_ScreenXY *p3; // $s4
			//struct POLY_GT3 *poly; // $a1
			//struct POLY_GT3 *terminator; // $fp
	/* end block 1 */
	// End offset: 0x800B5050
	// End Line: 274

	/* begin block 2 */
		// Start line: 535
	/* end block 2 */
	// End Line: 536

}

void UNDERWORLD_SetupSource()
{ 
	PSX_RECT rect;
	DR_STP stp;

	ContinueDraw((unsigned long*)&stp, (unsigned long*)1);

	DrawPrim(&stp);

	rect.w = SCREEN_WIDTH;
	rect.x = 0;
	rect.h = SCREEN_HEIGHT;
	rect.y = gameTrackerX.gameData.asmData.dispPage << 8;

	MoveImage(&rect, 0, (gameTrackerX.gameData.asmData.dispPage ^ 1) << 8);

	ContinueDraw((unsigned long*)&stp, (unsigned long*)0);

	DrawPrim(&stp);

	DrawSync(0);

	PutDrawEnv(&draw[gameTrackerX.gameData.asmData.dispPage]);
}

void UNDERWORLD_InitDisplayProcess()
{
	int row;
	int col;
	struct UW_ScreenXY* p;

#if !defined(PSXPC_VERSION)
	while (CheckVolatile(gameTrackerX.drawTimerReturn) != 0)
	{

	}

	while (CheckVolatile(gameTrackerX.reqDisp) != 0)
	{

	}
#endif

	ScreenMorphArray = (struct UW_ScreenXY*)MEMPACK_Malloc(sizeof(UW_ScreenXY) * 9, 0x18);
	
	for (row = 0; row < 3; row++)
	{
		p = ScreenMorphArray + (row * 3);

		for (col = 0; col < 3; col++, p++)
		{
			p->sx = 1 + (col * 254);
			p->sy = 1 + (row * 119);
		}
	}

	UW_scalex = 4096;
	UW_scalexInc = 32;
	UW_angle = 0;
	UW_angleInc = 8;

	UNDERWORLD_SetupSource();
}


// autogenerated function stub: 
// struct _StreamUnit * /*$ra*/ UNDERWORLD_LoadLevel(char *baseAreaName /*$s0*/, struct GameTracker *gameTracker /*$s4*/)
struct _StreamUnit * UNDERWORLD_LoadLevel(char *baseAreaName, struct GameTracker *gameTracker)
{ // line 331, offset 0x800b5208
	/* begin block 1 */
		// Start line: 332
		// Start offset: 0x800B5208
		// Variables:
			struct _SVector offset; // stack offset -72
			struct _StreamUnit *streamUnit; // $s3
			long i; // $s1
			long UW_time; // $s2

		/* begin block 1.1 */
			// Start line: 368
			// Start offset: 0x800B52B8
			// Variables:
				short _x1; // $v1
				short _y1; // $a0
				short _z1; // $a1
				struct _SVector *_v0; // $v0
				_Position *_v1; // $v0
		/* end block 1.1 */
		// End offset: 0x800B52B8
		// End Line: 368

		/* begin block 1.2 */
			// Start line: 419
			// Start offset: 0x800B5444
			// Variables:
				//struct POLY_F4 poly; // stack offset -64
				//struct DR_TPAGE tpage; // stack offset -40
		/* end block 1.2 */
		// End offset: 0x800B54D0
		// End Line: 439
	/* end block 1 */
	// End offset: 0x800B54D0
	// End Line: 452

	/* begin block 2 */
		// Start line: 830
	/* end block 2 */
	// End Line: 831

	return null;
}


// autogenerated function stub: 
// void /*$ra*/ UNDERWORLD_UpdatePlayer(struct Intro *playerIntro /*$a0*/, struct _Instance *instance /*$a2*/)
void UNDERWORLD_UpdatePlayer(struct Intro *playerIntro, struct _Instance *instance)
{ // line 461, offset 0x800b5500
	/* begin block 1 */
		// Start line: 462
		// Start offset: 0x800B5500
		// Variables:
			struct _SVector offset; // stack offset -16

		/* begin block 1.1 */
			// Start line: 462
			// Start offset: 0x800B5500
			// Variables:
				short _x0; // $v0
				short _y0; // $v1
				short _z0; // $a0
				short _x1; // $a1
				short _y1; // $t0
				short _z1; // $a3
				struct _SVector *_v; // $a1
				_Position *_v0; // $a1
				_Position *_v1; // $a3
		/* end block 1.1 */
		// End offset: 0x800B5500
		// End Line: 462
	/* end block 1 */
	// End offset: 0x800B5500
	// End Line: 462

	/* begin block 2 */
		// Start line: 1127
	/* end block 2 */
	// End Line: 1128

}




