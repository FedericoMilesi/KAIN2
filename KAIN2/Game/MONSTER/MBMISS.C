#include "Game/CORE.H"
#include "MONSTER.H"
#include "MBMISS.H"
#include "Game/COLLIDE.H"
#include "Game/PHYSOBS.H"
#include <Game/STATE.H>
#include <Game/MATH3D.H>

void WCBEGG_Message(struct _Instance* instance, unsigned long message, unsigned long data)  // Matching - 99.88%
{
	struct PhysObData* pod;

	if (message == 0x800002)
	{
		if (instance->processFunc != WCBEGG_Process)
		{
			return;
		}

		pod = (struct PhysObData*)instance->extraData;

		pod->physObTimer = MON_GetTime(instance);

		G2EmulationInstanceSwitchAnimationAlpha(instance, 0, 1, 0, 0, 2, 0);
	}

	PhysicalObjectPost(instance, message, data);
}


int WCBEGG_ShouldIgniteEgg(struct _Instance* egg, struct _walbossAttributes* wa)  // Matching - 100%
{
	struct _InstanceList* instanceList;
	struct _Instance* instance;

	instanceList = gameTrackerX.instanceList;

	if (!(INSTANCE_Query(egg, 3) & 0x10000))
	{
		instance = instanceList->first;

		while (instance != NULL)
		{
			if ((INSTANCE_Query(instance, 1) & 0x20)
				&& (MATH3D_LengthXYZ(instance->position.x - egg->position.x, instance->position.y - egg->position.y,
					instance->position.z - egg->position.z) < wa->eggIgniteDist))
			{
				if ((INSTANCE_Query(instance, 3) & 0x10000))
				{
					return 1;
				}

				if ((strcmpi(instance->object->name, "walfire_") == 0))
				{
					return 1;
				}
			}

			instance = instance->next;
		}
	}

	return 0;
}


// autogenerated function stub: 
// void /*$ra*/ WCBEGG_Process(struct _Instance *instance /*$s1*/, struct GameTracker *gameTracker /*$s6*/)
void WCBEGG_Process(struct _Instance *instance, struct GameTracker *gameTracker)
{ // line 178, offset 0x8008f144
	/* begin block 1 */
		// Start line: 179
		// Start offset: 0x8008F144
		// Variables:
			struct PhysObData *data; // $s5
			int time; // $s2
			int lastTime; // $s4
			int timeBetween; // $s0
			int birthTime; // $a0
			struct Object *walboss; // $v0
			struct _walbossAttributes *wa; // $s3
	/* end block 1 */
	// End offset: 0x8008F310
	// End Line: 239

	/* begin block 2 */
		// Start line: 371
	/* end block 2 */
	// End Line: 372
			UNIMPLEMENTED();
}


// autogenerated function stub: 
// void /*$ra*/ WCBEGG_ExplodeProcess(struct _Instance *instance /*$s0*/, struct GameTracker *gameTracker /*$s3*/)
void WCBEGG_ExplodeProcess(struct _Instance *instance, struct GameTracker *gameTracker)
{ // line 241, offset 0x8008f338
	/* begin block 1 */
		// Start line: 242
		// Start offset: 0x8008F338
		// Variables:
			struct PhysObData *data; // $s1
			int currentTime; // $s2
			int time; // $v0
			struct Object *walboss; // $v1
			struct _walbossAttributes *wa; // $v1
	/* end block 1 */
	// End offset: 0x8008F45C
	// End Line: 289

	/* begin block 2 */
		// Start line: 506
	/* end block 2 */
	// End Line: 507
			UNIMPLEMENTED();
}


// autogenerated function stub: 
// void /*$ra*/ WCBEGG_SplitProcess(struct _Instance *instance /*$s0*/, struct GameTracker *gameTracker /*$s3*/)
void WCBEGG_SplitProcess(struct _Instance *instance, struct GameTracker *gameTracker)
{ // line 291, offset 0x8008f478
	/* begin block 1 */
		// Start line: 292
		// Start offset: 0x8008F478
		// Variables:
			struct PhysObData *data; // $s1
			int currentTime; // $s2
			int time; // $v0
			struct Object *walboss; // $v1
			struct _walbossAttributes *wa; // $v1
	/* end block 1 */
	// End offset: 0x8008F558
	// End Line: 333

	/* begin block 2 */
		// Start line: 610
	/* end block 2 */
	// End Line: 611
			UNIMPLEMENTED();
}


void WCBEGG_CommonPostProcess(struct _Instance* instance, struct GameTracker* gameTracker)  // Matching - 99.86%
{
	struct PhysObData* data;

	data = (struct PhysObData*)instance->extraData;

	INSTANCE_Post(gameTrackerX.playerInstance, 0x40003, SetActionPlayHostAnimationData(gameTrackerX.playerInstance, instance, 6, 0, 0, 2));

	instance->processFunc = WCBEGG_CommonPostProcess2;

	data->physObTimer = MON_GetTime(instance);

	ProcessPhysicalObject(instance, gameTracker);
}


void WCBEGG_CommonPostProcess2(struct _Instance* instance, struct GameTracker* gameTracker) // Matching - 99.83%
{
	struct PhysObData* data;
	int time;

	data = (struct PhysObData*)instance->extraData;

	time = 3960;

	if ((long)MON_GetTime(instance) >= (data->physObTimer + time))
	{
		INSTANCE_UnlinkFromParent(instance);

		INSTANCE_KillInstance(instance);
	}
	else
	{
		ProcessPhysicalObject(instance, gameTracker);
	}
}


// autogenerated function stub: 
// void /*$ra*/ WCBEGG_ExplodeCollide(struct _Instance *instance /*$s2*/, struct GameTracker *gameTracker /*$s4*/)
void WCBEGG_ExplodeCollide(struct _Instance *instance, struct GameTracker *gameTracker)
{ // line 368, offset 0x8008f678
	/* begin block 1 */
		// Start line: 369
		// Start offset: 0x8008F678
		// Variables:
			struct _CollideInfo *collideInfo; // $a0
			struct _HSphere *s1; // $v1
			struct _Instance *inst1; // $s0
			struct PhysObData *data; // $s1
	/* end block 1 */
	// End offset: 0x8008F7DC
	// End Line: 425

	/* begin block 2 */
		// Start line: 772
	/* end block 2 */
	// End Line: 773
			UNIMPLEMENTED();
}


void WCBEGG_Collide(struct _Instance* instance, struct GameTracker* gameTracker) // Matching - 100%
{
	struct _CollideInfo* collideInfo;
	struct _Instance* inst1;

	collideInfo = (struct _CollideInfo*)instance->collideInfo;
	if (((unsigned char)collideInfo->type1) != 1 || (inst1 = (struct _Instance*)collideInfo->inst1, strcmpi(inst1->object->name, "walboss_")))
	{
		TurnOffCollisionPhysOb(instance, 7);
		instance->collideFunc = WCBEGG_ExplodeCollide;
	}
	CollidePhysicalObject(instance, gameTracker);
}

long WALBOSC_AnimCallback(struct _G2Anim_Type* anim, int sectionID, enum _G2AnimCallbackMsg_Enum message, long messageDataA, long messageDataB, struct _Instance* instance) // Matching - 100%
{
	if (message == 1)
	{
		COLLIDE_SegmentCollisionOff(instance, 1);
		instance->flags |= 0x800;
		instance->flags2 |= 0x20000000;
		instance->halvePlane.flags = 0;
	}
	else
	{
		INSTANCE_DefaultAnimCallback(anim, sectionID, message, messageDataA, messageDataB, instance);
	}
	return messageDataA;
}

void WALBOSC_Collide(struct _Instance* instance, struct GameTracker* gameTracker) // Matching - 100%
{
	struct _CollideInfo* collideInfo;
	struct _HSphere* s1;
	struct _Instance* inst1;
	struct PhysObWeaponProperties* Prop;

	collideInfo = (struct _CollideInfo*)instance->collideInfo;
	inst1 = (struct _Instance*)collideInfo->inst1;
	s1 = (struct _HSphere*)collideInfo->prim1;
	if (s1->id == 8)
	{
		Prop = (struct PhysObWeaponProperties*)instance->data;
		COLLIDE_SegmentCollisionOff(instance, 1);
		INSTANCE_Post(inst1, 0x400000, SetFXHitData(instance, (unsigned char)collideInfo->segment, Prop->WeaponAttributes.Damage / 128, 256));
		INSTANCE_Post(inst1, 0x1000000, SetMonsterHitData(instance, NULL, Prop->WeaponAttributes.Damage, Prop->WeaponAttributes.knockBackDistance, Prop->WeaponAttributes.knockBackFrames));
	}
}

void WALBOSC_Message(struct _Instance* instance, unsigned int message, unsigned int data)//Matching - 100%
{
	if (message == 0x1000017 && data == 0)
	{
		COLLIDE_SegmentCollisionOff(instance, 1);
		instance->flags2 |= 0x20000000;
	}
}