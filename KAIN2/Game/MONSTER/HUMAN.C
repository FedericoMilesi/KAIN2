#include "Game/CORE.H"
#include "MONSTER.H"
#include "HUMAN.H"
#include <Game/SAVEINFO.H>
#include <Game/STATE.H>
#include <Game/SOUND.H>

struct _MonsterStateChoice HUMAN_StateChoiceTable[] =
{
	{9, HUMAN_StunnedEntry, HUMAN_Stunned},
	{0x17, HUMAN_DeadEntry, HUMAN_Dead},
	{0x1B, HUMAN_EmbraceEntry, HUMAN_Embrace },
	{2, HUMAN_IdleEntry, HUMAN_Idle},
	{0x13, MON_FleeEntry, HUMAN_Flee},
	{-1}
};

struct _MonsterFunctionTable HUMAN_FunctionTable =
{
	HUMAN_Init,
	HUMAN_CleanUp,
	0,
	HUMAN_Query,
	0,
	HUMAN_StateChoiceTable,
	__DATE__
};

typedef void (*TDRFuncPtr_MONTABLE_GetInitFunc)();
extern void MonsterProcess(struct _Instance* instance, struct GameTracker* gameTracker);
extern void MON_FleeEntry(struct _Instance* instance);

// autogenerated function stub: 
// void /*$ra*/ HUMAN_WaitForWeapon(struct _Instance *instance /*$s0*/, struct GameTracker *gameTracker /*$a1*/)
void HUMAN_WaitForWeapon(struct _Instance *instance, struct GameTracker *gameTracker)
{ // line 92, offset 0x8007cb40
	UNIMPLEMENTED();
}


// autogenerated function stub: 
// struct _Instance * /*$ra*/ HUMAN_CreateWeapon(struct _Instance *instance /*$s1*/, int weaponid /*$a1*/, int segment /*$s2*/)
struct _Instance * HUMAN_CreateWeapon(struct _Instance *instance, int weaponid, int segment)
{ // line 110, offset 0x8007cbb0
	/* begin block 1 */
		// Start line: 111
		// Start offset: 0x8007CBB0
		// Variables:
			struct Object *weapon; // $a1

		/* begin block 1.1 */
			// Start line: 116
			// Start offset: 0x8007CBE8
			// Variables:
				struct _Instance *iweapon; // $s0
		/* end block 1.1 */
		// End offset: 0x8007CC3C
		// End Line: 141
	/* end block 1 */
	// End offset: 0x8007CC6C
	// End Line: 150

	/* begin block 2 */
		// Start line: 228
	/* end block 2 */
	// End Line: 229
				UNIMPLEMENTED();
	return null;
}


void HUMAN_Init(struct _Instance* instance)  // Matching - 100%
{
	struct _MonsterVars* mv;
	struct _MonsterAttributes* ma;

	mv = (struct _MonsterVars*)instance->extraData;
	ma = (struct _MonsterAttributes*)instance->data;

	if (!(ma->whatAmI & 0x2000))
	{
		int opinion;
		struct _MonsterAllegiances* allegiances;

		allegiances = mv->subAttr->allegiances;
		if (GlobalSave->humanOpinionOfRaziel > 0)
		{
			allegiances->enemies &= ~0x1;
			allegiances->gods |= 0x1;
			allegiances->allies |= 0x1;
		}
		else
		{
			allegiances->gods &= ~0x1;
			allegiances->allies &= ~0x1;
			allegiances->enemies |= 0x1;
		}
	}
	if (strcmpi(instance->object->name, "vlgrb___") == 0)
	{
		mv->auxFlags |= 0x20;
	}
	MON_DefaultInit(instance);
	mv->soulJuice = 16384;
	mv->mvFlags |= 0x2000;
}

void HUMAN_CleanUp(struct _Instance* instance)  // Matching - 100%
{
	MON_CleanUp(instance);
}


unsigned long HUMAN_Query(struct _Instance* instance, unsigned long query)  // Matching - 100%
{
	struct _MonsterVars* mv;
	struct _MonsterAttributes* ma;
	unsigned long ret;

	ma = (struct _MonsterAttributes*)instance->data;
	mv = (struct _MonsterVars*)instance->extraData;

	if (ma == NULL)
	{
		return 0;
	}

	switch (query)
	{
	case 0:
		if ((mv->mvFlags & 0x200))
		{
			ret = 0x40000000;
			break;
		}

		ret = 0x12000000;
		if ((instance->currentMainState != 30))
		{
			ret = ((mv->mvFlags & 0x100) != 0) << 29;
			if (!(mv->mvFlags & 0x200000))
			{
				if ((mv->hitPoints <= 0x1000) || (mv->auxFlags & 3))
				{
					ret |= 0x08000000;
				}
			}
		}
		break;
	case 37:
		if (!(ma->whatAmI & 0x8000))
		{
			ret = mv->subAttr->allegiances->enemies & 1;
		}
		else
		{
			ret = 0;
		}
		break;
	default:
		ret = MonsterQuery(instance, query);
	}
	return ret;
}


// autogenerated function stub: 
// void /*$ra*/ HUMAN_DeadEntry(struct _Instance *instance /*$s1*/)
void HUMAN_DeadEntry(struct _Instance *instance)
{ // line 266, offset 0x8007ce8c
	/* begin block 1 */
		// Start line: 267
		// Start offset: 0x8007CE8C
		// Variables:
			struct _MonsterVars *mv; // $s0
	/* end block 1 */
	// End offset: 0x8007CED4
	// End Line: 274

	/* begin block 2 */
		// Start line: 566
	/* end block 2 */
	// End Line: 567
			UNIMPLEMENTED();
}


void HUMAN_Dead(struct _Instance* instance) // Matching - 100%
{
	struct _MonsterVars* mv;

	mv = (struct _MonsterVars*)instance->extraData;

	instance->fadeValue = (short)(MON_GetTime(instance) - mv->damageTimer);

	if (mv->causeOfDeath == 6)
	{
		MON_Dead(instance);
		return;
	}

	if (instance->fadeValue >= 4096)
	{
		MON_KillMonster(instance);
	}

	if (((mv->mvFlags & 0x400000)) && (mv->effectTimer < MON_GetTime(instance)))
	{
		mv->mvFlags &= ~0x400000;
	}

	if (!(mv->mvFlags & 0x2))
	{
		MON_ApplyPhysics(instance);
	}

	do
	{

	} while (DeMessageQueue(&mv->messageQueue) != NULL);
}


// autogenerated function stub: 
// void /*$ra*/ HUMAN_StunnedEntry(struct _Instance *instance /*$s0*/)
void HUMAN_StunnedEntry(struct _Instance *instance)
{ // line 321, offset 0x8007cfec
	/* begin block 1 */
		// Start line: 322
		// Start offset: 0x8007CFEC
		// Variables:
			struct _MonsterVars *mv; // $s1
	/* end block 1 */
	// End offset: 0x8007D050
	// End Line: 333

	/* begin block 2 */
		// Start line: 676
	/* end block 2 */
	// End Line: 677
			UNIMPLEMENTED();
}


// autogenerated function stub: 
// void /*$ra*/ HUMAN_Stunned(struct _Instance *instance /*$s1*/)
void HUMAN_Stunned(struct _Instance *instance)
{ // line 335, offset 0x8007d064
	/* begin block 1 */
		// Start line: 336
		// Start offset: 0x8007D064
		// Variables:
			struct _MonsterVars *mv; // $s0
	/* end block 1 */
	// End offset: 0x8007D0F8
	// End Line: 354

	/* begin block 2 */
		// Start line: 704
	/* end block 2 */
	// End Line: 705
			UNIMPLEMENTED();
}


// autogenerated function stub: 
// void /*$ra*/ HUMAN_EmbraceEntry(struct _Instance *instance /*$s0*/)
void HUMAN_EmbraceEntry(struct _Instance *instance)
{ // line 359, offset 0x8007d10c
	/* begin block 1 */
		// Start line: 360
		// Start offset: 0x8007D10C
		// Variables:
			struct _MonsterVars *mv; // $s1
	/* end block 1 */
	// End offset: 0x8007D14C
	// End Line: 367

	/* begin block 2 */
		// Start line: 752
	/* end block 2 */
	// End Line: 753
			UNIMPLEMENTED();
}


// autogenerated function stub: 
// void /*$ra*/ HUMAN_Embrace(struct _Instance *instance /*$s2*/)
void HUMAN_Embrace(struct _Instance *instance)
{ // line 370, offset 0x8007d168
	/* begin block 1 */
		// Start line: 371
		// Start offset: 0x8007D168
		// Variables:
			struct _MonsterVars *mv; // $s1
			struct __Event *message; // $a1
			int letgo; // $s3
			int juice; // $s0
	/* end block 1 */
	// End offset: 0x8007D314
	// End Line: 426

	/* begin block 2 */
		// Start line: 777
	/* end block 2 */
	// End Line: 778
			UNIMPLEMENTED();
}

void HUMAN_IdleEntry(struct _Instance* instance)//Matching - 100%
{
	struct _MonsterVars* mv;

	mv = (struct _MonsterVars*)instance->extraData;

	MON_IdleEntry(instance);

	mv->auxFlags &= 0xFFFFFFFD;
	mv->auxFlags &= 0xFFFFFFFB;
	mv->auxFlags &= 0xFFFFFFFE;
}


void HUMAN_Idle(struct _Instance* instance) // Matching - 100%
{
	struct _MonsterVars* mv;
	struct _MonsterAttributes* ma;
	struct _MonsterIR* ally;
	struct _MonsterIR* enemy;

	mv = (struct _MonsterVars*)instance->extraData;

	ma = (struct _MonsterAttributes*)instance->data;

	ally = mv->ally;

	enemy = mv->enemy;

	if ((!(mv->mvFlags & 0x4)) && (ally != NULL) && ((ally->mirFlags & 0x4)))
	{
		if ((mv->auxFlags & 0x2))
		{
			MON_TurnToPosition(instance, &ally->instance->position, mv->subAttr->speedPivotTurn);

			if ((instance->flags2 & 0x2))
			{
				mv->auxFlags = ((mv->auxFlags & ~0x2) | 0x1);
			}

			MON_DefaultQueueHandler(instance);
			return;
		}

		if ((mv->auxFlags & 0x1))
		{
			if ((ally->distance >= 2000) || ((enemy != NULL) && (enemy->distance < 2000)))
			{
				mv->auxFlags = ((mv->auxFlags & ~0x1) | 0x4);

				MON_PlayAnimFromList(instance, ma->auxAnimList, 1, 1);
			}

			MON_DefaultQueueHandler(instance);
			return;
		}

		if ((mv->auxFlags & 0x4))
		{
			if ((instance->flags2 & 0x10))
			{
				mv->auxFlags &= ~0x4;

				MON_PlayRandomIdle(instance, 2);
			}

			MON_DefaultQueueHandler(instance);
			return;
		}

		if ((ally->distance < 2000) && ((enemy == NULL) || (enemy->distance >= 2000)))
		{
			mv->auxFlags |= 0x2;

			MON_PlayAnimFromList(instance, ma->auxAnimList, 0, 2);

			MON_DefaultQueueHandler(instance);
			return;
		}
	}

	MON_Idle(instance);
}


void HUMAN_Flee(struct _Instance* instance) // Matching - 100%
{
	struct _MonsterVars* mv;
	struct _MonsterIR* enemy;

	mv = (struct _MonsterVars*)instance->extraData;

	enemy = mv->enemy;

	if ((enemy != NULL) && (enemy->distance < 640))
	{
		if (!(mv->auxFlags & 0x8))
		{
			struct _MonsterAttributes* ma;

			ma = (struct _MonsterAttributes*)instance->data;

			MON_PlayAnimFromList(instance, ma->auxAnimList, 2, 2);

			mv->auxFlags |= 0x8;

			if ((mv->auxFlags & 0x20))
			{
				SOUND_Play3dSound(&instance->position, 459, 0, 88, 3500);
			}
			else
			{
				SOUND_Play3dSound(&instance->position, 458, -100, 92, 3500);
			}
		}

		MON_TurnToPosition(instance, &enemy->instance->position, mv->subAttr->speedPivotTurn);

		MON_DefaultQueueHandler(instance);
	}
	else if ((mv->auxFlags & 0x8))
	{
		MON_SwitchState(instance, MONSTER_STATE_FLEE);
	}
	else
	{
		MON_Flee(instance);
	}

	if (((mv->auxFlags & 0x8)) && ((mv->mvFlags & 0x1)))
	{
		mv->auxFlags &= ~0x8;
	}
}


// autogenerated function stub: 
// void /*$ra*/ HUMAN_GetAngry()
void HUMAN_GetAngry()
{ // line 540, offset 0x8007d688
	/* begin block 1 */
		// Start line: 541
		// Start offset: 0x8007D688
		// Variables:
			struct _Instance *instance; // $s0

		/* begin block 1.1 */
			// Start line: 548
			// Start offset: 0x8007D6C4
			// Variables:
				struct _MonsterVars *mv; // $v0
				struct _MonsterAllegiances *allegiances; // $a0
				struct _MonsterIR *mir; // $v1
		/* end block 1.1 */
		// End offset: 0x8007D72C
		// End Line: 563
	/* end block 1 */
	// End offset: 0x8007D73C
	// End Line: 565

	/* begin block 2 */
		// Start line: 1141
	/* end block 2 */
	// End Line: 1142

	/* begin block 3 */
		// Start line: 1144
	/* end block 3 */
	// End Line: 1145
				UNIMPLEMENTED();
}


// autogenerated function stub: 
// int /*$ra*/ HUMAN_TypeOfHuman(struct _Instance *instance /*$s0*/)
int HUMAN_TypeOfHuman(struct _Instance *instance)
{ // line 567, offset 0x8007d750
	/* begin block 1 */
		// Start line: 568
		// Start offset: 0x8007D750
		// Variables:
			int type; // $v1
			struct _MonsterVars *mv; // $a0
	/* end block 1 */
	// End offset: 0x8007D7AC
	// End Line: 580

	/* begin block 2 */
		// Start line: 1219
	/* end block 2 */
	// End Line: 1220
			UNIMPLEMENTED();
	return 0;
}