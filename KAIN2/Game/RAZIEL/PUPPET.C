#include "Game/CORE.H"
#include <Game/STATE.H>
#include "PUPPET.H"
#include "RAZIEL.H"
#include "CONTROL.H"
#include "ALGOCTRL.H"
#include "STEERING.H"
#include <Game/G2/ANMG2ILF.H>


// autogenerated function stub: 
// void /*$ra*/ StateHandlerPuppetShow(struct __CharacterState *In /*$s2*/, int CurrentSection /*$s1*/, int Data /*$s4*/)
void StateHandlerPuppetShow(struct __CharacterState *In, int CurrentSection, int Data)
{ // line 8, offset 0x8009a984
	/* begin block 1 */
		// Start line: 9
		// Start offset: 0x8009A984
		// Variables:
			struct __Event *Ptr; // $s0

		/* begin block 1.1 */
			// Start line: 38
			// Start offset: 0x8009AB48
			// Variables:
				struct evActionPlayHostAnimationData *data; // $v0
		/* end block 1.1 */
		// End offset: 0x8009AB48
		// End Line: 40

		/* begin block 1.2 */
			// Start line: 53
			// Start offset: 0x8009ABB8
			// Variables:
				//struct evAnimationInstanceSwitchData *data; // $v1
		/* end block 1.2 */
		// End offset: 0x8009ABB8
		// End Line: 55

		/* begin block 1.3 */
			// Start line: 67
			// Start offset: 0x8009AC34
			// Variables:
				//struct evPositionData *data; // $v0
		/* end block 1.3 */
		// End offset: 0x8009AC34
		// End Line: 67

		/* begin block 1.4 */
			// Start line: 78
			// Start offset: 0x8009AC78
			// Variables:
				//struct evPositionData *data; // $v0

			/* begin block 1.4.1 */
				// Start line: 78
				// Start offset: 0x8009AC78
				// Variables:
					short _x1; // $v1
					short _y1; // $a0
					short _z1; // $a1
					_Position *_v0; // $v0
			/* end block 1.4.1 */
			// End offset: 0x8009AC78
			// End Line: 78
		/* end block 1.4 */
		// End offset: 0x8009AC78
		// End Line: 78
	/* end block 1 */
	// End offset: 0x8009ACF4
	// End Line: 98

	/* begin block 2 */
		// Start line: 16
	/* end block 2 */
	// End Line: 17
					UNIMPLEMENTED();
}


// autogenerated function stub: 
// void /*$ra*/ StateHandlerMoveToPosition(struct __CharacterState *In /*$s1*/, int CurrentSection /*$s2*/, int Data /*$s6*/)
void StateHandlerMoveToPosition(struct __CharacterState *In, int CurrentSection, int Data)
{ // line 102, offset 0x8009ad20
	/* begin block 1 */
		// Start line: 103
		// Start offset: 0x8009AD20
		// Variables:
			struct __Event *Ptr; // $s0
			long distance; // $s0
			int motion; // $v0
			int applyMotion; // $s5

		/* begin block 1.1 */
			// Start line: 113
			// Start offset: 0x8009AE2C
			// Variables:
				struct evPositionData *moveToPoint; // $v0

			/* begin block 1.1.1 */
				// Start line: 115
				// Start offset: 0x8009AE2C
				// Variables:
					short _x1; // $v1
					short _y1; // $a0
					short _z1; // $v0
					_Position *_v0; // $s3
			/* end block 1.1.1 */
			// End offset: 0x8009AE2C
			// End Line: 115
		/* end block 1.1 */
		// End offset: 0x8009AE2C
		// End Line: 115

		/* begin block 1.2 */
			// Start line: 134
			// Start offset: 0x8009AEC8
			// Variables:
				//struct evPositionData *moveToPoint; // $v0

			/* begin block 1.2.1 */
				// Start line: 136
				// Start offset: 0x8009AEC8
				// Variables:
					//short _x1; // $v1
					//short _y1; // $a0
					//short _z1; // $v0
			/* end block 1.2.1 */
			// End offset: 0x8009AEC8
			// End Line: 136
		/* end block 1.2 */
		// End offset: 0x8009AEEC
		// End Line: 140
	/* end block 1 */
	// End offset: 0x8009AFA0
	// End Line: 174

	/* begin block 2 */
		// Start line: 217
	/* end block 2 */
	// End Line: 218
					UNIMPLEMENTED();
}

void DefaultPuppetStateHandler(struct __CharacterState* In, int CurrentSection, int Data)  // Matching - 98.99%
{
	struct __Event* Ptr;
	struct evPositionData* data;
	long _x1;
	long _y1;
	long _z1;
	struct _Vector* _v0;

	Ptr = PeekMessageQueue(&In->SectionList[CurrentSection].Event);
	if (Ptr != NULL)
	{
		switch (Ptr->ID)
		{
		case 0x100004:
			razResetMotion(gameTrackerX.playerInstance);
			break;
		case 0x4000A:
			STREAM_SetInstancePosition(gameTrackerX.playerInstance, (struct evPositionData*)Ptr->Data);
			break;
		case 0x4000B:
			if (CurrentSection == 0)
			{
				data = (struct evPositionData*)Ptr->Data;
				gameTrackerX.playerInstance->rotation.z = data->z;
			}
			break;
		case 0x4000F:
			_v0 = &Raziel.Senses.lookAtPoint;
			_x1 = ((struct evPositionData*)Ptr->Data)->x;
			_y1 = ((struct evPositionData*)Ptr->Data)->y;
			_z1 = ((struct evPositionData*)Ptr->Data)->z;
			_v0->x = _x1;
			_v0->y = _y1;
			_v0->z = _z1;
			Raziel.Senses.Flags |= 16;
			ControlFlag |= 0x20000;
			break;
		case 0x40020:
			if (CurrentSection == 0)
			{
				G2Anim_SetSpeedAdjustment(&gameTrackerX.playerInstance->anim, Ptr->Data);
			}
			break;
		case 0x800027:
			if (Data != 0)
			{
				ControlFlag |= 8;
				break;
			}
			ControlFlag &= 0xFFFFFFF7;
			break;
		case 0x10002002:
			razMaterialShift();
			break;
		case 0x10002001:
			razSpectralShift();
			break;
		case 0x8000000:
			break;
		case 0x1000001:
			break;
		case 0x80000020:
			break;
		case 0x80000008:
			break;
		case 0x80000010:
			break;
		case 0x80000000:
			break;
		case 0x100009:
			break;
		case 0x4010200:
			break;
		default:
			DefaultStateHandler(In, CurrentSection, Data);
		}
	}
}

// autogenerated function stub: 
// void /*$ra*/ StateHandlerWarpGate(struct __CharacterState *In /*$s0*/, int CurrentSection /*$s1*/, int Data /*$s4*/)
void StateHandlerWarpGate(struct __CharacterState *In, int CurrentSection, int Data)
{ // line 243, offset 0x8009b27c
	/* begin block 1 */
		// Start line: 244
		// Start offset: 0x8009B27C
		// Variables:
			struct __Event *Ptr; // $v0
			int anim; // $s3

		/* begin block 1.1 */
			// Start line: 289
			// Start offset: 0x8009B58C
			// Variables:
				struct _Instance *heldInst; // $v0
		/* end block 1.1 */
		// End offset: 0x8009B5E0
		// End Line: 296

		/* begin block 1.2 */
			// Start line: 302
			// Start offset: 0x8009B614
		/* end block 1.2 */
		// End offset: 0x8009B614
		// End Line: 302
	/* end block 1 */
	// End offset: 0x8009B6F0
	// End Line: 344

	/* begin block 2 */
		// Start line: 527
	/* end block 2 */
	// End Line: 528
				UNIMPLEMENTED();
}

void StateHandlerForcedGlide(struct __CharacterState* In, int CurrentSection, int Data)  // Matching - 98.83%
{
	struct __Event* Ptr;
	int Anim;
	int extraProcess;

	extraProcess = 0;
	Anim = G2EmulationQueryAnimation(In, CurrentSection);
	while (Ptr = PeekMessageQueue(&In->SectionList[CurrentSection].Event))
	{
		if (Ptr != NULL)
		{
			switch (Ptr->ID)
			{
			case 0x100001:
				if (CurrentSection == 0)
				{
					Raziel.Mode = 0x2000;
					ControlFlag = 0;
					PhysicsMode = 0;
					SteerSwitchMode(In->CharacterInstance, 0);
					DeInitAlgorithmicWings(In->CharacterInstance);
					SetExternalTransitionForce((struct __Force*)&ExternalForces, In->CharacterInstance, 4, 0, 24, -24);
					gameTrackerX.wipeType = 11;
					gameTrackerX.wipeTime = -10;
					gameTrackerX.maxWipeTime = 10;
					if ((Raziel.forcedGlideSpeed < -23) == 0)
					{
						Raziel.forcedGlideSpeed = -24;
					}
				}
				G2EmulationSwitchAnimation(In, CurrentSection, 16, Ptr->Data, 5, 1);
				break;
			case 0x100004:
				if (CurrentSection == 0)
				{
					InitAlgorithmicWings(In->CharacterInstance);
					gameTrackerX.wipeType = 11;
					gameTrackerX.wipeTime = 10;
					gameTrackerX.maxWipeTime = 10;
					Raziel.forcedGlideSpeed = 0xFFFFFFE8;
				}
				break;
			case 0x100000:
				SetPhysics(In->CharacterInstance, -16, 0, 0, 0);
				if (razSwitchVAnimCharacterGroup(In->CharacterInstance, 24, NULL, NULL) != 0)
				{
					G2EmulationSwitchAnimationCharacter(In, 36, 0, 4, 1);
				}
				extraProcess = 1;
				StateSwitchStateCharacterData(In, &StateHandlerFall, 0);
				break;
			case 0x8000000:
				if (Anim == 16)
				{
					G2EmulationSwitchAnimationAlpha(In, CurrentSection, 17, 0, 5, 1, 4);
					SetExternalTransitionForce((struct __Force*)&ExternalForces, In->CharacterInstance, 4, 0, 0, Raziel.forcedGlideSpeed);
				}
				break;
			case 0x4010008:
				StateSwitchStateData(In, CurrentSection, &StateHandlerDeCompression, 0);
				break;
			case 0x1000001:
				break;
			case 0x80000020:
				break;
			case 0x80000004:
				break;
			case 0x80000000:
				break;
			case 0x80000008:
				break;
			case 0x4020000:
				break;
			case 0x4000007:
				break;
			case 0x4000001:
				break;
			case 0x10000000:
				break;
			case 0x20000001:
				break;
			case 0x20000004:
				break;
			default:
				DefaultStateHandler(In, CurrentSection, Data);
			}
			DeMessageQueue(&In->SectionList[CurrentSection].Event);
		}
	}
	if ((extraProcess == 0) && (CurrentSection == 0) && (STREAM_GetLevelWithID(In->CharacterInstance->currentStreamUnitID)->unitFlags & 0x1000) == 0)
	{
		EnMessageQueueData(&In->SectionList[0].Event, 0x100000, 0);
	}
}
