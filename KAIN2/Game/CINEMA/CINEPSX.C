#include "CORE.H"
#include "CINEPSX.H"
#include "STREAM.H"
#include "STRMLOAD.H"
#include "PSX/MAIN.H"
#include "OVERLAYS/CINEMAX.H"

#include "LIBGPU.H"
#include "LIBETC.H"

#include <stddef.h>

static struct cinema_fn_table_t* the_cine_table; // offset 0x800CAD90
static struct _ObjectTracker* the_cine_tracker; // offset 0x800CAD94


// autogenerated function stub: 
// int /*$ra*/ CINE_CDIntrQuery()
int CINE_CDIntrQuery()
{ // line 40, offset 0x800b777c
	/* begin block 1 */
		// Start line: 80
	/* end block 1 */
	// End Line: 81

	/* begin block 2 */
		// Start line: 81
	/* end block 2 */
	// End Line: 82
	UNIMPLEMENTED();
	return 0;
}


// autogenerated function stub: 
// unsigned short /*$ra*/ CINE_Pad(int pad /*$a0*/)
unsigned short CINE_Pad(int pad)
{ // line 51, offset 0x800b77a4
	/* begin block 1 */
		// Start line: 102
	/* end block 1 */
	// End Line: 103

	/* begin block 2 */
		// Start line: 103
	/* end block 2 */
	// End Line: 104
	UNIMPLEMENTED();
	return 0;
}

void CINE_Play(char *strfile, unsigned short mask, int buffers)
{ 
	if (the_cine_table != NULL)
	{
#if defined(PSXPC_VERSION)
		if (!strcmp(the_cine_table->versionID, __DATE__))
#else
		if (the_cine_table->versionID == __DATE__)
#endif
		{
			the_cine_table->play(strfile, mask, buffers);
		}
		else
		{
			printf("CINEMA : Version number is wrong. Not playing the cinematics.\n");
		}
	}
}

#if defined(PSXPC_VERSION)
void CINE_PatchTable()
{
	the_cine_table->versionID = __DATE__;
	the_cine_table->play = CINEMAX_Play;
}

#endif

int CINE_Load()
{
	struct _ObjectTracker* tracker;
	int attempts;

	attempts = 0;
	tracker = STREAM_GetObjectTracker("cinemax");

	do
	{
		if (tracker->objectStatus == 2)
		{
			break;
		}
		
		attempts++;
		STREAM_PollLoadQueue();
		VSync(0);
	} while (attempts < 400);
	
	if (attempts < 400)
	{
		the_cine_tracker = tracker;
		the_cine_table = (struct cinema_fn_table_t*)tracker->object->relocModule;

#if defined(PSXPC_VERSION)
		CINE_PatchTable();
#endif

		return 1;
	}
	else
	{
		printf("cinema timeout\n");
	}

	return 0;
}

int CINE_Loaded()
{
	return the_cine_tracker != NULL;
}

void CINE_Unload()
{
	VSyncCallback(VblTick);

	the_cine_table = NULL;
	if (the_cine_tracker != NULL)
	{
		STREAM_DumpObject(the_cine_tracker);
		the_cine_tracker = NULL;
	}
}


// autogenerated function stub: 
// void /*$ra*/ CINE_PlayIngame(int number /*$a2*/)
void CINE_PlayIngame(int number)
{ // line 126, offset 0x800b7928
	/* begin block 1 */
		// Start line: 127
		// Start offset: 0x800B7928
		// Variables:
			char movie_name[24]; // stack offset -32
	/* end block 1 */
	// End offset: 0x800B7968
	// End Line: 138

	/* begin block 2 */
		// Start line: 278
	/* end block 2 */
	// End Line: 279
	UNIMPLEMENTED();
}




