#include "CORE.H"
#include "VOICEXA.H"
#include "GAMELOOP.H"

struct XAVoiceTracker voiceTracker; // offset 0x800D5AD4
struct XAVoiceListEntry* voiceList; // offset 0x800CF99C
enum language_t the_language; // offset 0x800D5BFC

typedef void (*voiceCmdFunc)(struct XAVoiceTracker* vt, short cmdParam);

voiceCmdFunc voiceCmdTbl[5] =
{
	voiceCmdPlay,
	voiceCmdStop,
	voiceCmdPause,
	voiceCmdResume,
	voiceCmdNull
};

void VOICEXA_Init()
{
	int i;
	CdlFILE fp;
	struct XAVoiceTracker* vt;
	char fileName[32];

	vt = &voiceTracker;

	if ((gameTrackerX.debugFlags & 0x80000))
	{
		vt->voiceStatus = 0;
		vt->cdStatus = 0;
		vt->reqIn = 0;
		vt->reqOut = 0;
		vt->reqsQueued = 0;
		vt->cdCmdIn = 0;
		vt->cdCmdOut = 0;
		vt->cdCmdsQueued = 0;
		vt->voiceCmdIn = 0;
		vt->voiceCmdOut = 0;
		vt->voiceCmdsQueued = 0;

		for (i = 0; i < 30; i++)
		{
			sprintf(&fileName[0], "\VOICE\VOICE%02d.XA;", i);
			
			if (CdSearchFile(&fp, &fileName[0]) == 0)
			{
				vt->xaFileInfo[i].startPos = 0;
			}
			else
			{
				//loc_800B6B74
				vt->xaFileInfo[i].startPos = CdPosToInt(&fp.pos);
			}
		}
	}
}


// autogenerated function stub: 
// void /*$ra*/ putCdCommand(struct XAVoiceTracker *vt /*$a0*/, unsigned char cdCommand /*$a1*/, int numParams /*$a2*/, unsigned char *params /*$a3*/)
void putCdCommand(struct XAVoiceTracker *vt, unsigned char cdCommand, int numParams, unsigned char *params)
{ // line 98, offset 0x800b6ee0
	/* begin block 1 */
		// Start line: 99
		// Start offset: 0x800B6EE0
		// Variables:
			int i; // $t0
	/* end block 1 */
	// End offset: 0x800B6F5C
	// End Line: 112

	/* begin block 2 */
		// Start line: 225
	/* end block 2 */
	// End Line: 226

	/* begin block 3 */
		// Start line: 228
	/* end block 3 */
	// End Line: 229

}


// autogenerated function stub: 
// void /*$ra*/ VOICEXA_CdSyncCallback(unsigned char status /*$a0*/, unsigned char *result /*$a1*/)
void VOICEXA_CdSyncCallback(unsigned char status, unsigned char *result)
{ // line 115, offset 0x800b6f64
	/* begin block 1 */
		// Start line: 116
		// Start offset: 0x800B6F64
		// Variables:
			struct XAVoiceTracker *vt; // $a1
	/* end block 1 */
	// End offset: 0x800B6FC0
	// End Line: 137

	/* begin block 2 */
		// Start line: 263
	/* end block 2 */
	// End Line: 264

}


// autogenerated function stub: 
// void /*$ra*/ processCdCommands(struct XAVoiceTracker *vt /*$s1*/)
void processCdCommands(struct XAVoiceTracker *vt)
{ 
	struct CdCommand *cmd; // $s0

	//s1 = vt
	
	if (vt->cdStatus == 2)
	{

	}

#if 0
		lbu     $v1, 0xAB($s1)
		li      $v0, 2
		bne     $v1, $v0, loc_800B6CE4
		addiu   $a2, $s1, 0x10
		lbu     $v0, 0xA1($s1)
		li      $v1, 1
		sb      $v1, 0xAB($s1)
		sll     $v0, 3
		addiu   $v0, 0x18
		addu    $s0, $s1, $v0
		lbu     $a0, 3($s0)
		j       loc_800B6D28
		addiu   $a1, $s0, 4

		loc_800B6CE4:
	lbu     $v0, 0xA2($s1)
		nop
		beqz    $v0, loc_800B6D30
		li      $a1, 1
		beq     $v1, $a1, loc_800B6D30
		lui     $a0, 0x800B
		lbu     $v0, 0xA1($s1)
		li      $a0, sub_800B6C30
		sb      $a1, 0xAB($s1)
		sll     $v0, 3
		addiu   $v0, 0x18
		jal     PadStopCom_0
		addu    $s0, $s1, $v0
		addiu   $a1, $s0, 4
		sw      $v0, 0xC($s1)
		lbu     $a0, 3($s0)
		addiu   $a2, $s1, 0x10

		loc_800B6D28:
	jal     sub_800BE140
		nop

		loc_800B6D30 :
	lw      $ra, 0x10 + var_s8($sp)
		lw      $s1, 0x10 + var_s4($sp)
		lw      $s0, 0x10 + var_s0($sp)
		jr      $ra
		addiu   $sp, 0x20
#endif

}

void putVoiceCommand(struct XAVoiceTracker *vt, unsigned char voiceCmd, unsigned char nextVoiceStatus, int voiceCmdParam)
{ 
	vt->voiceCmdQueue[vt->voiceCmdIn].voiceCmd = voiceCmd;
	vt->voiceCmdQueue[vt->voiceCmdIn].nextVoiceStatus = nextVoiceStatus;
	vt->voiceCmdQueue[vt->voiceCmdIn].voiceCmdParam = voiceCmdParam;

	if (vt->voiceCmdsQueued < 15)
	{
		vt->voiceCmdsQueued++;
		vt->voiceCmdIn++;

		if (vt->voiceCmdIn >= 16)
		{
			vt->voiceCmdIn = 0;
		}
	}
}

void processVoiceCommands(struct XAVoiceTracker *vt)
{
	struct VoiceCommand *cmd;
	
	if (vt->voiceCmdsQueued != 0)
	{
		vt->voiceCmdsQueued--;

		cmd = &vt->voiceCmdQueue[vt->voiceCmdOut++];

		if (vt->voiceCmdOut == 16)
		{
			vt->voiceCmdOut = 0;
		}

		if (cmd->voiceCmd < 5)
		{
			voiceCmdTbl[cmd->voiceCmd](vt, cmd->voiceCmdParam);

			vt->voiceStatus = cmd->nextVoiceStatus;
		}
	}
}


// autogenerated function stub: 
// void /*$ra*/ voiceCmdPlay(struct XAVoiceTracker *vt /*$s2*/, short voiceIndex /*$s3*/)
void voiceCmdPlay(struct XAVoiceTracker *vt, short voiceIndex)
{ // line 226, offset 0x800b71a4
	/* begin block 1 */
		// Start line: 227
		// Start offset: 0x800B71A4
		// Variables:
			//struct CdlFILTER filter; // stack offset -88
			//struct CdlLOC pos; // stack offset -80
			//unsigned char mode; // stack offset -32
			//struct SpuCommonAttr spuattr; // stack offset -72
			//struct XAVoiceListEntry *voice; // $s1
			//struct XAFileInfo *file; // $s0
	/* end block 1 */
	// End offset: 0x800B72F8
	// End Line: 299

	/* begin block 2 */
		// Start line: 499
	/* end block 2 */
	// End Line: 500

	/* begin block 3 */
		// Start line: 509
	/* end block 3 */
	// End Line: 510

}


// autogenerated function stub: 
// void /*$ra*/ voiceCmdStop(struct XAVoiceTracker *vt /*$a0*/, short cmdParam /*$a1*/)
void voiceCmdStop(struct XAVoiceTracker *vt, short cmdParam)
{ // line 302, offset 0x800b7314
	/* begin block 1 */
		// Start line: 303
		// Start offset: 0x800B7314
		// Variables:
			//struct SpuCommonAttr spuattr; // stack offset -48
	/* end block 1 */
	// End offset: 0x800B7360
	// End Line: 318

	/* begin block 2 */
		// Start line: 713
	/* end block 2 */
	// End Line: 714

}


// autogenerated function stub: 
// void /*$ra*/ voiceCmdPause(struct XAVoiceTracker *vt /*$a0*/, short cmdParam /*$a1*/)
void voiceCmdPause(struct XAVoiceTracker *vt, short cmdParam)
{ // line 321, offset 0x800b7370
	/* begin block 1 */
		// Start line: 754
	/* end block 1 */
	// End Line: 755

}


// autogenerated function stub: 
// void /*$ra*/ voiceCmdResume(struct XAVoiceTracker *vt /*$a0*/, short cmdParam /*$a1*/)
void voiceCmdResume(struct XAVoiceTracker *vt, short cmdParam)
{ // line 329, offset 0x800b73ac
	/* begin block 1 */
		// Start line: 770
	/* end block 1 */
	// End Line: 771

}


// autogenerated function stub: 
// void /*$ra*/ voiceCmdNull(struct XAVoiceTracker *vt /*$a0*/, short cmdParam /*$a1*/)
void voiceCmdNull(struct XAVoiceTracker *vt, short cmdParam)
{ // line 336, offset 0x800b73e0
	/* begin block 1 */
		// Start line: 784
	/* end block 1 */
	// End Line: 785

	/* begin block 2 */
		// Start line: 785
	/* end block 2 */
	// End Line: 786

}

void VOICEXA_Play(int voiceIndex, int queueRequests)
{ 
	struct XAVoiceTracker* vt;
	struct XAFileInfo* file;

	vt = &voiceTracker;
	file = &vt->xaFileInfo[voiceIndex];

	if ((gameTrackerX.debugFlags & 0x80000))
	{
		if (file->startPos != 0)
		{
			if (gameTrackerX.sound.gVoiceOn != 0)
			{
				if (queueRequests != 0)
				{
					if (vt->reqsQueued < 3)
					{
						vt->reqsQueued++;
						vt->reqIn++;
						
						if ((vt->reqIn & 0xFF) == 4)
						{
							vt->reqIn = 0;
						}
					}
				}
				else
				{
					putVoiceCommand(vt, 0, 1, voiceIndex);
				}
			}
		}
	}
}


// autogenerated function stub: 
// int /*$ra*/ VOICEXA_FinalStatus(struct XAVoiceTracker *vt /*$a0*/)
int VOICEXA_FinalStatus(struct XAVoiceTracker* vt)
{ // line 387, offset 0x800b74ac
	/* begin block 1 */
		// Start line: 389
		// Start offset: 0x800B74AC
		// Variables:
	int tailIndex; // $v0
/* end block 1 */
// End offset: 0x800B74E8
// End Line: 404

/* begin block 2 */
	// Start line: 774
/* end block 2 */
// End Line: 775

/* begin block 3 */
	// Start line: 872
/* end block 3 */
// End Line: 873

/* begin block 4 */
	// Start line: 875
/* end block 4 */
// End Line: 876

	return 0;
}


// autogenerated function stub: 
// void /*$ra*/ VOICEXA_Pause()
void VOICEXA_Pause()
{ // line 406, offset 0x800b74f0
	/* begin block 1 */
		// Start line: 407
		// Start offset: 0x800B74F0
		// Variables:
	struct XAVoiceTracker* vt; // $s0
	int finalStatus; // $a0
/* end block 1 */
// End offset: 0x800B7550
// End Line: 424

/* begin block 2 */
	// Start line: 909
/* end block 2 */
// End Line: 910

}


// autogenerated function stub: 
// void /*$ra*/ VOICEXA_Resume()
void VOICEXA_Resume()
{ // line 427, offset 0x800b7560
	/* begin block 1 */
		// Start line: 428
		// Start offset: 0x800B7560
		// Variables:
	struct XAVoiceTracker* vt; // $s0
	int finalStatus; // $a0
/* end block 1 */
// End offset: 0x800B75C0
// End Line: 445

/* begin block 2 */
	// Start line: 952
/* end block 2 */
// End Line: 953

}

void VOICEXA_Tick()
{
	struct XAVoiceTracker* vt;
	vt = &voiceTracker;

	if ((gameTrackerX.debugFlags & 0x80000))
	{
		processVoiceCommands(vt);
		processCdCommands(vt);

		if (vt->cdCmdsQueued == 0 && vt->voiceCmdsQueued == 0)
		{
			if (vt->voiceStatus >= 3 && vt->voiceStatus != 0)
			{
				CdControlB(CdlGetlocL, NULL, &voiceTracker.cdResult[0]);

				if ((vt->cdResult[3] & 0x2))
				{
					vt->voiceStatus = 2;
					vt->currentPos.track = 0;

					voiceTracker.currentPos.minute = vt->cdResult[0];
					
					vt->currentPos.second = vt->cdResult[1];
					vt->currentPos.sector = vt->cdResult[2];
					vt->currentSector = CdPosToInt(&vt->currentPos) - 150;

					if (vt->currentSector >= vt->endSector - 8)
					{
						putVoiceCommand(vt, 1, 0, 0);
					}
				}
			}
			else if (vt->voiceStatus == 0 && vt->reqsQueued != 0)
			{
				putVoiceCommand(vt, 0, 1, vt->requestQueue[vt->reqOut]);
				
				vt->reqOut++;
				vt->reqsQueued--;

				if (vt->reqOut == 4)
				{
					vt->reqOut = 0;
				}
			}
		}
	}
}

int VOICEXA_IsPlaying()
{ 
	struct XAVoiceTracker *vt = &voiceTracker;

	if (vt->voiceStatus == 2)
	{
		return 2;
	}

	if (vt->voiceStatus == 1)
	{
		return 1;
	}

	if (vt->cdStatus != 0)
	{
		return 1;
	}

	return 0;
}


// autogenerated function stub: 
// int /*$ra*/ VOICEXA_IsPlayingOrPaused()
int VOICEXA_IsPlayingOrPaused()
{ // line 559, offset 0x800b7768
	/* begin block 1 */
		// Start line: 561
		// Start offset: 0x800B7768
	/* end block 1 */
	// End offset: 0x800B7768
	// End Line: 564

	/* begin block 2 */
		// Start line: 1221
	/* end block 2 */
	// End Line: 1222

	/* begin block 3 */
		// Start line: 1222
	/* end block 3 */
	// End Line: 1223

	/* begin block 4 */
		// Start line: 1225
	/* end block 4 */
	// End Line: 1226

	return 0;
}




