#include "CORE.H"
#include "VOICEXA.H"
#include "GAMELOOP.H"

struct XAVoiceTracker voiceTracker; // offset 0x800D5AD4

void VOICEXA_Init()
{
	int i;
	CdlFILE fp;
	struct XAVoiceTracker* vt;
	char fileName[32];

	vt = &voiceTracker;

	if ((gameTrackerX.debugFlags & 0x80000))
	{
		for (i = 0; i < 30; i++, vt++)
		{
			vt->voiceStatus = 0;
			vt->cdStatus = 0;
			vt->reqIn = 0;
			vt->reqOut = 0;
			vt->reqsQueued = 0;
			vt->cdCmdIn = 0;
			vt->cdCmdOut = 0;
			vt->cdCmdsQueued = 0;
			vt->voiceCmdIn = 0;
			vt->voiceCmdOut = 0;
			vt->voiceCmdsQueued = 0;

			sprintf(&fileName[0], "\VOICE\VOICE%02d.XA;", i);
			
			if (CdSearchFile(&fp, &fileName[0]) == 0)
			{
				vt->xaFileInfo->startPos = 0;
			}
			else
			{
				//loc_800B6B74
				vt->xaFileInfo->startPos = CdPosToInt(&fp.pos);
			}
		}
	}
}


// autogenerated function stub: 
// void /*$ra*/ putCdCommand(struct XAVoiceTracker *vt /*$a0*/, unsigned char cdCommand /*$a1*/, int numParams /*$a2*/, unsigned char *params /*$a3*/)
void putCdCommand(struct XAVoiceTracker *vt, unsigned char cdCommand, int numParams, unsigned char *params)
{ // line 98, offset 0x800b6ee0
	/* begin block 1 */
		// Start line: 99
		// Start offset: 0x800B6EE0
		// Variables:
			int i; // $t0
	/* end block 1 */
	// End offset: 0x800B6F5C
	// End Line: 112

	/* begin block 2 */
		// Start line: 225
	/* end block 2 */
	// End Line: 226

	/* begin block 3 */
		// Start line: 228
	/* end block 3 */
	// End Line: 229

}


// autogenerated function stub: 
// void /*$ra*/ VOICEXA_CdSyncCallback(unsigned char status /*$a0*/, unsigned char *result /*$a1*/)
void VOICEXA_CdSyncCallback(unsigned char status, unsigned char *result)
{ // line 115, offset 0x800b6f64
	/* begin block 1 */
		// Start line: 116
		// Start offset: 0x800B6F64
		// Variables:
			struct XAVoiceTracker *vt; // $a1
	/* end block 1 */
	// End offset: 0x800B6FC0
	// End Line: 137

	/* begin block 2 */
		// Start line: 263
	/* end block 2 */
	// End Line: 264

}


// autogenerated function stub: 
// void /*$ra*/ processCdCommands(struct XAVoiceTracker *vt /*$s1*/)
void processCdCommands(struct XAVoiceTracker *vt)
{ // line 141, offset 0x800b6fd0
	/* begin block 1 */
		// Start line: 142
		// Start offset: 0x800B6FD0
		// Variables:
			struct CdCommand *cmd; // $s0
	/* end block 1 */
	// End offset: 0x800B7064
	// End Line: 163

	/* begin block 2 */
		// Start line: 319
	/* end block 2 */
	// End Line: 320

}

void putVoiceCommand(struct XAVoiceTracker *vt, unsigned char voiceCmd, unsigned char nextVoiceStatus, int voiceCmdParam)
{ 
	vt->voiceCmdQueue[vt->voiceCmdIn].voiceCmd = voiceCmd;
	vt->voiceCmdQueue[vt->voiceCmdIn].nextVoiceStatus = nextVoiceStatus;
	vt->voiceCmdQueue[vt->voiceCmdIn].voiceCmdParam = voiceCmdParam;

	if (vt->voiceCmdsQueued < 15)
	{
		vt->voiceCmdsQueued++;
		vt->voiceCmdIn++;

		if (vt->voiceCmdIn >= 16)
		{
			vt->voiceCmdIn = 0;
		}
	}
}


// autogenerated function stub: 
// void /*$ra*/ processVoiceCommands(struct XAVoiceTracker *vt /*$s1*/)
void processVoiceCommands(struct XAVoiceTracker *vt)
{ // line 203, offset 0x800b70f4
	/* begin block 1 */
		// Start line: 204
		// Start offset: 0x800B70F4
		// Variables:
			struct VoiceCommand *cmd; // $s0
	/* end block 1 */
	// End offset: 0x800B7190
	// End Line: 221

	/* begin block 2 */
		// Start line: 449
	/* end block 2 */
	// End Line: 450

}


// autogenerated function stub: 
// void /*$ra*/ voiceCmdPlay(struct XAVoiceTracker *vt /*$s2*/, short voiceIndex /*$s3*/)
void voiceCmdPlay(struct XAVoiceTracker *vt, short voiceIndex)
{ // line 226, offset 0x800b71a4
	/* begin block 1 */
		// Start line: 227
		// Start offset: 0x800B71A4
		// Variables:
			//struct CdlFILTER filter; // stack offset -88
			//struct CdlLOC pos; // stack offset -80
			//unsigned char mode; // stack offset -32
			//struct SpuCommonAttr spuattr; // stack offset -72
			//struct XAVoiceListEntry *voice; // $s1
			//struct XAFileInfo *file; // $s0
	/* end block 1 */
	// End offset: 0x800B72F8
	// End Line: 299

	/* begin block 2 */
		// Start line: 499
	/* end block 2 */
	// End Line: 500

	/* begin block 3 */
		// Start line: 509
	/* end block 3 */
	// End Line: 510

}


// autogenerated function stub: 
// void /*$ra*/ voiceCmdStop(struct XAVoiceTracker *vt /*$a0*/, short cmdParam /*$a1*/)
void voiceCmdStop(struct XAVoiceTracker *vt, short cmdParam)
{ // line 302, offset 0x800b7314
	/* begin block 1 */
		// Start line: 303
		// Start offset: 0x800B7314
		// Variables:
			//struct SpuCommonAttr spuattr; // stack offset -48
	/* end block 1 */
	// End offset: 0x800B7360
	// End Line: 318

	/* begin block 2 */
		// Start line: 713
	/* end block 2 */
	// End Line: 714

}


// autogenerated function stub: 
// void /*$ra*/ voiceCmdPause(struct XAVoiceTracker *vt /*$a0*/, short cmdParam /*$a1*/)
void voiceCmdPause(struct XAVoiceTracker *vt, short cmdParam)
{ // line 321, offset 0x800b7370
	/* begin block 1 */
		// Start line: 754
	/* end block 1 */
	// End Line: 755

}


// autogenerated function stub: 
// void /*$ra*/ voiceCmdResume(struct XAVoiceTracker *vt /*$a0*/, short cmdParam /*$a1*/)
void voiceCmdResume(struct XAVoiceTracker *vt, short cmdParam)
{ // line 329, offset 0x800b73ac
	/* begin block 1 */
		// Start line: 770
	/* end block 1 */
	// End Line: 771

}


// autogenerated function stub: 
// void /*$ra*/ voiceCmdNull(struct XAVoiceTracker *vt /*$a0*/, short cmdParam /*$a1*/)
void voiceCmdNull(struct XAVoiceTracker *vt, short cmdParam)
{ // line 336, offset 0x800b73e0
	/* begin block 1 */
		// Start line: 784
	/* end block 1 */
	// End Line: 785

	/* begin block 2 */
		// Start line: 785
	/* end block 2 */
	// End Line: 786

}


// autogenerated function stub: 
// void /*$ra*/ VOICEXA_Play(int voiceIndex /*$a3*/, int queueRequests /*$a1*/)
void VOICEXA_Play(int voiceIndex, int queueRequests)
{ // line 341, offset 0x800b73e8
	/* begin block 1 */
		// Start line: 342
		// Start offset: 0x800B73E8
		// Variables:
			struct XAVoiceTracker *vt; // $a0
			struct XAFileInfo *file; // $a2
	/* end block 1 */
	// End offset: 0x800B749C
	// End Line: 368

	/* begin block 2 */
		// Start line: 794
	/* end block 2 */
	// End Line: 795

}


// autogenerated function stub: 
// int /*$ra*/ VOICEXA_FinalStatus(struct XAVoiceTracker *vt /*$a0*/)
int VOICEXA_FinalStatus(struct XAVoiceTracker* vt)
{ // line 387, offset 0x800b74ac
	/* begin block 1 */
		// Start line: 389
		// Start offset: 0x800B74AC
		// Variables:
	int tailIndex; // $v0
/* end block 1 */
// End offset: 0x800B74E8
// End Line: 404

/* begin block 2 */
	// Start line: 774
/* end block 2 */
// End Line: 775

/* begin block 3 */
	// Start line: 872
/* end block 3 */
// End Line: 873

/* begin block 4 */
	// Start line: 875
/* end block 4 */
// End Line: 876

	return 0;
}


// autogenerated function stub: 
// void /*$ra*/ VOICEXA_Pause()
void VOICEXA_Pause()
{ // line 406, offset 0x800b74f0
	/* begin block 1 */
		// Start line: 407
		// Start offset: 0x800B74F0
		// Variables:
	struct XAVoiceTracker* vt; // $s0
	int finalStatus; // $a0
/* end block 1 */
// End offset: 0x800B7550
// End Line: 424

/* begin block 2 */
	// Start line: 909
/* end block 2 */
// End Line: 910

}


// autogenerated function stub: 
// void /*$ra*/ VOICEXA_Resume()
void VOICEXA_Resume()
{ // line 427, offset 0x800b7560
	/* begin block 1 */
		// Start line: 428
		// Start offset: 0x800B7560
		// Variables:
	struct XAVoiceTracker* vt; // $s0
	int finalStatus; // $a0
/* end block 1 */
// End offset: 0x800B75C0
// End Line: 445

/* begin block 2 */
	// Start line: 952
/* end block 2 */
// End Line: 953

}

void VOICEXA_Tick()
{
	struct XAVoiceTracker* vt;
	vt = &voiceTracker;

	if ((gameTrackerX.debugFlags & 0x80000))
	{
		processVoiceCommands(vt);
		processCdCommands(vt);

		if (vt->cdCmdsQueued == 0 && vt->voiceCmdsQueued == 0)
		{
			if (vt->voiceStatus >= 3 && vt->voiceStatus != 0)
			{
				CdControlB(CdlGetlocL, NULL, &voiceTracker.cdResult[0]);

				if ((vt->cdResult[3] & 0x2))
				{
					vt->voiceStatus = 2;
					vt->currentPos.track = 0;

					voiceTracker.currentPos.minute = vt->cdResult[0];
					
					vt->currentPos.second = vt->cdResult[1];
					vt->currentPos.sector = vt->cdResult[2];
					vt->currentSector = CdPosToInt(&vt->currentPos) - 150;

					if (vt->currentSector >= vt->endSector - 8)
					{
						putVoiceCommand(vt, 1, 0, 0);
					}
				}
			}
			else if (vt->voiceStatus == 0 && vt->reqsQueued != 0)
			{
				putVoiceCommand(vt, 0, 1, vt->requestQueue[vt->reqOut]);
				
				vt->reqOut++;
				vt->reqsQueued--;

				if (vt->reqOut == 4)
				{
					vt->reqOut = 0;
				}
			}
		}
	}
}

int VOICEXA_IsPlaying()
{ 
	struct XAVoiceTracker *vt = &voiceTracker;

	if (vt->voiceStatus == 2)
	{
		return 2;
	}

	if (vt->voiceStatus == 1)
	{
		return 1;
	}

	if (vt->cdStatus != 0)
	{
		return 1;
	}

	return 0;
}


// autogenerated function stub: 
// int /*$ra*/ VOICEXA_IsPlayingOrPaused()
int VOICEXA_IsPlayingOrPaused()
{ // line 559, offset 0x800b7768
	/* begin block 1 */
		// Start line: 561
		// Start offset: 0x800B7768
	/* end block 1 */
	// End offset: 0x800B7768
	// End Line: 564

	/* begin block 2 */
		// Start line: 1221
	/* end block 2 */
	// End Line: 1222

	/* begin block 3 */
		// Start line: 1222
	/* end block 3 */
	// End Line: 1223

	/* begin block 4 */
		// Start line: 1225
	/* end block 4 */
	// End Line: 1226

	return 0;
}




