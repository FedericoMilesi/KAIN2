#include <stddef.h>
#include "../CORE.H"
#include "MAIN.H"
#include "../G2/MAING2.H"
#include "../MEMPACK.H"
#include "../LOAD3D.H"
#include "../STRMLOAD.H"
#include "../LOCAL/LOCALSTR.H"
#include "../GAMELOOP.H"
#include "../SOUND.H"
#include "../VOICEXA.H"
#include "AADSFX.H"
#include "../STREAM.H"
#include "AADLIB.H"
#include "../SAVEINFO.H"
#include "../FONT.H"
#include "../GAMEPAD.H"
#include "../VRAM.H"
#include "../CINEMA/CINEPSX.H"
#include "DRAWS.H"
#include "TIMER.H"

#if defined(PSXPC_VERSION)
#include <EMULATOR_PRIVATE.H>
#endif

char mainOptionsInit; // offset 0x800CE560
struct MainTracker mainTrackerX; // offset 0x800D121C
long gTimerEnabled; // offset 0x800CE8D4
unsigned long __timerEvent; // offset 0x800D0F84
int nosound; // offset 0x800CE568
int nomusic; // offset 0x800CE56C
int devstation; // offset 0x800D0E68
struct BLK_FILL clearRect[2]; // offset 0x800D0F88
DRAWENV draw[2]; // offset 0x800D0E6C
DISPENV disp[2]; // offset 0x800D0E40
struct InterfaceItem InterfaceItems[6] = { "\PUBLOGO.STR;1", 0, 0, 0, 1, 
										   "\CRYLOGO.STR;1", 0, 0, 0, 5, 
										   "\KAININT.STR;1", 0, 0, 0, -1,
										   "\VERSE.STR;1", 0, 0, 0, 4, 
										   "\CREDITS.STR;1", 0, 0, 0, -1,
										   "\\kain2\\game\\psx\\mainmenu\\legal.tim", 165, 165, 1, -1, };

void ClearDisplay()
{
#ifdef PSX_VERSION
	PutDrawEnv(&draw[gameTrackerX.gameData.asmData.dispPage]);
	clearRect[gameTrackerX.gameData.asmData.dispPage].r0 = 0;
	clearRect[gameTrackerX.gameData.asmData.dispPage].g0 = 0;
	clearRect[gameTrackerX.gameData.asmData.dispPage].b0 = 0;
	DrawPrim(&clearRect);
	DrawSync(0);
	PutDispEnv(&disp[gameTrackerX.gameData.asmData.dispPage]);
	SetDispMask(1);
#else
	PutDrawEnv(&draw[gameTrackerX.gameData.asmData.dispPage]);
	DrawPrim(&clearRect[gameTrackerX.gameData.asmData.dispPage]);
	DrawSync(0);
	PutDispEnv(&disp[gameTrackerX.gameData.asmData.dispPage]);
	SetDispMask(1);
#endif
}

void screen_to_vram(long *screen, int buffer)
{
	LOAD_LoadTIM2(screen, 0, buffer << 8, SCREEN_WIDTH, SCREEN_HEIGHT + 16);
}

void show_screen(char *name)
{
	long *screen;

	screen = LOAD_ReadFile(name, 11);
	
	if (screen != NULL)
	{
		screen_to_vram(screen, gameTrackerX.gameData.asmData.dispPage);
		MEMPACK_Free((char*)screen);
	}
}

void play_movie(char *name)
{
	if (CINE_Load() != 0)
	{
		CINE_Play(name, 0xFFFFu, 2);
		ClearDisplay();
		CINE_Unload();
	}
}

void InitMainTracker(struct MainTracker *mainTracker)
{
	mainTracker->mainState = 0;
	mainTracker->previousState = 0;
	mainTracker->done = 0;
}


// autogenerated function stub: 
// char * /*$ra*/ FindTextInLine(char *search_match /*$a0*/, char *search_str /*$a1*/)
char * FindTextInLine(char *search_match, char *search_str)
{ // line 243, offset 0x80038080
	/* begin block 1 */
		// Start line: 245
		// Start offset: 0x80038080
		// Variables:
			char *match_pos; // $a2
	/* end block 1 */
	// End offset: 0x800380F8
	// End Line: 259

	/* begin block 2 */
		// Start line: 493
	/* end block 2 */
	// End Line: 494

	/* begin block 3 */
		// Start line: 494
	/* end block 3 */
	// End Line: 495

	/* begin block 4 */
		// Start line: 496
	/* end block 4 */
	// End Line: 497

	return null;
}


// autogenerated function stub: 
// void /*$ra*/ ExtractWorldName(char *worldName /*$a0*/, char *levelName /*$a1*/)
void ExtractWorldName(char *worldName, char *levelName)
{ // line 261, offset 0x80038108
	/* begin block 1 */
		// Start line: 529
	/* end block 1 */
	// End Line: 530

	/* begin block 2 */
		// Start line: 530
	/* end block 2 */
	// End Line: 531

}


// autogenerated function stub: 
// void /*$ra*/ ExtractLevelNum(char *levelNum /*$a0*/, char *levelName /*$a1*/)
void ExtractLevelNum(char *levelNum, char *levelName)
{ // line 270, offset 0x80038154
	/* begin block 1 */
		// Start line: 547
	/* end block 1 */
	// End Line: 548

	/* begin block 2 */
		// Start line: 548
	/* end block 2 */
	// End Line: 549

}


// autogenerated function stub: 
// void /*$ra*/ ProcessArgs(char *baseAreaName /*$s3*/, struct GameTracker *gameTracker /*$s2*/)
void ProcessArgs(char *baseAreaName, struct GameTracker *gameTracker)
{ // line 368, offset 0x800381c0
	/* begin block 1 */
		// Start line: 369
		// Start offset: 0x800381C0
		// Variables:
			char levelNum[32]; // stack offset -88
			char worldName[32]; // stack offset -56
			long *argData; // $s1
	/* end block 1 */
	// End offset: 0x800383BC
	// End Line: 586

	/* begin block 2 */
		// Start line: 736
	/* end block 2 */
	// End Line: 737

}

void InitDisplay()
{
#ifdef PSX_VERSION && 0


#else
	TILE* t; // eax
	u_long tag; // edx
	int dispPage; // eax
	PSX_RECT rect; // [esp+Ch] [ebp-8h] BYREF

	rect.x = 512;
	rect.y = 0;
	rect.w = 512;
	rect.h = 512;
	ResetGraph(3);
	SetGraphDebug(0);
	SetDefDrawEnv(draw, 0, 0, 512, 240);
	SetDefDispEnv(disp, 0, 0, 512, 240);
	SetDefDrawEnv(&draw[1], 0, 0, 512, 240);
	SetDefDispEnv(&disp[1], 0, 0, 512, 240);
	draw[1].dtd = 1;
	draw[0].dtd = 1;
	draw[1].dfe = 1;
	draw[0].dfe = 1;
	draw[1].isbg = 0;
	draw[0].isbg = 0;
	draw[0].r0 = 0;
	draw[0].g0 = 0;
	draw[0].b0 = 0;
	draw[1].r0 = 0;
	draw[1].g0 = 0;
	draw[1].b0 = 0;
	t = (TILE*)clearRect;
	int i = 0;
	do
	{
		tag = t->tag;
		t->tag = tag & 0xFFFFFF | 0x3000000;
		t->code = 2;
		t->x0 = 0;
		t->y0 = 0;
		t->w = 512;
		t->h = 240;
		t->r0 = 0;
		t->g0 = 0;
		t->b0 = 0;
		++t;
	} while (i < 2);
	dispPage = gameTrackerX.gameData.asmData.dispPage;
	clearRect[dispPage].r0 = 0;
	clearRect[dispPage].g0 = 0;
	clearRect[dispPage].b0 = 0;
	ClearDisplay();
	GXFilePrint("ClearDisplay()\n");
	ClearOTagR((u_long*)gameTrackerX.drawOT, 3072);
	ClearOTagR((u_long*)gameTrackerX.dispOT, 3072);
	ClearImage(&rect, 0, 0xFFu, 0);
#endif
}

void StartTimer()
{
#ifdef PSX_VERSION
	EnterCriticalSection();
	__timerEvent = OpenEvent(0xF2000000, 2, 0x1000, NULL/*TimerTick*/);//TimerTick is commented out for now as the original PSX version uses ASM for this but still needs translating to C with propper compatible function declaration.
	EnableEvent(__timerEvent);
	SetRCnt(0xF2000000, 0xFFFF, 0x1001);
	StartRCnt(0xF2000000);
	ExitCriticalSection();
	gTimerEnabled = 1;
#endif
}


// autogenerated function stub: 
// void /*$ra*/ VblTick()
void VblTick()
{ // line 739, offset 0x800385c0
	/* begin block 1 */
		// Start line: 1473
	/* end block 1 */
	// End Line: 1474

	/* begin block 2 */
		// Start line: 1476
	/* end block 2 */
	// End Line: 1477

}


// autogenerated function stub: 
// void /*$ra*/ DrawCallback()
void DrawCallback()
{ 
	if (gameTrackerX.drawTimerReturn != NULL)
	{
		gameTrackerX.drawTimerReturn[0] = TIMER_TimeDiff(gameTrackerX.usecsStartDraw);
		///@TODO remainder
	}

}


// autogenerated function stub: 
// void /*$ra*/ FadeOutSayingLoading(struct GameTracker *gameTracker /*$s1*/)
void FadeOutSayingLoading(struct GameTracker *gameTracker)
{ // line 770, offset 0x80038684
	/* begin block 1 */
		// Start line: 771
		// Start offset: 0x80038684
		// Variables:
			struct POLY_F4_SEMITRANS *transPrim; // $s2
			unsigned long **drawot; // $s3
			long fadeTime; // $s0
	/* end block 1 */
	// End offset: 0x800387B4
	// End Line: 804

	/* begin block 2 */
		// Start line: 1544
	/* end block 2 */
	// End Line: 1545

}

void CheckForDevStation()
{
#if !defined(PSXPC_VERSION)
	long* a1 = (long*)0x80180000;
	long* a2 = (long*)0x80380000;

	a1[0] = 0x12340000;
	a2[0] = 0x12345678;

	if (a1[0] == a2[0])
	{
		devstation = 0;
	}
	else
	{
		devstation = 1;
	}
#endif
}

void MAIN_ShowLoadingScreen()
{ 
	long *loadingScreen; // $s0
	char langChar[5]; // stack offset -88
	int lang; // $v0
	char filename[64]; // stack offset -80

	//t1 = FGIS
#if 0///@FIXME why lwl/swl here?
	ulw     $v1, (aFgis - 0x800D0BFC)($t1)  # "FGIS"
	lb      $a3, (aFgis + 4 - 0x800D0BFC)($t1)  # ""
	usw     $v1, 0x58 + var_48($sp)
	sb      $a3, 0x58 + var_44($sp)
#endif

	VSync(0);

	if (localstr_get_language() != language_english)
	{
#if 0
		addiu   $s1, $sp, 0x58 + var_48
		addiu   $s0, $sp, 0x58 + var_40
		move    $a0, $s0
		lui     $a1, 0x800D
		addu    $v0, $s1
		lbu     $a2, -1($v0)
		jal     sub_80074468
		li      $a1, aKain2GamePsxLo  # "\\kain2\\game\\psx\\loading%c.tim"
		j       loc_80038EA8
		move    $a0, $s0
		sprintf
#endif

	}

#if 0

		
		

		loc_80038EA0 :
	li      $a0, aKain2GamePsxLo_0  # "\\kain2\\game\\psx\\loading.tim"

		loc_80038EA8 :
		jal     sub_800608F8
		li      $a1, 0xB
		move    $s0, $v0
		beqz    $s0, loc_80038ED0
		nop
		lw      $a1, -0x4234($gp)
		jal     sub_800385B4
		move    $a0, $s0
		jal     sub_80050498
		move    $a0, $s0

		loc_80038ED0 :
	lw      $ra, 0x58 + var_s8($sp)
		lw      $s1, 0x58 + var_s4($sp)
		lw      $s0, 0x58 + var_s0($sp)
		jr      $ra
		addiu   $sp, 0x68
		# End of function sub_80038E34
#endif
}


// autogenerated function stub: 
// long * /*$ra*/ MAIN_LoadTim(char *name /*$a0*/)
long * MAIN_LoadTim(char *name)
{ // line 879, offset 0x800388e4
	/* begin block 1 */
		// Start line: 880
		// Start offset: 0x800388E4
	/* end block 1 */
	// End offset: 0x800388E4
	// End Line: 880

	/* begin block 2 */
		// Start line: 1804
	/* end block 2 */
	// End Line: 1805

	return null;
}


// autogenerated function stub: 
// void /*$ra*/ init_menus(struct GameTracker *gt /*$s1*/)
void init_menus(struct GameTracker *gt)
{ // line 890, offset 0x80038904
	/* begin block 1 */
		// Start line: 891
		// Start offset: 0x80038904
		// Variables:
			struct menu_t *menu; // $s0
	/* end block 1 */
	// End offset: 0x80038904
	// End Line: 891

	/* begin block 2 */
		// Start line: 1826
	/* end block 2 */
	// End Line: 1827

}

void MAIN_DoMainInit()
{
	InitDisplay();

	InitGeom();
	SetGeomOffset(SCREEN_WIDTH / 2, SCREEN_HEIGHT / 2);
	SetGeomScreen(320);

	VRAM_InitVramBlockCache();
	FONT_Init();

	gameTrackerX.reqDisp = NULL;

	VSyncCallback(VblTick);
	DrawSyncCallback(DrawCallback);

	GAMEPAD_Init();
	SOUND_Init();
	VOICEXA_Init();

	if (nosound != 0)
	{
		SOUND_SfxOff();

		gameTrackerX.sound.gSfxOn = 0;
		gameTrackerX.sound.gVoiceOn = 0;
	}

	if (nomusic != 0)
	{
		SOUND_MusicOff();

		gameTrackerX.sound.gMusicOn = 0;
	}

	if (!(gameTrackerX.debugFlags & 0x80000))
	{
		gameTrackerX.sound.gVoiceOn = 0;
	}

#if defined(PSX_VERSION)
	init_menus(&gameTrackerX);
	SAVE_Init(&gameTrackerX);
#else
	int v0 = menu_data_size();
	struct menu_t *v1 = MEMPACK_Malloc(v0, 0x2Du);
	menu_initialize(v1, &gameTrackerX);
	gameTrackerX.menu = v1;
#endif

	srand(0);
}

void MAIN_InitVolume()
{
	aadInitVolume();
	aadStartMasterVolumeFade(gameTrackerX.sound.gMasterVol, 256, NULL);
	gameTrackerX.sound.soundsLoaded = 1;
	aadSetNoUpdateMode(0);
}


// autogenerated function stub: 
// void /*$ra*/ MAIN_ResetGame()
void MAIN_ResetGame()
{ // line 957, offset 0x80038a84
	/* begin block 1 */
		// Start line: 1944
	/* end block 1 */
	// End Line: 1945

}


// autogenerated function stub: 
// void /*$ra*/ MAIN_MainMenuInit()
void MAIN_MainMenuInit()
{ // line 967, offset 0x80038ad4
	/* begin block 1 */
		// Start line: 968
		// Start offset: 0x80038AD4

		/* begin block 1.1 */
			// Start line: 968
			// Start offset: 0x80038AD4
			// Variables:
				char sfxFileName[64]; // stack offset -72
		/* end block 1.1 */
		// End offset: 0x80038C18
		// End Line: 990
	/* end block 1 */
	// End offset: 0x80038C18
	// End Line: 995

	/* begin block 2 */
		// Start line: 1965
	/* end block 2 */
	// End Line: 1966

}


// autogenerated function stub: 
// void /*$ra*/ MAIN_FreeMainMenuStuff()
void MAIN_FreeMainMenuStuff()
{ // line 1009, offset 0x80038c6c
	/* begin block 1 */
		// Start line: 2066
	/* end block 1 */
	// End Line: 2067

}


// autogenerated function stub: 
// void /*$ra*/ MAIN_StartGame()
void MAIN_StartGame()
{ // line 1044, offset 0x80038cdc
	/* begin block 1 */
		// Start line: 2136
	/* end block 1 */
	// End Line: 2137

	/* begin block 2 */
		// Start line: 2137
	/* end block 2 */
	// End Line: 2138

}


// autogenerated function stub: 
// long /*$ra*/ MAIN_DoMainMenu(struct GameTracker *gameTracker /*$s0*/, struct MainTracker *mainTracker /*$a1*/, long menuPos /*$a2*/)
long MAIN_DoMainMenu(struct GameTracker *gameTracker, struct MainTracker *mainTracker, long menuPos)
{ // line 1083, offset 0x80038d48
	/* begin block 1 */
		// Start line: 1084
		// Start offset: 0x80038D48
		// Variables:
			unsigned long **drawot; // $s1
	/* end block 1 */
	// End offset: 0x80038E04
	// End Line: 1172

	/* begin block 2 */
		// Start line: 2220
	/* end block 2 */
	// End Line: 2221

	return 0;
}

int MainG2(void *appData)
{ 
	struct MainTracker* mainTracker; // $s2
	struct GameTracker* gameTracker; // $s3
	long menuPos; // $s5
	struct InterfaceItem* item; // $s1
	int timer; // $s0

#if defined(PSXPC_VERSION)
	Emulator_Initialise("Legacy of Kain: Soul Reaver", SCREEN_WIDTH, SCREEN_HEIGHT);
#endif

	//s7 = appData
	menuPos = 0;
	CheckForDevStation();
	//a0 = appData
	//a1 = 0x200//SW?
	//a2 = 0xF0 //SH?
	mainTracker = &mainTrackerX;
	gameTracker = &gameTrackerX;
	mainOptionsInit = 0;

	if (MainG2_InitEngine(appData, SCREEN_WIDTH, SCREEN_HEIGHT, NULL) == 1)
	{
		//s6 = 2
		MEMPACK_Init();
		LOAD_InitCd();
		StartTimer();
		STREAM_InitLoader("\\BIGFILE.DAT;1", "");
		localstr_set_language(language_default);
		GAMELOOP_SystemInit(gameTracker);

		gameTracker->lastLvl = 255;
		gameTracker->currentLvl = 255;
		gameTracker->disp = &disp;

		ProcessArgs(&gameTracker->baseAreaName[0], gameTracker);
		InitMainTracker(mainTracker);
		MAIN_DoMainInit();
		//s4 = &InterfaceItems[0];
		mainTracker->mainState = 6;
		mainTracker->movieNum = 0;

		//loc_800394D4
		while (mainTracker->done == 0)
		{
			switch (mainTrackerX.mainState)
			{
			case 1:
				SOUND_UpdateSound();

				if ((gameTracker->debugFlags & 0x80000))
				{
					VOICEXA_Tick();
				}

				PSX_GameLoop(gameTracker);

				if (gameTracker->levelDone != 0)
				{
					FadeOutSayingLoading(gameTracker);
					aadStopAllSfx();
					STREAM_DumpAllLevels(0, 0);
					RemoveAllObjects(gameTracker);

					while (aadGetNumLoadsQueued() != 0 || aadMem->updateCounter != 0)
					{
						SOUND_UpdateSound();
						STREAM_PollLoadQueue();
					}

					SOUND_ShutdownMusic();
					MEMPACK_FreeByType(14);
					MEMPACK_DoGarbageCollection();

					if (gameTracker->levelDone == 2)
					{
						mainTracker->mainState = 8;
					}
					else if (gameTracker->levelDone == 3)
					{
						mainTracker->mainState = 6;
						mainTracker->movieNum = 4;

					}
					else if (gameTracker->levelDone == 4)
					{
						mainTracker->mainState = 2;

						if (!(gameTracker->streamFlags & 0x200000))
						{
							SAVE_ClearMemory(&gameTrackerX);
						}
					}
					else
					{
						mainTracker->mainState = 2;
					}
				}
				//def_80039508
				break;
			case 2:
				if ((gameTrackerX.streamFlags & 0x1000000))
				{
					play_movie(&InterfaceItems[2].name[0]);
					gameTrackerX.streamFlags &= 0x1000000;
				}

				if ((gameTrackerX.streamFlags & 0x200000))
				{
					gameTrackerX.streamFlags &= 0x200000;
				}

				if (nosound == 0)
				{
					MAIN_InitVolume();
				}

				MAIN_ShowLoadingScreen();
				FONT_ReloadFont();
				DrawSync(0);
				STREAM_Init();
				gameTracker->frameCount = 0;
				GAMELOOP_LevelLoadAndInit(&gameTracker->baseAreaName[0], gameTracker);
				gameTracker->levelDone = 0;
				mainTracker->mainState = 1;

				do
				{

				} while (STREAM_PollLoadQueue() != 0);

				gameTrackerX.vblFrames = 0;

				break;
			case 4:
				//loc_800395F8
				LOAD_ChangeDirectory("Menustuff");
				//a0 = 
				while (mainTracker->movieNum < 6)
				{
					do
					{
						item = &InterfaceItems[mainTracker->movieNum];
						gameTrackerX.gameFlags &= 0x1;
						show_screen(&item->name[0]);

						timer = 1;
						if (item->timeout != 0)
						{
							do
							{
								GAMEPAD_Process(gameTracker);

								if (item->buttonTimeout < timer && (gameTracker->controlCommand[0][1] & 0x80))
								{
									break;
								}

								VSync(0);
								timer++;
							} while (timer < item->timeout);
						}

					} while (item->nextItem < 0);
					//loc_80039698
				}
				//loc_800396D0
				//loc_800396D0

				//TODO the rest, it's mangled as hell and we can only use labels to fix this...

				break;
			case 6:
				CINE_Load();
				if (mainTracker->movieNum >= 0)
				{
					do
					{
						if (CINE_Loaded() != 0)
						{
							CINE_Play(InterfaceItems[mainTracker->movieNum].name, 0xFFFFu, 2);
							ClearDisplay();
						}

						mainTracker->movieNum = InterfaceItems[mainTracker->movieNum].nextItem;

						if (InterfaceItems[mainTracker->movieNum].itemType != 0)
						{
							mainTracker->mainState = 4;
							break;
						}
					} while (mainTracker->movieNum >= 0);
				}

				CINE_Unload();

				if (mainTracker->movieNum < 0)
				{
					mainTracker->mainState = 8;
				}

				if (nosound == 0)
				{
					SOUND_StopAllSound();
				}

				break;
			case 3:
			case 5:
			default:
				//def_80039508
				break;
			}

			//def_80039508
			STREAM_PollLoadQueue();
		}

		SOUND_StopAllSound();
		SOUND_Free();
		SetDispMask(0);
		DrawSync(0);
		VSync(0);
		DrawSyncCallback(NULL);
		VSyncCallback(NULL);
		EnterCriticalSection();
		StopRCnt(0xF2000000);
		DisableEvent(__timerEvent);
		CloseEvent(__timerEvent);
		ExitCriticalSection();
		VSync(5);
		StopCallback();
		ResetGraph(0);


	}
	//loc_80039A20

	MainG2_ShutDownEngine(appData);

#if defined(PSXPC_VERSION)
	Emulator_ShutDown();
#endif

	//loc_80039A20
	return 0;
}